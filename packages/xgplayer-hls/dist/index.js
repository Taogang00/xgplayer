!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("xgplayer")):"function"==typeof define&&define.amd?define(["xgplayer"],t):"object"==typeof exports?exports["xgplayer-hls"]=t(require("xgplayer")):e["xgplayer-hls"]=t(e.xgplayer)}(window,(function(e){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(t,i){t.exports=e},function(e,t,i){e.exports=i(2)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HlsPlayer=void 0;var r=i(3),n=i(4);var a=t.HlsPlayer=function e(t){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t.isLive?new r.HlsLivePlayer(t):new n.HlsVodPlayer(t)};e.exports=a},function(e,t,i){var r,n,a,s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(o,u){"object"==s(t)&&void 0!==e?e.exports=u(i(0)):(n=[i(0)],void 0===(a="function"==typeof(r=u)?r.apply(t,n):r)||(e.exports=a))}(0,(function(e){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Y(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Y(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(){}function l(){l.init.call(this)}function d(e){return void 0===e._maxListeners?l.defaultMaxListeners:e._maxListeners}function h(e,t,i){if(t)e.call(i);else for(var r=e.length,n=g(e,r),a=0;a<r;++a)n[a].call(i)}function c(e,t,i,r){if(t)e.call(i,r);else for(var n=e.length,a=g(e,n),s=0;s<n;++s)a[s].call(i,r)}function f(e,t,i,r,n){if(t)e.call(i,r,n);else for(var a=e.length,s=g(e,a),o=0;o<a;++o)s[o].call(i,r,n)}function p(e,t,i,r,n,a){if(t)e.call(i,r,n,a);else for(var s=e.length,o=g(e,s),u=0;u<s;++u)o[u].call(i,r,n,a)}function y(e,t,i,r){if(t)e.apply(i,r);else for(var n=e.length,a=g(e,n),s=0;s<n;++s)a[s].apply(i,r)}function v(e,t,i,r){var n,a,s;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),a=e._events),s=a[t]):(a=e._events=new u,e._eventsCount=0),s){if("function"==typeof s?s=a[t]=r?[i,s]:[s,i]:r?s.unshift(i):s.push(i),!s.warned&&(n=d(e))&&n>0&&s.length>n){s.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=t,o.count=s.length,function(e){"function"==typeof console.warn?console.warn(e):console.log(e)}(o)}}else s=a[t]=i,++e._eventsCount;return e}function _(e,t,i){function r(){e.removeListener(t,r),n||(n=!0,i.apply(e,arguments))}var n=!1;return r.listener=i,r}function m(e){var t=this._events;if(t){var i=t[e];if("function"==typeof i)return 1;if(i)return i.length}return 0}function g(e,t){for(var i=new Array(t);t--;)i[t]=e[t];return i}function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function b(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function T(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function k(e,t){return e(t={exports:{}},t.exports),t.exports}function S(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;var A={fixedFloat:function(e,t){return Number.parseFloat(Number(e).toFixed(t))}},w=Object.freeze({__proto__:null,debounce:function(e,t){var i=Date.now(),r=null,n=!0;return function(){for(var a=arguments.length,s=Array(a),o=0;o<a;o++)s[o]=arguments[o];var u=Date.now();n&&(i=Date.now(),n=!1,e.apply(void 0,s)),u-i>t?(i=u,e.apply(void 0,s)):(r&&window.clearTimeout(r),r=setTimeout((function(){e.apply(void 0,s)}),t))}},caculate:A}),D={VISIBILITY_CHANGE:"VISIBILITY_CHANGE"},R={SEEK:"SEEK"},L={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_RESPONSE_HEADERS:"LOADER_RESPONSE_HEADERS",LOADER_ERROR:"LOADER_ERROR",LOADER_RETRY:"LOADER_RETRY"},O={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",SEI_PARSED:"SEI_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO"},U={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",DETECT_CHANGE_STREAM_DISCONTINUE:"DETECT_CHANGE_STREAM_DISCONTINUE",DETECT_AUDIO_GAP:"DETECT_AUDIO_GAP",DETECT_LARGE_GAP:"DETECT_LARGE_GAP",DETECT_AUDIO_OVERLAP:"DETECT_AUDIO_OVERLAP",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",DETECT_FRAG_ID_DISCONTINUE:"DETECT_FRAG_ID_DISCONTINUE"},B={SOURCE_UPDATE_END:"SOURCE_UPDATE_END",MSE_ERROR:"MSE_ERROR"},x={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},C=Object.assign({},L,O,U,B,x,R,D),M=[],P=[];for(var I in C)C.hasOwnProperty(I)&&M.push(C[I]);for(var G in C)C.hasOwnProperty(G)&&P.push(C[G]);var F={ALLEVENTS:C,HLS_EVENTS:x,REMUX_EVENTS:U,DEMUX_EVENTS:O,MSE_EVENTS:B,LOADER_EVENTS:L,FlvAllowedEvents:M,HlsAllowedEvents:P,CRYTO_EVENTS:{START_DECRYPT:"START_DECRYPT",DECRYPTED:"DECRYPTED"},PLAYER_EVENTS:R,BROWSER_EVENTS:D},N=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),j=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this._audoclear=t.autoclear||!1,this.downloadedUrls=[]}return N(e,[{key:"push",value:function(e,t,i,r){this._ts[e]||(this._ts[e]={duration:t,downloaded:!1,downloading:!1,start:this.duration,discontinue:!!i,id:r},this._list[this.duration]=e,this.duration+=t,this.fragLength+=1)}},{key:"deleteFrag",value:function(e){this._ts[e]&&(this._ts[e].start>this._lastget.time&&(this._lastget={duration:this._ts[e].duration,time:this._ts[e].start,downloaded:!1,downloading:!1,url:e,id:this._ts[e].id}),delete this._list[this._ts[e].start],delete this._ts[e],this.fragLength-=1)}},{key:"pushM3U8",value:function(e,t){if(!e)throw new Error("No m3u8 data received.");if(this.version=e.version,this.targetduration=e.targetduration,e.encrypt&&!this.encrypt&&(this.encrypt=e.encrypt),e.sequence||(e.sequence=0),!(e.sequence>this.sequence))throw new Error("Old m3u8 file received, "+e.sequence);this.sequence=e.sequence;for(var i=[],r=0;r<e.frags.length;r++){var n=e.frags[r];!this._ts[n.url]&&this.downloadedUrls.indexOf(n.url)<0&&(i.push(n.url),this.push(n.url,n.duration,n.discontinue,n.id))}if(i.length<1)throw new Error("Can not read ts file list.");if(t)for(var a=this.getTsList(),s=0;s<a.length;s++)i.indexOf(a[s])<0&&this.deleteFrag(a[s])}},{key:"getTsList",value:function(){return Object.keys(this._ts)}},{key:"downloaded",value:function(e,t){var i=this._ts[e];i&&(i.downloaded=t)}},{key:"downloading",value:function(e,t){var i=this._ts[e];i&&(i.downloading=t)}},{key:"getTsByName",value:function(e){return this._ts[e]}},{key:"getTs",value:function(e){var t=Object.keys(this._list),i=void 0;if(void 0===e&&(e=this._lastget?this._lastget.time+this._lastget.duration:0),!(t.length<1||e>=this.duration)){t=t.sort((function(e,t){return parseFloat(e)-parseFloat(t)}));for(var r=0;r<t.length&&e>=parseInt(t[r]);r++){var n=this._list[t[r]];i={url:n,downloaded:this._ts[n].downloaded,downloading:this._ts[n].downloading,time:parseInt(t[r]),duration:parseInt(this._ts[n].duration),id:this._ts[n].id},this.autoclear&&(delete this._ts[this._lastget.url],delete this._list[this._lastget.time]),this._lastget=i}return i&&this.downloadedUrls.push(i.url),i}}},{key:"getLastDownloadedTs",value:function(){for(var e=Object.keys(this._list).sort((function(e,t){return Number(e)-Number(t)})),t=void 0,i=0;i<e.length;i++){var r=this._list[e[i]],n=this._ts[r].downloaded,a=this._ts[r].downloading;if(!n)break;t={url:r,downloaded:n,downloading:a,time:parseInt(e[i]),duration:parseInt(this._ts[r].duration)}}return t}},{key:"clear",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0}},{key:"clearDownloaded",value:function(){for(var e=Object.keys(this._ts),t=0,i=e.length;t<i;t++){var r=this._ts[e[t]];r.downloaded=!1,r.downloading=!1}}},{key:"destroy",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this._audoclear=!1}},{key:"resetSequence",value:function(){this.sequence=-1}},{key:"list",get:function(){return this._list}},{key:"baseURL",set:function(e){this.baseURL!==e&&(this.clear(),this._baseURL=e)},get:function(){return this._baseURL}}]),e}(),V=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),H=function e(){t(this,e),this.mimetype="",this.init=null,this.data=[],this.bufferDuration=0},X=function(){function e(){t(this,e),this.sources={}}return V(e,[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new H,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.sources={}}}]),e}(),W=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),z=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}return W(e,[{key:"back",value:function(e){this.position-=e}},{key:"skip",value:function(t){for(var i=Math.floor(t/4),r=t%4,n=0;n<i;n++)e.readByte(this.dataview,4);r>0&&e.readByte(this.dataview,r)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,i){var r=void 0;switch(t){case 1:r=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:r=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");r=e.getUint8(e.position)<<16,r|=e.getUint8(e.position+1)<<8,r|=e.getUint8(e.position+2);break;case 4:r=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");r=e.getUint32(e.position)<<32,r|=e.getUint32(e.position+4);break;default:r=""}return e.position+=t,r}}]),e}(),Y="function"==typeof Symbol&&"symbol"==s(Symbol.iterator)?function(e){return void 0===e?"undefined":s(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":s(e)},q=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),K=function(){function e(){n(this,e),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}return q(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"distroy",value:function(){this.reset(),this.id=-1}}]),e}(),Z=function(e){function t(){n(this,t);var e=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="AudioTrack",e.type="audio",e}return r(t,e),t}(K),Q=function(e){function t(){n(this,t);var e=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="VideoTrack",e.type="video",e.dropped=0,e}return r(t,e),q(t,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),t}(K),$=(q((function e(){n(this,e),this.audioTrack=null,this.videoTrack=null}),[{key:"destroy",value:function(){this.audioTrack=null,this.videoTrack=null}}]),function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}()),J=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.length=t||0,this.historyLen=t||0,this.array=[],this.offset=0}return $(e,[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var i=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,i}for(var r=new Uint8Array(e),n=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+e);r.set(a,n),this.offset+=e,this.length-=e,e=0;break}var s=this.array[0].length-this.offset;r.set(this.array[0].slice(this.offset,this.array[0].length),n),this.array.shift(),this.offset=0,n+=s,this.length-=s,e-=s}return r}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var i=0,r=this.offset+e;r<this.offset+t+e;)r<this.array[0].length?i=256*i+this.array[0][r]:this.array[1]&&(i=256*i+this.array[1][r-this.array[0].length]),r++;return i}}]),e}(),ee=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),te=function(){function e(t){a(this,e);var i={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},i,t):i}return ee(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),ie=function(){function e(t){a(this,e);var i={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},i,t):i}return ee(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}(),re=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ne=function(){function e(t){o(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return re(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,data:new Uint8Array}}}]),e}(),ae=function(){function e(t){o(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return re(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,isKeyframe:!1,originDts:null,data:new Uint8Array}}}]),e}(),se=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),oe=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},ue=j,le=X,de=z,he=K,ce=J,fe=Z,pe=function(){function e(){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.mimeType=null,this.duration=null,this.hasVideo=null,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=null,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}return se(e,[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:function(e){return oe(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||oe(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||oe(e.video)}}]),e}(),ye=Q,ve=te,_e=ie,me=ne,ge=ae;u.prototype=Object.create(null),l.EventEmitter=l,l.usingDomains=!1,l.prototype.domain=void 0,l.prototype._events=void 0,l.prototype._maxListeners=void 0,l.defaultMaxListeners=10,l.init=function(){this.domain=null,l.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new u,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},l.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},l.prototype.getMaxListeners=function(){return d(this)},l.prototype.emit=function(e){var t,i,r,n,a,s,o,u="error"===e;if(s=this._events)u=u&&null==s.error;else if(!u)return!1;if(o=this.domain,u){if(t=arguments[1],!o){if(t instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=o,t.domainThrown=!1,o.emit("error",t),!1}if(!(i=s[e]))return!1;var d="function"==typeof i;switch(r=arguments.length){case 1:h(i,d,this);break;case 2:c(i,d,this,arguments[1]);break;case 3:f(i,d,this,arguments[1],arguments[2]);break;case 4:p(i,d,this,arguments[1],arguments[2],arguments[3]);break;default:for(n=new Array(r-1),a=1;a<r;a++)n[a-1]=arguments[a];y(i,d,this,n)}return!0},l.prototype.addListener=function(e,t){return v(this,e,t,!1)},l.prototype.on=l.prototype.addListener,l.prototype.prependListener=function(e,t){return v(this,e,t,!0)},l.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,_(this,e,t)),this},l.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,_(this,e,t)),this},l.prototype.removeListener=function(e,t){var i,r,n,a,s;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(i=r[e]))return this;if(i===t||i.listener&&i.listener===t)0==--this._eventsCount?this._events=new u:(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(n=-1,a=i.length;a-- >0;)if(i[a]===t||i[a].listener&&i[a].listener===t){s=i[a].listener,n=a;break}if(n<0)return this;if(1===i.length){if(i[0]=void 0,0==--this._eventsCount)return this._events=new u,this;delete r[e]}else!function(e,t){for(var i=t,r=i+1,n=e.length;r<n;i+=1,r+=1)e[i]=e[r];e.pop()}(i,n);r.removeListener&&this.emit("removeListener",e,s||t)}return this},l.prototype.removeAllListeners=function(e){var t,i;if(!(i=this._events))return this;if(!i.removeListener)return 0===arguments.length?(this._events=new u,this._eventsCount=0):i[e]&&(0==--this._eventsCount?this._events=new u:delete i[e]),this;if(0===arguments.length){for(var r,n=Object.keys(i),a=0;a<n.length;++a)"removeListener"!==(r=n[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new u,this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},l.prototype.listeners=function(e){var t,i=this._events;return i&&(t=i[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(t):[]},l.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},l.prototype.listenerCount=m,l.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var Ee="function"==typeof Symbol&&"symbol"==s(Symbol.iterator)?function(e){return void 0===e?"undefined":s(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":s(e)},be=function e(t,i,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,r)}if("value"in n)return n.value;var s=n.get;return void 0!==s?s.call(r):void 0},Te=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ke=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];E(this,e),this._emitter=new l,this._emitter.off||(this._emitter.off=this._emitter.removeListener),this.mediaInfo=new pe,this._instanceMap={},this._clsMap={},this._inited=!1,this.allowedEvents=t,this._hooks={}}return Te(e,[{key:"getInstance",value:function(e){return this._instanceMap[e]||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=i[0],a=i[1],s=i[2],o=i[3];if(this._clsMap[e]){var u=new this._clsMap[e](n,a,s,o);return this._instanceMap[e]=u,u.init&&u.init(),u}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var i=this,r=this._emitter,n=this._isMessageNameValid.bind(this),a=this,s=function(t){function i(t,r,n){E(this,i);var s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Ee(t))&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,r,n));return s.listeners={},s.onceListeners={},s.TAG=e,s._context=a,s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Ee(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,t),Te(i,[{key:"on",value:function(t,i){return n(t),this.listeners[t]?this.listeners[t].push(i):this.listeners[t]=[i],r.on(t+"__TO__"+e,i),r.on(t,i)}},{key:"before",value:function(e,t){n(e),a._hooks[e]?a._hooks[e].push(t):a._hooks[e]=[t]}},{key:"once",value:function(t,i){return n(t),this.onceListeners[t]?this.onceListeners[t].push(i):this.onceListeners[t]=[i],r.once(t+"__TO__"+e,i),r.once(t,i)}},{key:"emit",value:function(e){n(e);for(var t=a._hooks?a._hooks[e]:null,i=arguments.length,s=Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];if(t)for(var u=0,l=t.length;u<l;u++)t[u].apply(void 0,s);return r.emit.apply(r,[e].concat(s))}},{key:"emitTo",value:function(e,t){n(t);for(var i=arguments.length,a=Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];return r.emit.apply(r,[t+"__TO__"+e].concat(a))}},{key:"off",value:function(e,t){return n(e),r.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var i in this.listeners)if(t(i))for(var n=this.listeners[i]||[],a=0;a<n.length;a++){var s=n[a];r.off(i,s),r.off(i+"__TO__"+e,s)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var d=u[l];r.off(o,d),r.off(o+"__TO__"+e,d)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete a._instanceMap[e],be(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this))return be(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this)}}]),i}(t);return this._clsMap[e]=s,function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return i.initInstance.apply(i,[e].concat(r))}}},{key:"seek",value:function(e){this._emitter.emit(F.PLAYER_EVENTS.SEEK,e)}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach((function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()}))}},{key:"destroy",value:function(){this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._context=null,this._hooks=null,this.destroyInstances()}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}]),e}(),Se=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Ae=F.CRYTO_EVENTS,we=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.inputBuffer=t.inputbuffer,this.outputBuffer=t.outputbuffer,this.key=t.key,this.iv=t.iv,this.method=t.method,this.crypto=window.crypto||window.msCrypto}return Se(e,[{key:"init",value:function(){this.on(Ae.START_DECRYPT,this.decript.bind(this))}},{key:"decript",value:function(){var e=this;this.aeskey?this.decriptData():this.crypto.subtle.importKey("raw",this.key.buffer,{name:"AES-CBC"},!1,["encrypt","decrypt"]).then((function(t){e.aeskey=t,e.decriptData()}))}},{key:"decriptData",value:function(){var e=this,t=this._context.getInstance(this.inputBuffer),i=this._context.getInstance(this.outputBuffer),r=t.shift();r&&this.crypto.subtle.decrypt({name:"AES-CBC",iv:this.iv.buffer},this.aeskey,r).then((function(t){i.push(new Uint8Array(t)),e.emit(Ae.DECRYPTED),e.decriptData(r)}))}}]),e}(),De=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Re=F.MSE_EVENTS,Le=function(){function e(t,i){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),i&&(this._context=i,this.emit=i._emitter.emit.bind(i._emitter)),this.TAG="MSE",this.configs=Object.assign({},t),this.container=this.configs.container,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this),this.opened=!1}return De(e,[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this._url=null,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"resetContext",value:function(t){this._context=t,this.emit=t._emitter.emit.bind(t._emitter);for(var i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||e.clearBuffer(r)}}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.opened=!0,this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit(Re.SOURCE_UPDATE_END),this.doAppend()}},{key:"addSourceBuffers",value:function(){if(this.mediaSource&&"open"===this.mediaSource.readyState&&this.opened){var e=this._context.getInstance("PRE_SOURCE_BUFFER"),t=this._context.getInstance("TRACKS"),i=void 0;if(e&&t){e=e.sources;for(var r=!1,n=0,a=Object.keys(e).length;n<a;n++){var s=Object.keys(e)[n];r=!1,"audio"===s?i=t.audioTrack:"video"===s&&(i=t.videoTrack),i&&null!==e[s].init&&e[s].data.length&&(r=!0)}if(r){if(Object.keys(this.sourceBuffers).length>1)return;for(var o=0,u=Object.keys(e).length;o<u;o++){var l=Object.keys(e)[o];if(!this.sourceBuffers[l]){var d=e[l],h="video"===l?"video/mp4;codecs="+d.mimetype:"audio/mp4;codecs="+d.mimetype;try{var c=this.mediaSource.addSourceBuffer(h);this.sourceBuffers[l]=c,c.addEventListener("updateend",this.onUpdateEnd)}catch(e){this.emit(Re.MSE_ERROR,this.TAG,new Error(e.message))}}}Object.keys(this.sourceBuffers).length===this.sourceBufferLen&&this.doAppend()}}}}},{key:"doAppend",value:function(){this._doCleanupSourceBuffer();var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e)for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],r=this.sourceBuffers[i];if(!r.updating){var n=e.sources[i];if(this["no"+i])n.data=[],n.init.buffer=null;else if(n&&!n.inited)try{r.appendBuffer(n.init.buffer.buffer),n.inited=!0}catch(e){}else if(n){var a=n.data.shift();if(a)try{r.appendBuffer(a.buffer.buffer)}catch(e){n.data.unshift(a)}}}}}},{key:"endOfStream",value:function(){if("open"===this.mediaSource.readyState)try{this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||r.remove(t,e)}}},{key:"_doCleanupSourceBuffer",value:function(){for(var e=this.container.currentTime,t={video:[],audio:[]},i=0;i<Object.keys(this.sourceBuffers).length;i++){for(var r=Object.keys(this.sourceBuffers)[i],n=this.sourceBuffers[r],a=n.buffered,s=!1,o=0;o<a.length;o++){var u=a.start(o),l=a.end(o);if(u<=e&&e<l+3){if(e-u>=180){s=!0;var d=e-180;t[r].push({start:u,end:d})}}else l<e&&(s=!0,t[r].push({start:u,end:l}))}s&&!n.updating&&this._doRemoveRanges(t)}}},{key:"_doRemoveRanges",value:function(e){for(var t in e)if(this.sourceBuffers[t]&&!this.sourceBuffers[t].updating)for(var i=this.sourceBuffers[t],r=e[t];r.length&&!i.updating;){var n=r.shift();i.remove(n.start,n.end)}}},{key:"cleanBuffers",value:function(){for(var t=this,i=[],r=0;r<Object.keys(this.sourceBuffers).length;r++)!function(r){var n,a=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n=a.updating?new Promise((function(t){a.addEventListener("updateend",(function i(){var r=3;setTimeout((function i(){a.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(a),a.addEventListener("updateend",(function(){t()})))}),200),a.removeEventListener("updateend",i)}))})):new Promise((function(t){e.clearBuffer(a),a.addEventListener("updateend",(function(){t()}))})),i.push(n)}(r);return Promise.all(i)}},{key:"removeBuffers",value:function(){for(var t=this,i=[],r=0;r<Object.keys(this.sourceBuffers).length;r++)!function(r){var n=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n.removeEventListener("updateend",t.onUpdateEnd);var a;a=n.updating?new Promise((function(t){n.addEventListener("updateend",(function i(){var r=3;setTimeout((function i(){n.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(n),n.addEventListener("updateend",(function(){t()})))}),200),n.removeEventListener("updateend",i)}))})):new Promise((function(t){e.clearBuffer(n),n.addEventListener("updateend",(function(){t()}))})),i.push(a)}(r);return Promise.all(i)}},{key:"destroy",value:function(){var e=this;return this.container?(this.container.removeEventListener("timeupdate",this.onTimeUpdate),this.container.removeEventListener("waiting",this.onWaiting),this.mediaSource.removeEventListener("sourceopen",this.onSourceOpen),this.removeBuffers().then((function(){for(var t=Object.keys(e.sourceBuffers),i=0;i<t.length;i++){var r=e.sourceBuffers[t[i]];delete e.sourceBuffers[t[i]],"open"===e.mediaSource.readyState&&e.mediaSource.removeSourceBuffer(r)}e.endOfStream(),window.URL.revokeObjectURL(e.url),e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1,e.onSourceOpen=null,e.onTimeUpdate=null,e.onUpdateEnd=null,e.onWaiting=null,e.noaudio=void 0,e.novideo=void 0}))):Promise.resolve()}},{key:"sourceBufferLen",get:function(){return this._context.mediaInfo?(!!this._context.mediaInfo.hasVideo&&!this.novideo)+(!!this._context.mediaInfo.hasAudio&&!this.noaudio):this.noaudio||this.novideo?1:2}},{key:"url",set:function(e){this._url=e},get:function(){return this._url||(this._url=window.URL.createObjectURL(this.mediaSource)),this._url}}],[{key:"clearBuffer",value:function(e){try{for(var t=e.buffered,i=.1,r=0,n=t.length;r<n;r++)i=t.end(r);e.remove(0,i)}catch(e){}}}]),e}(),Oe=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),Ue={get device(){var e=Ue.os;return e.isPc?"pc":e.isTablet?"tablet":"mobile"},get browser(){var e=navigator.userAgent.toLowerCase(),t={ie:/rv:([\d.]+)\) like gecko/,firfox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(t).filter((function(i){return t[i].test(e)})))[0]},get os(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,r=/(?:Android)/.test(e),n=/(?:Firefox)/.test(e),a=/(?:iPad|PlayBook)/.test(e)||r&&!/(?:Mobile)/.test(e)||n&&/(?:Tablet)/.test(e),s=/(?:iPhone)/.test(e)&&!a;return{isTablet:a,isPhone:s,isAndroid:r,isPc:!s&&!r&&!i,isSymbian:i,isWindowsPhone:t,isFireFox:n}},get isLe(){return Oe}},Be="function"==typeof Symbol&&"symbol"==s(Symbol.iterator)?function(e){return void 0===e?"undefined":s(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":s(e)},xe="function"==typeof Symbol&&"symbol"===Be(Symbol.iterator)?function(e){return void 0===e?"undefined":Be(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":Be(e)},Ce=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Me=F.LOADER_EVENTS,Pe=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.configs=Object.assign({},t),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0}return Ce(e,[{key:"init",value:function(){this.on(Me.LADER_START,this.load.bind(this))}},{key:"fetch",value:function(e){function t(t,i,r){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e,t,i){var r=null;return Promise.race([fetch(e,t),new Promise((function(e,t){r=setTimeout((function(){t({code:999,message:"fetch timeout"})}),i||1e4)}))]).then((function(e){return r&&(clearTimeout(r),r=null),e}))}))},{key:"internalLoad",value:function(e,t,i,r){var n=this,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return this.loading=!0,this.fetch(this.url,t,!i&&1e5).then((function(s){if(n.emit(Me.LOADER_RESPONSE_HEADERS,n.TAG,s.headers),s.ok)return n.status=s.status,Promise.resolve().then((function(){n._onFetchResponse(s)})),Promise.resolve(s);i-- >0?n._retryTimer=setTimeout((function(){return n.emit(Me.LOADER_RETRY,n.TAG,{response:s,reason:"response not ok",retryTime:r-i}),n.internalLoad(e,t,i,r,a)}),a):(n.loading=!1,n.emit(Me.LOADER_ERROR,n.TAG,{code:s.status,message:s.status+" ("+s.statusText+")"}))})).catch((function(s){if(n.loading=!1,!(i-- >0))throw n.emit(Me.LOADER_ERROR,n.TAG,s),s;n._retryTimer=setTimeout((function(){return n.emit(Me.LOADER_RETRY,n.TAG,{error:s,reason:"fetch error",retryTime:r-i}),n.internalLoad(e,t,i,r,a)}),a)}))}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments[2],r=arguments[3];i=void 0===i?3:i,this.url=e,this._canceled=!1;var n=this.getParams(t);return this.internalLoad(e,n,i,i,r)}},{key:"_onFetchResponse",value:function(e){var t=this,i=this._context.getInstance(this.buffer),r=++this._loaderTaskNo;if(!0===e.ok)switch(this.readtype){case 2:e.json().then((function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(Me.LOADER_COMPLETE,i)):t.emit(Me.LOADER_COMPLETE,e))}));break;case 1:e.text().then((function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(Me.LOADER_COMPLETE,i)):t.emit(Me.LOADER_COMPLETE,e))}));break;case 3:e.arrayBuffer().then((function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(new Uint8Array(e)),t.emit(Me.LOADER_COMPLETE,i)):t.emit(Me.LOADER_COMPLETE,e))}));break;case 0:default:return this._onReader(e.body.getReader(),r)}}},{key:"_onReader",value:function(e,t){var i=this,r=this._context.getInstance(this.buffer);if(!r&&this._reader||this._destroyed)try{this._reader.cancel()}catch(e){}this._reader=e,!1!==this.loading&&this._reader&&this._reader.read().then((function(n){if(!i._canceled&&!i._destroyed)return n.done?(i.loading=!1,i.status=0,void Promise.resolve().then((function(){i.emit(Me.LOADER_COMPLETE,r)}))):(r.push(n.value),Promise.resolve().then((function(){i.emit(Me.LOADER_DATALOADED,r)})),i._onReader(e,t));if(i._reader)try{i._reader.cancel()}catch(e){}})).catch((function(e){throw i.loading=!1,i.emit(Me.LOADER_ERROR,i.TAG,e),e}))}},{key:"getParams",value:function(e){var t=Object.assign({},e),i=new Headers,r={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===xe(this.configs.headers)){var n=this.configs.headers;for(var a in n)n.hasOwnProperty(a)&&i.append(a,n[a])}if("object"===xe(t.headers)){var s=t.headers;for(var o in s)s.hasOwnProperty(o)&&i.append(o,s[o])}return!1===t.cors&&(r.mode="same-origin"),t.withCredentials&&(r.credentials="include"),r}},{key:"cancel",value:function(){if(this._reader){try{this._reader.cancel()}catch(e){}this._reader=null,this.loading=!1}this._canceled=!0}},{key:"destroy",value:function(){this._destroyed=!0,clearTimeout(this._retryTimer),this.cancel()}}],[{key:"type",get:function(){return"loader"}}]),e}(),Ie=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Ge=new(function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);try{var i=/xgd=(\d)/.exec(document.cookie);this._status=!!i,this._level=i&&i[1]}catch(e){this._status=!1}["group","groupEnd","log","warn","error"].forEach((function(e){t[e]=function(i,r,n,a,s,o,u,l,d,h){var c;if(t._status){var f=i,p=[r,n,a,s,o,u,l,d,h].filter((function(e){return void 0!==e}));(c=console)[e].apply(c,["["+f+"]:"].concat(function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}(p)))}}}))}return Ie(e,[{key:"enable",get:function(){return this._status}},{key:"long",get:function(){return"2"===this._level}}]),e}()),Fe=w,Ne=ke,je=we,Ve=Le,He=Ue,Xe=F,We=Pe,ze=Ge,Ye=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),qe=Xe.LOADER_EVENTS,Ke=Xe.REMUX_EVENTS,Ze=Xe.DEMUX_EVENTS,Qe=Xe.HLS_EVENTS,$e=Xe.CRYTO_EVENTS,Je=Xe.MSE_EVENTS,et=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,tt=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.configs=Object.assign({},t),this.url="",this.baseurl="",this.sequence=0,this._playlist=null,this.retrytimes=this.configs.retrytimes||3,this.preloadTime=this.configs.preloadTime,this.container=this.configs.container,this._m3u8lasttime=0,this._timmer=setInterval(this._checkStatus.bind(this),300),this._lastCheck=0,this._player=this.configs.player,this.m3u8Text=null}return Ye(e,[{key:"init",value:function(){var e=this._player.hlsOps,t=e.XgBuffer,i=e.Tracks,r=e.Playlist,n=e.PreSource,a=e.Compatibility,s=e.FetchLoader,o=e.TsDemuxer,u=e.Mp4Remuxer,l=e.Mse;this._context.registry("M3U8_BUFFER",t),this._context.registry("TS_BUFFER",t),this._context.registry("TRACKS",i),this._playlist=this._context.registry("PLAYLIST",r)({autoclear:!0}),this._context.registry("PRE_SOURCE_BUFFER",n),this._context.registry("COMPATIBILITY",a),this._m3u8loader=this._context.registry("M3U8_LOADER",s)({buffer:"M3U8_BUFFER",readtype:1}),this._tsloader=this._context.registry("TS_LOADER",s)({buffer:"TS_BUFFER",readtype:3}),this._context.registry("TS_DEMUXER",o)({inputbuffer:"TS_BUFFER"}),this._context.registry("MP4_REMUXER",u),this.mse=this._context.registry("MSE",l)({container:this.container}),this.initEvents()}},{key:"initEvents",value:function(){this.on(qe.LOADER_COMPLETE,this._onLoadComplete.bind(this)),this.on(qe.LOADER_RETRY,this._handleFetchRetry.bind(this)),this.on(Ke.INIT_SEGMENT,this.mse.addSourceBuffers.bind(this.mse)),this.on(Ke.MEDIA_SEGMENT,this.mse.doAppend.bind(this.mse)),this.on(Ze.METADATA_PARSED,this._onMetadataParsed.bind(this)),this.on(Ze.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(Ze.DEMUX_COMPLETE,this._onDemuxComplete.bind(this)),this.on(qe.LOADER_ERROR,this._onLoadError.bind(this)),this.on(Ze.DEMUX_ERROR,this._onDemuxError.bind(this)),this.on(Ke.REMUX_ERROR,this._onRemuxError.bind(this)),this.on(Je.MSE_ERROR,this._handleMseError.bind(this))}},{key:"_onError",value:function(e,t,i,r){var n={code:i.code,errorType:e,errorDetails:"["+t+"]: "+(i?i.message:""),errorFatal:r};this._player.emit("HLS_ERROR",n)}},{key:"_onDemuxComplete",value:function(){this.emit(Ke.REMUX_MEDIA,"ts")}},{key:"_onMetadataParsed",value:function(e){"video"===e&&(this._context.mediaInfo.hasVideo=!0),"audio"===e&&(this._context.mediaInfo.hasAudio=!0),this.emit(Ke.REMUX_METADATA,e)}},{key:"_onLoadError",value:function(e,t){!this._tsloader.loading&&!this._m3u8loader.loading&&this.retrytimes>=1?(this.retrytimes--,this._onError(qe.LOADER_ERROR,e,t,!1)):this.retrytimes<=1&&(this._player.emit("error",{code:t.code,errorType:"network",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(qe.LOADER_ERROR,e,t,!0),this.emit(Qe.RETRY_TIME_EXCEEDED),this.mse.endOfStream())}},{key:"_onDemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{code:t.code,errorType:"network",ex:"["+e+"]: "+(t?t.message:""),errd:{}}),this._onError(qe.LOADER_ERROR,e,t,i)}},{key:"_onRemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._onError(Ke.REMUX_ERROR,e,t,i)}},{key:"_handleMseError",value:function(e,t,i){void 0===i&&(i=!1),this._player.emit("error",{code:t.code,errorType:"parse",ex:"["+e+"]: "+(t?t.message:""),errd:{}}),this._onError(Je.MSE_ERROR,e,t,i)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_onLoadComplete",value:function(e){if("M3U8_BUFFER"===e.TAG){var t=void 0;try{this.m3u8Text=e.shift();var i=et.exec(this.m3u8Text);i&&i[2]?this.load(i[2]):t=this._player.hlsOps.M3U8Parser.parse(this.m3u8Text,this.baseurl)}catch(e){this._onError("M3U8_PARSER_ERROR","M3U8_PARSER",e,!1)}if(!t)return void(this.retrytimes>0?(this.retrytimes--,this._preload()):(this.emit(Qe.RETRY_TIME_EXCEEDED),this.mse.endOfStream()));try{this._playlist.pushM3U8(t,!0)}catch(e){this._onError("M3U8_PARSER_ERROR","PLAYLIST",e,!1)}if(this._playlist.encrypt&&this._playlist.encrypt.uri&&!this._playlist.encrypt.key){var r=this._player.hlsOps.XgBuffer;this._context.registry("DECRYPT_BUFFER",r)(),this._context.registry("KEY_BUFFER",r)(),this._tsloader.buffer="DECRYPT_BUFFER",this._keyLoader=this._context.registry("KEY_LOADER",We)({buffer:"KEY_BUFFER",readtype:3});var n=this._player.config.retry||{},a=n.count,s=n.delay;this.emitTo("KEY_LOADER",qe.LADER_START,this._playlist.encrypt.uri,{},a,s)}else this._m3u8Loaded(t)}else"TS_BUFFER"===e.TAG?(this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emit(Ze.DEMUX_START)):"DECRYPT_BUFFER"===e.TAG?(this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emitTo("CRYPTO",$e.START_DECRYPT)):"KEY_BUFFER"===e.TAG&&(this.retrytimes=this.configs.retrytimes||3,this._playlist.encrypt.key=e.shift(),this._crypto=this._context.registry("CRYPTO",je)({key:this._playlist.encrypt.key,iv:this._playlist.encrypt.ivb,method:this._playlist.encrypt.method,inputbuffer:"DECRYPT_BUFFER",outputbuffer:"TS_BUFFER"}),this._crypto.on($e.DECRYPTED,this._onDcripted.bind(this)))}},{key:"_handleFetchRetry",value:function(e,t){this._player.emit("retry",Object.assign({tag:e},t))}},{key:"_onDcripted",value:function(){this.emit(Ze.DEMUX_START)}},{key:"_m3u8Loaded",value:function(e){this.preloadTime||(this.preloadTime=this._playlist.targetduration?this._playlist.targetduration:5),this._playlist.fragLength>0&&this._playlist.sequence<e.sequence?this.retrytimes=this.configs.retrytimes||3:this.retrytimes>0?(this.retrytimes--,this._preload()):(this.emit(Qe.RETRY_TIME_EXCEEDED),this.mse.endOfStream())}},{key:"_checkStatus",value:function(){if(!(this.retrytimes<1&&Date.now()-this._lastCheck<4e3))if(this.retrytimes<1&&clearInterval(this._timmer),this._lastCheck=(new Date).getTime(),this.container.buffered.length<1)this._preload();else{var e=this.container.currentTime,t=this.container.buffered.start(this.container.buffered.length-1);this.container.readyState<=2&&(e<t?(this.container.currentTime=t,e=t):this._preload());var i=this.container.buffered.end(this.container.buffered.length-1);e<i-2*this.preloadTime&&(this.container.currentTime=i-this.preloadTime),e>i-this.preloadTime&&this._preload()}}},{key:"_preload",value:function(){if(!this._tsloader.loading&&!this._m3u8loader.loading){var e=this._playlist.getTs(),t=this._player.config.retry||{},i=t.count,r=t.delay;if(!e||e.downloaded||e.downloading){var n=this.preloadTime?this.preloadTime:0,a=(new Date).getTime();(!e||e.downloaded)&&(a-this._m3u8lasttime)/1e3>n&&(this._m3u8lasttime=a,this.emitTo("M3U8_LOADER",qe.LADER_START,this.url,{},i,r))}else this._playlist.downloading(e.url,!0),this.emitTo("TS_LOADER",qe.LADER_START,e.url,{},i,r)}}},{key:"load",value:function(e){this.baseurl=this._player.hlsOps.M3U8Parser.parseURL(e),this.url=e,this._preload()}},{key:"destroy",value:function(){clearInterval(this._timmer),this.off(qe.LOADER_COMPLETE,this._onLoadComplete),this.off(Ke.INIT_SEGMENT,this.mse.addSourceBuffers),this.off(Ke.MEDIA_SEGMENT,this.mse.doAppend),this.off(Ze.METADATA_PARSED,this._onMetadataParsed),this.off(Ze.DEMUX_COMPLETE,this._onDemuxComplete),this.mse=null,this.m3u8Text=null}}]),e}(),it=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),rt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return it(e,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),e}(),nt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),at=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return nt(e,null,[{key:"isHeader",value:function(t,i){return!!(i+1<t.length&&e.isHeaderPattern(t,i))}},{key:"getFrameDuration",value:function(e){return 9216e4/e}},{key:"isHeaderPattern",value:function(e,t){return 255===e[t]&&240==(246&e[t+1])}},{key:"getHeaderLength",value:function(e,t){return 1&e[t+1]?7:9}},{key:"getFullFrameLength",value:function(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}},{key:"parseFrameHeader",value:function(t,i,r,n,a){var s,o=void 0,u=t.length;if(s=e.getHeaderLength(t,i),o=e.getFullFrameLength(t,i),(o-=s)>0&&i+s+o<=u)return{headerLength:s,frameLength:o,stamp:r+n*a}}},{key:"appendFrame",value:function(t,i,r,n,a){var s=e.getFrameDuration(t.meta.sampleRate),o=e.parseFrameHeader(i,r,n,a,s);if(o){var u=o.stamp,l=o.headerLength,d=o.frameLength;return{sample:{unit:i.subarray(r+l,r+l+d),pts:u,dts:u},length:d+l}}}}]),e}(),st=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ot=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return st(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}]),e}(),ut=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),lt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return ut(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(r[n]=t[a],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(t){var i=e._ebsp2rbsp(t),r=new ot(i);r.readByte();var n=r.readByte();r.readByte();var a=r.readByte();r.readUEG();var s=e.getProfileString(n),o=e.getLevelString(a),u=1,l=420,d=8;if((100===n||110===n||122===n||244===n||44===n||83===n||86===n||118===n||128===n||138===n||144===n)&&(3===(u=r.readUEG())&&r.readBits(1),u<=3&&(l=[0,420,422,444][u]),d=r.readUEG()+8,r.readUEG(),r.readBits(1),r.readBool()))for(var h=3!==u?8:12,c=0;c<h;c++)r.readBool()&&(c<6?e._skipScalingList(r,16):e._skipScalingList(r,64));r.readUEG();var f=r.readUEG();if(0===f)r.readUEG();else if(1===f){r.readBits(1),r.readSEG(),r.readSEG();for(var p=r.readUEG(),y=0;y<p;y++)r.readSEG()}r.readUEG(),r.readBits(1);var v=r.readUEG(),_=r.readUEG(),m=r.readBits(1);0===m&&r.readBits(1),r.readBits(1);var g=0,E=0,b=0,T=0;r.readBool()&&(g=r.readUEG(),E=r.readUEG(),b=r.readUEG(),T=r.readUEG());var k=1,S=1,A=0,w=!0,D=0,R=0;if(r.readBool()){if(r.readBool()){var L=r.readByte();L>0&&L<16?(k=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][L-1],S=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][L-1]):255===L&&(k=r.readByte()<<8|r.readByte(),S=r.readByte()<<8|r.readByte())}if(r.readBool()&&r.readBool(),r.readBool()&&(r.readBits(4),r.readBool()&&r.readBits(24)),r.readBool()&&(r.readUEG(),r.readUEG()),r.readBool()){var O=r.readBits(32),U=r.readBits(32);w=r.readBool(),A=(D=U)/(R=2*O)}}var B=1;1===k&&1===S||(B=k/S);var x=0,C=0;0===u?(x=1,C=2-m):(x=3===u?1:2,C=(1===u?2:1)*(2-m));var M=16*(v+1),P=16*(_+1)*(2-m);M-=(g+E)*x,P-=(b+T)*C;var I=Math.ceil(M*B);return r.destroy(),r=null,{profile_string:s,level_string:o,bit_depth:d,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:w,fps:A,fps_den:R,fps_num:D},par_ratio:{width:k,height:S},codec_size:{width:M,height:P},present_size:{width:I,height:P}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.readSEG()+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var i=t.frameRate.fps_den,r=t.frameRate.fps_num;return t.refSampleDuration=Math.floor(t.timescale*(i/r)),t}}]),e}(),dt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ht=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return dt(e,null,[{key:"EBSP2RBSP",value:function(e){return e.filter((function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)}))}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),e}(),ct=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ft=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t},pt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return ct(e,null,[{key:"_resolveNalu",value:function(e){return e.length>=1?ht.EBSP2SODB(ht.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),r=e.switchPayloadType(i),n=r.payloadType,a=r.offset,s=i.slice(a);switch(n){case 5:return e.user_data_unregistered(s);default:return{code:n,content:s}}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),r=i.payloadLength,n=i.offset;if(r<16)return{uuid:"",content:null};var a=t.slice(n);return{code:5,uuid:ft(a.slice(0,16)),content:ft(a.slice(16,r))}}}]),e}(),yt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),vt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return yt(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,r=t.position;return 1===i.getInt32(r)||0===i.getInt16(r)&&1===i.getInt8(r+3)?e.getAnnexbNals(t):e.getAvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],r=e.getHeaderPositionAnnexB(t),n=r.pos,a=n;n<t.length-4;){var s=t.buffer.slice(n,n+r.headerLength);r.pos===t.position&&t.skip(r.headerLength),a=(r=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(n+s.byteLength,a))};e.analyseNal(o),o.type<=9&&0!==o.type&&i.push(o),t.skip(a-t.position),n=a}return i}},{key:"getAvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var r=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=r))break;var n=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+r));t.skip(r);var s={header:n,body:a};e.analyseNal(s),s.type<=9&&0!==s.type&&i.push(s)}return i}},{key:"analyseNal",value:function(e){var t=31&e.body[0];switch(e.type=t,t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:e.sei=pt.parse(e.body);break;case 7:e.sps=lt.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(i=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=r)),{pos:t,headerLength:i}}},{key:"getAvcc",value:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength+11);i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=255,i[5]=225;var r=6;return i.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),r),r+=2,i.set(e,r),i[r+=e.byteLength]=1,r++,i.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),r),r+=2,i.set(t,r),i}}]),e}(),_t=lt,mt=vt,gt=pt,Et=ot,bt=Object.freeze({__proto__:null,SpsParser:_t,NalUnit:mt,SEIParser:gt,Golomb:Et}),Tt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),kt=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return Tt(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){if(0===this._currentWordBitsLeft)return 0;var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}(),St=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),At=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return St(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(r[n]=t[a],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(t){var i,r,n,a,s,o,u=e._ebsp2rbsp(t),l=new kt(u),d=0,h=0,c=0,f=0,p=0,y=0,v=0,_=0,m=0;return l.readByte(),l.readByte(),l.readBits(4),i=l.readBits(3),l.readBits(1),o=e._readProfileTierLevel(l,i),l.readUEG(),3===(r=l.readUEG())&&(d=l.readBits(1)),h=l.readUEG(),c=l.readUEG(),1===(n=l.readBits(1))&&(f=l.readUEG(),p=l.readUEG(),y=l.readUEG(),v=l.readUEG()),a=l.readUEG(),s=l.readUEG(),1===n&&(h-=(_=1!==r&&2!==r||0!==d?1:2)*p+_*f,c-=(m=1===r&&0===d?2:1)*v+m*y),l.destroy(),l=null,{width:h,height:c,general_profile_space:o.general_profile_space,general_tier_flag:o.general_tier_flag,general_profile_idc:o.general_profile_idc,general_level_idc:o.general_level_idc,chromaFormatIdc:r,bitDepthLumaMinus8:a,bitDepthChromaMinus8:s}}},{key:"_readProfileTierLevel",value:function(e,t){var i,r,n,a;i=e.readBits(2)||0,r=e.readBits(1)||0,n=e.readBits(5)||0,e.readBits(16),e.readBits(16),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(16),e.readBits(16),e.readBits(12),a=e.readBits(8)||0;for(var s=[],o=[],u=0;u<t;u++)s[u]=e.readBits(1),o[u]=e.readBits(1);t>0&&e.readBits(2*(8-t));for(var l=0;l<t;l++)0!==s[l]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==o[l]&&e.readBits(8);return{general_profile_space:i,general_tier_flag:r,general_profile_idc:n,general_level_idc:a}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.readSEG()+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};return e&&e.codec_size?(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height):e.width&&e.height&&(t.codecWidth=e.width,t.codecHeight=e.height,t.presentWidth=e.width,t.presentHeight=e.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t}}]),e}(),wt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Dt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return wt(e,null,[{key:"EBSP2RBSP",value:function(e){return e.filter((function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)}))}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),e}(),Rt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Lt=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t},Ot=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Rt(e,null,[{key:"_resolveNalu",value:function(e){return e.length>=1?Dt.EBSP2SODB(Dt.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),r=e.switchPayloadType(i),n=r.payloadType,a=r.offset,s=i.slice(a);switch(n){case 5:return e.user_data_unregistered(s);default:return{code:n,content:s}}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),r=i.payloadLength,n=i.offset;if(r<16)return{uuid:"",content:null};var a=t.slice(n);return{code:5,uuid:Lt(a.slice(0,16)),content:Lt(a.slice(16,r))}}}]),e}(),Ut=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Bt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Ut(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,r=t.position;return 1===i.getInt32(r)||0===i.getInt16(r)&&1===i.getInt8(r+2)?e.getAnnexbNals(t):e.getHvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],r=e.getHeaderPositionAnnexB(t),n=r.pos,a=n;n<t.length-4;){var s=t.buffer.slice(n,n+r.headerLength);r.pos===t.position&&t.skip(r.headerLength),a=(r=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(n+s.byteLength,a))};e.analyseNal(o),o.type<=40&&i.push(o),t.skip(a-t.position),n=a}return i}},{key:"getHvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var r=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=r))break;var n=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+r));t.skip(r);var s={header:n,body:a};try{e.analyseNal(s)}catch(e){continue}s.type<=40&&i.push(s)}return i}},{key:"analyseNal",value:function(e){var t=e.body[0]>>>1&63;switch(e.type=t,t){case 0:e.slice_trail_n=!0;break;case 1:e.slice_trail_r=!0,e.key=!0;break;case 2:e.slice_tsa_n=!0;break;case 3:e.slice_tsa_r=!0,e.key=!0;break;case 4:e.slice_stsa_n=!0;break;case 5:e.slice_stsa_r=!0,e.key=!0;break;case 6:e.slice_radl_n=!0;break;case 7:e.slice_radl_r=!0,e.key=!0;break;case 8:e.slice_rasl_n=!0;break;case 9:e.slice_rasl_r=!0,e.key=!0;break;case 16:e.slice_bla_w_lp=!0;break;case 17:e.slice_bla_w_radl=!0;break;case 18:e.slice_bla_n_lp=!0;break;case 19:e.slice_idl_w_radl=!0,e.key=!0;break;case 20:e.slice_idr_n_lp=!0,e.key=!0;break;case 21:e.slice_cra_nut=!0,e.key=!0;break;case 32:e.vps=!0;break;case 33:e.sps=At.parseSPS(e.body);break;case 34:e.pps=!0;break;case 35:break;case 36:e.aud=!0;break;case 37:e.eob=!0;break;case 38:e.fd=!0;break;case 39:case 40:e.sei=Ot.parse(e.body.slice(1))}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(i=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=r)),{pos:t,headerLength:i}}}]),e}(),xt=At,Ct=Bt,Mt=Object.freeze({__proto__:null,SpsParserHEVC:xt,NalUnitHEVC:Ct}),Pt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),It=Xe.REMUX_EVENTS,Gt=Fe.caculate,Ft=at,Nt=bt,jt=Mt,Vt=function(){function e(){var t=this;(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.TAG="Compatibility",this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this._lastSegmentId=0,this._currentSegmentId=0,this._format="",this.videoLastSample=null,this.audioLastSample=null,Object.defineProperties(this,{_videoLargeGap:{set:function(e){t.___videoLargeGap=e,0!==e&&t.emit(It.DETECT_LARGE_GAP,"video",e)},get:function(){return t.___videoLargeGap||0}},_audioLargeGap:{set:function(e){t.___audioLargeGap=e,0!==e&&t.emit(It.DETECT_LARGE_GAP,"audio",e)},get:function(){return t.___audioLargeGap||0}}}),this.audioUnsyncTime=0}return Pt(e,[{key:"init",value:function(){this.before(It.REMUX_MEDIA,this.doFix.bind(this))}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this._audioLargeGap=0,this._videoLargeGap=0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.audioUnsyncTime=0}},{key:"_isSegmentsContinuous",value:function(){return this.isTs&&this._currentSegmentId-this._lastSegmentId==1}},{key:"doFix",value:function(t){this._format=t;var i=void 0,r=void 0,n=void 0;this.videoTrack.samples.length&&(i=(r=this.videoTrack.samples[0]).options,ze.long&&ze.log(this.TAG,this.videoTrack.samples.slice())),this.audioTrack.samples.length&&(n=this.audioTrack.samples[0],ze.long&&ze.log(this.TAG,this.audioTrack.samples.slice())),"ts"===t&&(this._currentSegmentId=i&&i.id||this._currentSegmentId+1),ze.log(this.TAG,"lastSeg:"+this._lastSegmentId+" , currentSeg:"+this._currentSegmentId+", discontinue:"+(i&&i.discontinue)+" vSamp0:"+(r&&r.dts)+" aSamp0:"+(n&&n.dts));var a=this.getFirstSample(),s=a.isFirstAudioSamples,o=a.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixVideoRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples);var u=e.detectChangeStream(this.videoTrack.samples,o),l=u.changed,d=u.changedIdxes;if(l){for(var h=!1,c=0;c<d.length;c++)this.fixChangeStreamVideo(d[c],o)&&(h=!0);h||this.doFixVideo(o)}else!this._isSegmentsContinuous()&&i&&void 0!==i.start?(ze.log(this.TAG,"fix video for _isSegmentsContinuous()"),this.videoLastSample=null,this.doFixVideo(o,i.start),this.emit(It.DETECT_FRAG_ID_DISCONTINUE,i.start/1e3)):this.doFixVideo(o);var f=e.detectChangeStream(this.audioTrack.samples,s),p=f.changed,y=f.changedIdxes;if(p){for(var v=!1,_=0;_<y.length;_++)this.fixChangeStreamAudio(y[_],s)&&(v=!0);if(v)return;this.doFixAudio(s)}else!this._isSegmentsContinuous()&&i&&void 0!==i.start?(ze.log(this.TAG,"fix audio for _isSegmentsContinuous()"),this.nextAudioDts=null,this.doFixAudio(s,i.start),this.emit(It.DETECT_FRAG_ID_DISCONTINUE,i.start/1e3)):this.doFixAudio(s);this.removeInvalidSamples(),this._lastSegmentId=this._currentSegmentId}},{key:"doFixVideo",value:function(t,i){for(var r=this.videoTrack,n=r.samples,a=r.meta,s=n.length,o=0;o<s;o++){var u=n[o];u.originDts=u.dts,u.originPts=u.pts}if(n&&s&&this._firstVideoSample){var l=n[0];if(ze.log(this.TAG,"doFixVideo:: lastVideoDts: "+this.lastVideoDts+" ,  _videoLargeGap: "+this._videoLargeGap+" ,streamChangeStart:"+i+", lastVideoSample:[dts="+(this.videoLastSample&&this.videoLastSample.dts)+" , pts="+(this.videoLastSample&&this.videoLastSample.pts)+"] ,  firstDTS:"+l.dts+" ,firstPTS:"+l.pts+" ,lastDTS:"+n[s-1].dts+" , lastPTS: "+n[s-1].pts),!t&&null===this.videoLastSample&&l.options&&l.options.start&&void 0!==i&&(i=l.options.start),!t&&void 0===i&&this.videoLastSample&&e.detectVideoLargeGap(this.isTs,this.videoLastSample?this.videoLastSample.dts:0,l.dts+this._videoLargeGap)&&(this._videoLargeGap=this.videoLastSample.dts+a.refSampleDuration-l.dts),0!==this._videoLargeGap&&e.doFixLargeGap(n,this._videoLargeGap),t||void 0===i||(this._videoLargeGap=i-l.dts,e.doFixLargeGap(n,this._videoLargeGap)),t&&this._firstAudioSample){var d=this._firstVideoSample.originDts,h=d-(this._firstAudioSample.originDts||this._firstAudioSample.dts);if(h>2*a.refSampleDuration&&h<10*a.refSampleDuration){for(var c=Math.floor(h/a.refSampleDuration),f=0;f<c;f++){var p=Object.assign({},l);p.dts=d-(f+1)*a.refSampleDuration,p.pts=p.dts+p.cts,n.unshift(p),this.filledVideoSamples.push({dts:p.dts,size:p.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else Math.abs(h)>2*a.refSampleDuration&&!this._videoLargeGap&&(this._videoLargeGap=-1*h,e.doFixLargeGap(n,-1*h))}for(var y=n.length,v=1;v<y;v++){var _=n[v],m=n[v-1],g=_.dts-_.pts;Math.abs(g)<2e3&&Math.abs(_.dts-m.dts)>1e4&&(_.dts=m.dts+a.refSampleDuration,_.pts=m.pts+a.refSampleDuration)}var E=n.pop();if(n.length&&(n[n.length-1].duration=E.dts-n[n.length-1].dts),this.isTs&&y<4){var b=n[n.length-1],T=(b=b||E).options&&b.options.duration,k=a.refSampleDuration;if(T&&k&&T/k>5)for(var S=b.pts,A=b.dts,w=0;w<3;w++){A+=k,S+=k;var D=Object.assign({},b,{dts:A,pts:S});2===w&&(D.duration=T),n.push(D)}E=null}if(this.videoLastSample){var R=this.videoLastSample;R.duration=l.dts-R.dts,n.unshift(this.videoLastSample)}this.videoLastSample=E,n[n.length-1]&&(this.lastVideoDts=n[n.length-1].dts),this.videoTrack.samples=n}}},{key:"doFixAudio",value:function(t,i){var r=this,n=this.audioTrack,a=n.samples,s=n.meta;if(a&&a.length){this.fixAudioRefSampleDuration(s);for(var o=0,u=a.length;o<u;o++){var l=a[o];l.originDts=l.dts}var d=a.length,h=rt.getSilentFrame(s.codec,s.channelCount),c=Math.floor(s.refSampleDuration),f=this._firstAudioSample,p=a[0];if(ze.log(this.TAG,"doFixAudio:: audioDtsBase:"+this.audioDtsBase+" ,  _audioLargeGap: "+this._audioLargeGap+", streamChangeStart:"+i+" ,  nextAudioDts:"+this.nextAudioDts+",  audio: firstDTS:"+p.dts+" ,firstPTS:"+p.pts+" ,lastDTS:"+a[d-1].dts+" , lastPTS: "+a[d-1].pts),!t&&null===this.nextAudioDts&&p.options&&p.options.start&&void 0!==i&&(i=p.options.start),!t&&void 0===i&&this.nextAudioDts&&e.detectAudioLargeGap(this.nextAudioDts||0,p.dts+this._audioLargeGap)){var y=this.nextAudioDts-p.dts;this._audioLargeGap=Math.abs(y-this._videoLargeGap)<200?this._videoLargeGap:y}if(0!==this._audioLargeGap?(e.doFixLargeGap(a,this._audioLargeGap),0===this._videoLargeGap||this._audioLargeGap!==this.preAudioGap&&this._videoLargeGap===this.preVideoGap?(this.emit(It.DETECT_CHANGE_STREAM_DISCONTINUE,"audio"),this.preVideoGap=void 0,this.preAudioGap=void 0):(this.preVideoGap=this._videoLargeGap,this.preAudioGap=this._audioLargeGap)):t||void 0===i&&!e.detectAudioLargeGap(this.nextAudioDts,p.dts)||(void 0!==i&&(this.nextAudioDts=i),this._audioLargeGap=this.nextAudioDts-p.dts,p.options.start&&!p.options.start.isContinue&&e.doFixLargeGap(a,this._audioLargeGap)),this._firstVideoSample&&t){var v=this._firstVideoSample.originDts||this._firstVideoSample.dts,_=f.dts-v;if(_===this._videoLargeGap);else if(_>s.refSampleDuration&&_<10*s.refSampleDuration){for(var m=Math.floor((f.dts-v)/s.refSampleDuration),g=0;g<m;g++){var E={data:h,datasize:h.byteLength,dts:f.dts-(g+1)*s.refSampleDuration,filtered:0};a.unshift(E),this.filledAudioSamples.push({dts:E.dts,size:E.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else _<-1*s.refSampleDuration&&(this._audioLargeGap=-1*_,e.doFixLargeGap(a,-1*_))}var b=void 0,T=a[0].dts;if(this.nextAudioDts){b=T-this.nextAudioDts;var k=Math.abs(b);if(b>=c&&b<1e4&&h){for(var S=Math.ceil(b/c),A=0;A<S;A++){var w=T-(A+1)*c,D={dts:w>this.nextAudioDts?w:this.nextAudioDts,pts:w>this.nextAudioDts?w:this.nextAudioDts,datasize:h.byteLength,filtered:0,data:h};this.filledAudioSamples.push({dts:D.dts,size:D.data.byteLength}),this.audioTrack.samples.unshift(D),p=D}this.emit(It.DETECT_AUDIO_GAP,b,S)}else k<s.refSampleDuration&&k>0?(p.dts=this.nextAudioDts,p.pts=this.nextAudioDts):b<0&&k<c&&(e.doFixLargeGap(a,-1*b),this.emit(It.DETECT_AUDIO_OVERLAP,b))}for(var R=a[0].dts+c,L=1;L<a.length;){var O=a[L],U=O.dts-R;if(U<=-1*c)ze.warn("drop 1 audio sample for "+U+" ms overlap"),a.splice(L,1);else if(U>=10*c){var B=Math.round(U/c);if(B>1e3)break;ze.warn(this.TAG,"inject "+B+" audio frame for "+U+" ms gap");for(var x=0;x<B;x++){var C={data:h,datasize:h.byteLength,dts:R,originDts:R,filtered:0};a.splice(L,0,C),R+=c,L++}O.dts=O.pts=O.originDts=R,R+=c,L++}else O.dts=O.pts=O.originDts=R,R+=c,L++}var M=s.refSampleDuration-c;a.forEach((function(e,t){if(0!==t){var i=a[t-1];e.dts=e.pts=i.dts+i.duration}e.duration=c,r.audioUnsyncTime=Gt.fixedFloat(r.audioUnsyncTime+M,2),r.audioUnsyncTime>=1&&(e.duration+=1,r.audioUnsyncTime-=1)}));var P=a[a.length-1],I=P.dts,G=P.duration;this.lastAudioSamplesLen=d,this.nextAudioDts=I+(G||c),this.audioTrack.samples=e.sortAudioSamples(a)}}},{key:"fixChangeStreamVideo",value:function(e){ze.log(this.TAG,"fixChangeStreamVideo(), changeIdx=",e);var t=this.videoTrack.samples,i=0===e?this.lastVideoDts?this.lastVideoDts:this.getStreamChangeStart(t[0]):t[e-1].dts,r=t[e].dts,n=Math.abs(i-r)<=1e4;if(this.emit(It.DETECT_CHANGE_STREAM,"video",r),n)return t[e].options?t[e].options.isContinue=!0:t[e].options={isContinue:!0},!1;this.emit(It.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:i,curDts:r});var a,s=t.slice(0,e),o=t.slice(e),u=t[e];return this._videoLargeGap=0,this.videoLastSample=null,this.lastVideoDts=null,a=u.options&&void 0!==u.options.start?u.options.start:i-this.videoDtsBase,this.videoTrack.samples=t.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=t.slice(e),this.doFixVideo(!1,a),this.videoTrack.samples=s.concat(o),!0}},{key:"fixChangeStreamAudio",value:function(e){ze.log(this.TAG,"fixChangeStreamAudio(), changeIdx=",e);var t=this.audioTrack.samples,i=0===e?this.lastAudioDts:t[e-1].dts,r=t[e].dts,n=Math.abs(i-r)<=1e4;if(this.emit(It.DETECT_CHANGE_STREAM,"audio",r),n)return t[e].options?t[e].options.isContinue=!0:t[e].options={isContinue:!0},!1;this.emit(It.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:i,curDts:r}),this._audioLargeGap=0;var a=this.nextAudioDts;this.nextAudioDts=null;var s=t.slice(0,e),o=t.slice(e),u=t[e],l=void 0;return u.options&&void 0!==u.options.start?l=u.options.start:(l=a,u.options.isContinue=!0),this.audioTrack.samples=s,this.doFixAudio(!1),this.audioTrack.samples=o,this.doFixAudio(!1,l),this.audioTrack.samples=s.concat(o),!0}},{key:"getFirstSample",value:function(){var t=this.videoTrack.samples,i=this.audioTrack.samples,r=!1,n=!1;return!this._firstVideoSample&&t.length&&(this._firstVideoSample=e.findFirstVideoSample(t),this.removeInvalidSamples(),r=!0),!this._firstAudioSample&&i.length&&(this._firstAudioSample=e.findFirstAudioSample(i),this.removeInvalidSamples(),n=!0),{isFirstVideoSamples:r,isFirstAudioSamples:n}}},{key:"fixVideoRefSampleDuration",value:function(t,i){if(t){var r=this.allVideoSamplesCount,n=this._firstVideoSample.dts,a=this.filledVideoSamples.length;if(e.isRefSampleDurationValid(t.refSampleDuration)){if(t.refSampleDuration&&i.length>=5){var s=(i[i.length-1].dts-i[0].dts)/(i.length-1);if(s>0&&s<1e3){var o=Math.floor(Math.abs(t.refSampleDuration-s)<=5?t.refSampleDuration:s);e.isRefSampleDurationValid(o)&&(t.refSampleDuration=o)}}}else if(i.length>=1){var u=i[i.length-1].dts,l=Math.floor((u-n)/(r+a-1));e.isRefSampleDurationValid(l)&&(t.refSampleDuration=l)}e.isRefSampleDurationValid(t.refSampleDuration)||(t.refSampleDuration=66)}}},{key:"fixAudioRefSampleDuration",value:function(e){e&&(e.refSampleDuration=1024*e.timescale/e.sampleRate)}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var e=this.audioTrack.samples[0],t=this.videoTrack.samples[0];e&&(this.audioTrack.samples=this.audioTrack.samples.filter((function(t,i){return t===e||t.dts>=e.dts}))),t&&(this.videoTrack.samples=this.videoTrack.samples.filter((function(e,i){return e===t||e.dts>=t.dts})))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"isTs",get:function(){return"ts"===this._format}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}},{key:"audioDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._audioDtsBase?e._audioDtsBase:this.dtsBase}},{key:"videoDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._videoDtsBase?e._videoDtsBase:this.dtsBase}}],[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:[].concat(b(e)).sort((function(e,t){return e.dts-t.dts}))}},{key:"isRefSampleDurationValid",value:function(e){return e&&e>0&&!Number.isNaN(e)}},{key:"findFirstAudioSample",value:function(t){return t&&0!==t.length?e.sortAudioSamples(t)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=[].concat(b(e)).sort((function(e,t){return e.dts-t.dts})),i=0,r=t.length;i<r;i++)if(t[i].isKeyframe)return t[i]}},{key:"detectVideoLargeGap",value:function(e,t,i){if(null!==t){var r=e?1e3:1e4;return t-i>=r||i-t>=r}}},{key:"detectAudioLargeGap",value:function(e,t){if(null!==e)return e-t>=1e3||t-e>=1e3}},{key:"doFixLargeGap",value:function(e,t){for(var i=0,r=e.length;i<r;i++){var n=e[i];n.dts+=t,n.pts&&(n.pts+=t)}var a=e[0];a&&0===a.dts&&(a.dts=a.pts=1)}},{key:"detectChangeStream",value:function(e,t){for(var i=!1,r=[],n=0,a=e.length;n<a;n++){var s=e[n];!s.options||!s.options.meta||t&&0===n||(i=!0,r.push(n))}return{changed:i,changedIdxes:r}}}]),e}(),Ht="function"==typeof Symbol&&"symbol"==s(Symbol.iterator)?function(e){return void 0===e?"undefined":s(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":s(e)},Xt=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],r=!0,n=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(i.push(s.value),!t||i.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw a}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},Wt="function"==typeof Symbol&&"symbol"===Ht(Symbol.iterator)?function(e){return void 0===e?"undefined":Ht(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":Ht(e)},zt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Yt=Xe.DEMUX_EVENTS,qt=Nt.NalUnit,Kt=jt.NalUnitHEVC,Zt={1:["video","MPEG-1"],2:["video","MPEG-2"],27:["video","AVC.H264"],36:["video","HVC.H265"],234:["video","VC-1"],3:["audio","MPEG-1"],4:["audio","MPEG-2"],15:["audio","MPEG-2.AAC"],17:["audio","MPEG-4.AAC"],128:["audio","LPCM"],129:["audio","AC3"],6:["audio","AC3"],130:["audio","DTS"],131:["audio","Dolby TrueHD"],132:["audio","AC3-Plus"],133:["audio","DTS-HD"],134:["audio","DTS-MA"],161:["audio","AC3-Plus-SEC"],162:["audio","DTS-HD-SEC"]},Qt=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.TAG="TsDemuxer",this.configs=Object.assign({},t),this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1,this.gopId=0}return zt(e,[{key:"init",value:function(){this.on(Yt.DEMUX_START,this.demux.bind(this))}},{key:"demux",value:function(t){var i=this;if(t&&ze.log(this.TAG,"do demux: id="+t.id+",demuxing="+this.demuxing),!this.demuxing){for(var r=this.inputBuffer,n={pat:[],pmt:[]},a={};r.length>=188;){for(r.length>=1&&71!==r.array[0][r.offset]&&this.emit(Yt.DEMUX_ERROR,this.TAG,new Error("Untrust sync code: "+r.array[0][r.offset]+", try to recover;"),!1);r.length>=1&&71!==r.array[0][r.offset];)r.shift(1);if(!(r.length<188)){var s=r.shift(188),o=new de(s.buffer),u={};e.read(o,u,n);var l=a[u.header.pid];u.pes?(u.pes.codec=u.header.codec,u.pes.streamType=u.header.streamType,a[u.header.pid]||(a[u.header.pid]=[]),a[u.header.pid].push(u.pes),u.pes.ES.buffer=[u.pes.ES.buffer]):l&&l[l.length-1].ES.buffer.push(u.payload.stream)}}setTimeout((function(){for(var r=Object.assign({},t),n=Object.assign({},t),s=i._hasVideoMeta&&!i._hasAudioMeta,o=i._hasAudioMeta&&!i._hasVideoMeta,u=0;u<Object.keys(a).length;u++)for(var l=a[Object.keys(a)[u]],d=0;d<l.length;d++){var h=l[d];h.id=Object.keys(a)[u],"audio"!==h.type||s||15!==h.streamType&&17!==h.streamType?"video"!==h.type||o||(h.ES.buffer=e.mergeVideoES(h.ES.buffer),"HVC.H265"===h.codec?i.pushVideoSampleHEVC(l[d],n):i.pushVideoSample(l[d],n),n={}):(h.ES.buffer=e.mergeAudioES(h.ES.buffer),i.pushAudioSample(h,r),r={})}var c=i._tracks.videoTrack;c&&!c.meta&&(c.samples=[],ze.warn(i.TAG,"no sps detected"))})),setTimeout((function(){i.emit(Yt.DEMUX_COMPLETE)}))}}},{key:"pushAudioSample",value:function(t,i){var r,n=void 0;this._tracks&&this._tracks.audioTrack||(this._tracks.audioTrack=new fe),n=this._tracks.audioTrack;var a=new ve({audioSampleRate:t.ES.frequence,sampleRate:t.ES.frequence,channelCount:t.ES.channel,codec:"mp4a.40."+t.ES.audioObjectType,originCodec:"mp4a.40."+t.ES.originAudioObjectType,originObjectType:t.ES.originAudioObjectType,config:t.ES.audioConfig,id:2,sampleRateIndex:t.ES.frequencyIndex});a.refSampleDuration=Math.floor(1024/a.audioSampleRate*a.timescale);var s=e.compaireMeta(n.meta,a,!0);this._hasAudioMeta&&s||(n.meta=a,this._hasAudioMeta=!0,i?i.meta=Object.assign({},a):i={meta:Object.assign({},a)},this.emit(Yt.METADATA_PARSED,"audio"));var o=0,u=[];t.ES.buffer.skip(t.pesHeaderLength+9);for(var l=!1;t.ES.buffer.position<t.ES.buffer.length;)if(Ft.isHeader(new Uint8Array(t.ES.buffer.buffer),t.ES.buffer.position)&&t.ES.buffer.position+5<t.ES.buffer.length){var d=Ft.appendFrame(n,new Uint8Array(t.ES.buffer.buffer),t.ES.buffer.position,t.pts,o);if(!d||!d.sample)break;t.ES.buffer.skip(d.length);var h=new me({dts:d.sample.dts,pts:d.sample.pts,data:d.sample.unit,options:l?{}:i});i.meta&&(l=!0),u.push(h),o++}else t.ES.buffer.skip(1);for(var c=0;c<u.length;c++){var f=u[c];f.dts=f.pts=Math.ceil(f.pts/90)}(r=n.samples).push.apply(r,u)}},{key:"pushVideoSample",value:function(t,i){var r=qt.getNalunits(t.ES.buffer),n=void 0,a=new _e;this._tracks&&this._tracks.videoTrack||(this._tracks.videoTrack=new ye),n=this._tracks.videoTrack;for(var s=0,o=!1,u=!1,l=null,d=0;d<r.length;d++){var h=r[d];if(h.sps){o=h,n.sps=h.body,a.sps=h.body,a.chromaFormat=o.sps.chroma_format,a.codec="avc1.";for(var c=1;c<4;c++){var f=o.body[c].toString(16);f.length<2&&(f="0"+f),a.codec+=f}a.codecHeight=o.sps.codec_size.height,a.codecWidth=o.sps.codec_size.width,a.frameRate=o.sps.frame_rate,a.id=1,a.level=o.sps.level_string,a.presentHeight=o.sps.present_size.height,a.presentWidth=o.sps.present_size.width,a.profile=o.sps.profile_string,a.refSampleDuration=Math.floor(a.timescale*(o.sps.frame_rate.fps_den/o.sps.frame_rate.fps_num)),a.sarRatio=o.sps.sar_ratio?o.sps.sar_ratio:o.sps.par_ratio}else h.pps?(n.pps=h.body,a.pps=h.body,u=h):h.sei?l=h.sei:h.type<9&&(s+=4+h.body.byteLength)}if(o&&u){a.avcc=qt.getAvcc(o.body,u.body);var p=e.compaireMeta(n.meta,a,!0);this._hasVideoMeta&&p||(i?i.meta=Object.assign({},a):i={meta:Object.assign({},a)},n.meta=a,this._hasVideoMeta=!0,this.emit(Yt.METADATA_PARSED,"video"))}for(var y=new Uint8Array(s),v=0,_=!1,m=0;m<r.length;m++){var g=r[m];if(!(g.type&&g.type>=9)){var E=g.body.byteLength;g.idr&&(_=!0),g.pps||g.sps||g.sei||(y.set(new Uint8Array([E>>>24&255,E>>>16&255,E>>>8&255,255&E]),v),v+=4,y.set(g.body,v),v+=E)}}var b=parseInt(t.dts/90),T=parseInt(t.pts/90);l&&(l.dts=b,this.emit(Yt.SEI_PARSED,l));var k=new ge({dts:b,pts:T,cts:T-b,originDts:t.dts,isKeyframe:_,data:y,nals:r,options:i,isGop:_,gopId:_?++this.gopId:this.gopId});n.samples.push(k)}},{key:"pushVideoSampleHEVC",value:function(t,i){var r=Kt.getNalunits(t.ES.buffer),n=void 0,a=new _e;a.streamType=36,this._tracks.videoTrack||(this._tracks.videoTrack=new ye),n=this._tracks.videoTrack;for(var s=0,o=!1,u=!1,l=!1,d=null,h=!1,c=!1,f=!1,p=!1,y=0;y<r.length;y++){var v=r[y];if(v.vps){if(h)continue;h=!0}else if(v.sps){if(c)continue;c=!0}else if(v.pps){if(f)continue;f=!0}else if(v.key)20!==v.type&&19!==v.type||(p=!0);else if(0===v.type);else if(35===v.type)continue;v.sps?(u=v,n.sps=v.body,a.sps=v.body,a.presentWidth=u.sps.width,a.presentHeight=u.sps.height,a.general_profile_space=u.sps.general_profile_space,a.general_tier_flag=u.sps.general_tier_flag,a.general_profile_idc=u.sps.general_profile_idc,a.general_level_idc=u.sps.general_level_idc,a.codec="hev1.1.6.L93.B0",a.chromaFormatIdc=u.sps.chromaFormatIdc,a.bitDepthLumaMinus8=u.sps.bitDepthLumaMinus8,a.bitDepthChromaMinus8=u.sps.bitDepthChromaMinus8):v.pps?(n.pps=v.body,a.pps=v.body,l=v):v.vps?(n.vps=v.body,a.vps=v.body,o=v):v.sei&&(d=v.sei),v.type<=40&&(s+=4+v.body.byteLength)}if(u&&l&&o){var _=e.compaireMeta(n.meta,a,!0);this._hasVideoMeta&&_||(i?i.meta=Object.assign({},a):i={meta:Object.assign({},a)},a.streamType=36,this._tracks.videoTrack.meta=a,this._hasVideoMeta=!0,this.emit(Yt.METADATA_PARSED,"video"))}var m=new Uint8Array(s),g=0,E=!1;h=!1,c=!1,f=!1;for(var b=0;b<r.length;b++){var T=r[b];if(!(T.type&&T.type>40)){if(T.vps){if(h)continue;h=!0}else if(T.sps){if(c)continue;c=!0}else if(T.pps){if(f)continue;f=!0}else if(T.key);else if(0===T.type);else if(35===T.type)continue;var k=T.body.byteLength;T.key&&(E=!0),m.set(new Uint8Array([k>>>24&255,k>>>16&255,k>>>8&255,255&k]),g),g+=4,m.set(T.body,g),g+=k}}var S=parseInt(t.dts/90),A=parseInt(t.pts/90);d&&(d.dts=S,this.emit(Yt.SEI_PARSED,d));var w=new ge({dts:S,pts:A,cts:A-S,originDts:t.dts,isKeyframe:E,data:m,nals:r,options:i,isGop:p,gopId:p?++this.gopId:this.gopId});n.samples.push(w)}},{key:"destory",value:function(){this.off(Yt.DEMUX_START,this.demux),this.configs={},this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1}},{key:"inputBuffer",get:function(){return this._context.getInstance(this.configs.inputbuffer)}},{key:"_tracks",get:function(){return this._context.getInstance("TRACKS")}}],[{key:"compaireArray",value:function(e,t,i){var r=0,n=0;if("Uint8Array"===i?(r=e.byteLength,n=t.byteLength):"Array"===i&&(r=e.length,n=t.length),r!==n)return!1;for(var a=0;a<r;a++)if(e[a]!==t[a])return!1;return!0}},{key:"compaireMeta",value:function(t,i,r){if(!t||!i)return!1;for(var n=0,a=Object.keys(t).length;n<a;n++){var s=t[Object.keys(t)[n]],o=i[Object.keys(t)[n]];if(!s&&!o)return!0;if(void 0===s&&o||s&&void 0===o)return!1;if("object"!==(void 0===s?"undefined":Wt(s))){if(r&&"duration"!==Object.keys(t)[n]&&"refSampleDuration"!==Object.keys(t)[n]&&"refSampleDurationFixed"!==Object.keys(t)[n]&&s!==o)return!1}else if(void 0!==s.byteLength){if(void 0===o.byteLength)return!1;if(!e.compaireArray(s,o,"Uint8Array"))return!1}else if(void 0!==s.length){if(void 0===o.length)return!1;if(!e.compaireArray(s,o,"Array"))return!1}else if(!e.compaireMeta(s,o))return!1}return!0}},{key:"mergeVideoES",value:function(e){for(var t=void 0,i=0,r=0,n=0;n<e.length;n++)i+=e[n].length-e[n].position;t=new Uint8Array(i);for(var a=0;a<e.length;a++){var s=e[a];t.set(new Uint8Array(s.buffer,s.position),r),r+=s.length-s.position}return new de(t.buffer)}},{key:"mergeAudioES",value:function(e){for(var t=void 0,i=0,r=0,n=0;n<e.length;n++)i+=e[n].length;t=new Uint8Array(i);for(var a=0;a<e.length;a++){var s=e[a];t.set(new Uint8Array(s.buffer),r),r+=s.length}return new de(t.buffer)}},{key:"read",value:function(t,i,r){e.readHeader(t,i),e.readPayload(t,i,r),"MEDIA"!==i.header.packet||1!==i.header.payload||i.unknownPIDs||(i.pes=e.PES(i))}},{key:"readPayload",value:function(t,i,r){var n=i.header.pid;switch(n){case 0:e.PAT(t,i,r);break;case 1:e.CAT(t,i,r);break;case 2:e.TSDT(t,i,r);break;case 8191:break;default:for(var a=!1,s=0,o=r.pat.length;s<o;s++)if(r.pat[s].pid===n){a=!0;break}if(a)e.PMT(t,i,r);else{for(var u=[],l=0,d=r.pmt.length;l<d;l++)if(r.pmt[l].pid===n){u.push(r.pmt[l]);break}if(u.length>0){var h=u[0].streamType;e.Media(t,i,h)}else i.unknownPIDs=!0}}}},{key:"readHeader",value:function(e,t){var i={};i.sync=e.readUint8();var r=e.readUint16();i.error=r>>>15,i.payload=r>>>14&1,i.priority=r>>>13&1,i.pid=8191&r,r=e.readUint8(),i.scrambling=r>>6&3,i.adaptation=r>>4&3,i.continuity=15&r,i.packet=0===i.pid?"PAT":"MEDIA",t.header=i}},{key:"PAT",value:function(e,t,i){var r={},n=e.readUint8();e.skip(n),n=e.readUint8(),r.tabelID=n,n=e.readUint16(),r.error=n>>>7,r.zero=n>>>6&1,r.sectionLength=4095&n,r.streamID=e.readUint16(),r.current=1&e.readUint8(),r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8();for(var a=(r.sectionLength-9)/4,s=[],o=0;o<a;o++){var u=e.readUint16(),l=8191&e.readUint16();s.push({program:u,pid:l,type:0===u?"network":"mapPID"})}s.length>0&&(i.pat=i.pat.concat(s)),r.list=s,r.program=e.readUint16(),r.pid=8191&e.readUint16(),t.payload=r}},{key:"PMT",value:function(e,t,i){var r={};t.header.packet="PMT";var n=e.readUint8();e.skip(n),n=e.readUint8(),r.tableID=n,n=e.readUint16(),r.sectionLength=4095&n,r.program=e.readUint16(),r.current=1&e.readUint8(),r.order=e.readUint8(),r.lastOrder=e.readUint8(),r.PCR_PID=8191&e.readUint16(),r.programLength=4095&e.readUint16();for(var a=(r.sectionLength-13)/5,s=[],o=0;o<a;o++)s.push({streamType:e.readUint8(),pid:8191&e.readUint16(),es:4095&e.readUint16()});r.list=s,this.pmt||(this.pmt=[]),i.pmt=this.pmt.concat(s.map((function(e){return{pid:e.pid,es:e.es,streamType:e.streamType,program:r.program}}))),t.payload=r}},{key:"Media",value:function(e,t,i){var r=t.header,n={},a=Xt(Zt[i],2),s=a[0],o=a[1];if(r.streamType=i,r.type=s,r.codec=o,3===r.adaptation&&(n.adaptationLength=e.readUint8(),n.adaptationLength>0)){var u=e.readUint8();n.discontinue=u>>>7,n.access=u>>>6&1,n.priority=u>>>5&1,n.PCR=u>>>4&1,n.OPCR=u>>>3&1,n.splicePoint=u>>>2&1,n.transportPrivate=u>>>1&1,n.adaptationField=1&u;var l=e.position;if(1===n.PCR&&(n.programClockBase=e.readUint32()<<1,u=e.readUint16(),n.programClockBase|=u>>>15,n.programClockExtension=511&u),1===n.OPCR&&(n.originProgramClockBase=e.readUint32()<<1,u=e.readUint16(),n.originProgramClockBase+=u>>>15,n.originProgramClockExtension=511&u),1===n.splicePoint&&(n.spliceCountdown=e.readUint8()),1===n.transportPrivate)for(var d=e.readUint8(),h=[],c=0;c<d;c++)h.push(e.readUint8());if(1===n.adaptationField){var f=e.readUint8(),p=e.readUint8(),y=e.position,v=p>>>6&1,_=p>>>5&1;1==p>>>7&&(p=e.readUint16(),n.ltwValid=p>>>15,n.ltwOffset=61439&p),1===v&&(p=e.readUint24(),n.piecewiseRate=4194303&p),1===_&&(p=e.readInt8(),n.spliceType=p>>>4,n.dtsNextAU1=p>>>1&7,n.marker1=1&p,p=e.readUint16(),n.dtsNextAU2=p>>>1,n.marker2=1&p,p=e.readUint16(),n.dtsNextAU3=p),e.skip(f-1-(e.position-y))}var m=n.adaptationLength-1-(e.position-l);e.skip(m)}n.stream=new de(e.buffer.slice(e.position)),t.payload=n}},{key:"PES",value:function(t){var i={},r=t.payload.stream;if(1!==r.readUint24())i.ES={},i.ES.buffer=r;else{var n=r.readUint8();n>=224&&n<=239&&(i.type="video"),n>=192&&n<=223&&(i.type="audio");var a=r.readUint16();if(i.packetLength=a,"video"!==i.type&&"audio"!==i.type)throw new Error("format is not supported");var s=r.readUint8();if(2!=s>>>6)throw new Error("error when parse pes header");s=r.readUint8(),i.ptsDTSFlag=s>>>6,i.escrFlag=s>>>5&1,i.esRateFlag=s>>>4&1,i.dsmFlag=s>>>3&1,i.additionalFlag=s>>>2&1,i.crcFlag=s>>>1&1,i.extensionFlag=1&s,i.pesHeaderLength=r.readUint8();var o=i.pesHeaderLength;if(2===i.ptsDTSFlag){var u=[];s=r.readUint8(),u.push(s>>>1&7),s=r.readUint16(),u.push(s>>>1),s=r.readUint16(),u.push(s>>>1),i.pts=u[0]<<30|u[1]<<15|u[2],o-=5,"video"===i.type&&(i.dts=i.pts)}if(3===i.ptsDTSFlag){var l=[];s=r.readUint8(),l.push(s>>>1&7),s=r.readUint16(),l.push(s>>>1),s=r.readUint16(),l.push(s>>>1),i.pts=l[0]<<30|l[1]<<15|l[2];var d=[];s=r.readUint8(),d.push(s>>>1&7),s=r.readUint16(),d.push(s>>>1),s=r.readUint16(),d.push(s>>>1),i.dts=d[0]<<30|d[1]<<15|d[2],o-=10}if(1===i.escrFlag){var h=[],c=[];s=r.readUint8(),h.push(s>>>3&7),h.push(3&s),s=r.readUint16(),h.push(s>>>13),h.push(3&s),s=r.readUint16(),h.push(s>>>13),c.push(3&s),s=r.readUint8(),c.push(s>>>1),i.escr=300*(h[0]<<30|h[1]<<28|h[2]<<15|h[3]<<13|h[4])+(c[0]<<7|c[1]),o-=6}if(1===i.esRateFlag&&(s=r.readUint24(),i.esRate=s>>>1&4194303,o-=3),1===i.dsmFlag)throw new Error("not support DSM_trick_mode");if(1===i.additionalFlag&&(s=r.readUint8(),i.additionalCopyInfo=127&s,o-=1),1===i.crcFlag&&(i.pesCRC=r.readUint16(),o-=2),1===i.extensionFlag)throw new Error("not support extension");o>0&&r.skip(o),i.ES=e.ES(r,i.type,t.header.streamType)}return i}},{key:"ES",value:function(t,i,r){var n={};if("video"===i)n.buffer=t;else{if("audio"!==i)throw new Error("ES "+i+" is not supported");15!==r&&17!==r||(n=e.parseADTSHeader(t)),n.buffer=t}return n}},{key:"parseADTSHeader",value:function(t){var i={},r=t.readUint16();if(r>>>4!=4095)throw new Error("aac ES parse Error");return i.id=0==(r>>>3&1)?"MPEG-4":"MPEG-2",i.layer=r>>>1&3,i.absent=1&r,r=t.readUint16(),i.audioObjectType=1+(r>>>14&3),i.profile=i.audioObjectType-1,i.frequencyIndex=r>>>10&15,i.frequence=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][i.frequencyIndex],i.channel=r>>>6&7,i.frameLength=(3&r)<<11|t.readUint16()>>>5,e.getAudioConfig(i),t.skip(1),i.buffer=t,i}},{key:"TSDT",value:function(e,t,i){t.payload={}}},{key:"CAT",value:function(e,t,i){var r={};r.tableID=e.readUint8();var n=e.readUint16();r.sectionIndicator=n>>>7,r.sectionLength=4095&n,e.skip(2),n=e.readUint8(),r.version=n>>>3,r.currentNextIndicator=1&n,r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8(),this.sectionLength,r.crc32=e.readUint32(),t.payload=r}},{key:"getAudioConfig",value:function(e){var t=navigator.userAgent.toLowerCase(),i=void 0,r=void 0;e.originAudioObjectType=e.audioObjectType,/firefox/i.test(t)?e.frequencyIndex>=6?(e.audioObjectType=5,i=new Array(4),r=e.frequencyIndex-3):(e.audioObjectType=2,i=new Array(2),r=e.frequencyIndex):-1!==t.indexOf("android")?(e.audioObjectType=2,i=new Array(2),r=e.frequencyIndex):(e.audioObjectType=5,i=new Array(4),e.frequencyIndex>=6?r=e.frequencyIndex-3:(1===e.channel&&(e.audioObjectType=2,i=new Array(2)),r=e.frequencyIndex)),i[0]=e.audioObjectType<<3,i[0]|=(14&e.frequencyIndex)>>1,i[1]=(1&e.frequencyIndex)<<7,i[1]|=e.channel<<3,5===e.audioObjectType&&(i[1]|=(14&r)>>1,i[2]=(1&r)<<7,i[2]|=8,i[3]=0),e.audioConfig=i}}]),e}(),$t=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Jt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return $t(e,null,[{key:"parse",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r={duration:0};if(t&&t.split){var n=t.split(/\r|\n/),a=(n=n.filter((function(e){return e}))).shift();if(!a.match("#EXTM3U"))throw new Error('Invalid m3u8 file: not "#EXTM3U"');a=n.shift();for(var s=!1,o=0;a;){var u=a.match(/#(.[A-Z|-]*):(.*)/),l=a.match(/#(.[A-Z|-]*)/);if(l&&u&&u.length>2)switch(u[1]){case"EXT-X-VERSION":r.version=parseInt(u[2]);break;case"EXT-X-MEDIA-SEQUENCE":r.sequence=parseInt(u[2]);break;case"EXT-X-TARGETDURATION":r.targetduration=parseFloat(u[2]);break;case"EXTINF":o=e.parseFrag(u,n,r,i,s,o),s=!1;break;case"EXT-X-KEY":e.parseDecrypt(u[2],r)}if(l&&l.length>1)switch(l[1]){case"EXT-X-DISCONTINUITY":s=!0}a=n[o++]}return r}}},{key:"parseFrag",value:function(t,i,r,n,a,s){r.frags||(r.frags=[]);var o={start:r.duration,duration:parseInt(1e3*parseFloat(t[2]))};r.duration+=o.duration;var u=i[s++];if((u.match(/#(.*):(.*)/)||u.match(/^#/))&&(u=i[s++]),u.length>0&&"/"===u.charAt(0)&&n.match(/.*\/\/.*\.\w+/g)&&(n=n.match(/.*\/\/.*\.\w+/g)[0]),u.match(/.*:\/\/.*/)){var l=e.isHTTPS;!e.envisHttps&&!(e.envisHttps=l(window.location.href))||l(u)||(u=u.replace("http:","https:")),o.url=u}else o.url=n+u;if(o.discontinue=a,r.frags.length){var d=r.frags[r.frags.length-1];o.id=d.id+1}else o.id=r.sequence||1;return r.frags.push(o),s}},{key:"parseURL",value:function(e){var t="",i=e.match(/(.*\/).*\.m3u8/);if(i&&i.length>0)for(var r=0;r<i.length;r++)i[r].match(/.*\/$/g)&&i[r].length>t.length&&(t=i[r]);return t}},{key:"parseDecrypt",value:function(e,t){t.encrypt={};var i=e.split(",");for(var r in i){var n=i[r];if(n.match(/METHOD=(.*)/)&&(t.encrypt.method=n.match(/METHOD=(.*)/)[1]),n.match(/URI="(.*)"/)&&(t.encrypt.uri=n.match(/URI="(.*)"/)[1]),n.match(/IV=0x(.*)/)){var a=n.match(/IV=0x(.*)/)[1],s=Math.ceil(a.length/2);t.encrypt.ivb=new Uint8Array(s);for(var o=s-1;o>=0;o--){var u=parseInt(a.substr(2*o,2),16);t.encrypt.ivb[o]=u}t.encrypt.iv=a}}}},{key:"isHTTPS",value:function(e){return/^https:\/\//i.test(e)}}]),e}(),ei=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];var a=!0,s=!1,o=void 0;try{for(var u,l=r[Symbol.iterator]();!(a=(u=l.next()).done);a=!0)t+=u.value.length}catch(e){s=!0,o=e}finally{try{!a&&l.return&&l.return()}finally{if(s)throw o}}var d=new e(t),h=0,c=!0,f=!1,p=void 0;try{for(var y,v=r[Symbol.iterator]();!(c=(y=v.next()).done);c=!0){var _=y.value;d.set(_,h),h+=_.length}}catch(e){f=!0,p=e}finally{try{!c&&v.return&&v.return()}finally{if(f)throw p}}return d}}));T(ei);var ti=T(k((function(e){var t=function(e){return e&&e.__esModule?e:{default:e}}(ei);e.exports=t.default}))),ii=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ri=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.buffer=t||new Uint8Array(0)}return ii(e,[{key:"write",value:function(){for(var e=this,t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];i.forEach((function(t){e.buffer=ti(Uint8Array,e.buffer,t)}))}}],[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){var t="";return e.forEach((function(e){t+=function(e){return e.toString(16).padStart(2,"0")}(e)})),parseInt(t,16)}}]),e}(),ni=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ai=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return ni(e,null,[{key:"size",value:function(e){return ri.writeUint32(e)}},{key:"initBox",value:function(t,i){for(var r=new ri,n=arguments.length,a=Array(n>2?n-2:0),s=2;s<n;s++)a[s-2]=arguments[s];return r.write.apply(r,[e.size(t),e.type(i)].concat(a)),r.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"ftypHEVC",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,100,97,115,104]))}},{key:"moov",value:function(t){var i=t.type,r=t.meta,n=8,a=e.mvhd(r.duration,r.timescale),s=void 0;s="video"===i?e.videoTrak(r):e.audioTrak(r);var o=e.mvex(r.duration,r.timescale||1e3,r.id);return[a,s,o].forEach((function(e){n+=e.byteLength})),e.initBox(n,"moov",a,s,o)}},{key:"mvhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,r=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.initBox(8+r.length,"mvhd",new Uint8Array(r))}},{key:"videoTrak",value:function(t){var i=8,r=e.tkhd({id:1,duration:t.duration,timescale:t.timescale||1e3,width:t.presentWidth,height:t.presentHeight,type:"video"}),n=e.mdia({type:"video",timescale:t.timescale||1e3,duration:t.duration,avcc:t.avcc,parRatio:t.parRatio,width:t.presentWidth,height:t.presentHeight,streamType:t.streamType});return[r,n].forEach((function(e){i+=e.byteLength})),e.initBox(i,"trak",r,n)}},{key:"audioTrak",value:function(t){var i=8,r=e.tkhd({id:2,duration:t.duration,timescale:t.timescale||1e3,width:0,height:0,type:"audio"}),n=e.mdia({type:"audio",timescale:t.timescale||1e3,duration:t.duration,channelCount:t.channelCount,samplerate:t.sampleRate,config:t.config});return[r,n].forEach((function(e){i+=e.byteLength})),e.initBox(i,"trak",r,n)}},{key:"tkhd",value:function(t){var i=t.id,r=t.duration,n=t.width,a=t.height,s=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>>8&255,255&n,0,0,a>>>8&255,255&a,0,0]);return e.initBox(8+s.byteLength,"tkhd",s)}},{key:"edts",value:function(t){var i=new ri,r=t.duration,n=t.mediaTime;return i.write(e.size(36),e.type("edts")),i.write(e.size(28),e.type("elst")),i.write(new Uint8Array([0,0,0,1,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,0,0,0,1])),i.buffer}},{key:"mdia",value:function(t){var i=8,r=e.mdhd(t.timescale,t.duration),n=e.hdlr(t.type),a=e.minf(t);return[r,n,a].forEach((function(e){i+=e.byteLength})),e.initBox(i,"mdia",r,n,a)}},{key:"mdhd",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,i=arguments[1],r=new Uint8Array([0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]);return e.initBox(12+r.byteLength,"mdhd",e.extension(0,0),r)}},{key:"hdlr",value:function(t){var i=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(i.splice.apply(i,[8,4].concat([115,111,117,110])),i.splice.apply(i,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),e.initBox(8+i.length,"hdlr",new Uint8Array(i))}},{key:"minf",value:function(t){var i=8,r="video"===t.type?e.vmhd():e.smhd(),n=e.dinf(),a=e.stbl(t);return[r,n,a].forEach((function(e){i+=e.byteLength})),e.initBox(i,"minf",r,n,a)}},{key:"vmhd",value:function(){return e.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return e.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var t=new ri;return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1])),t.buffer}},{key:"stbl",value:function(t){var i=8,r=e.stsd(t),n=e.stts(),a=e.stsc(),s=e.stsz(),o=e.stco();return[r,n,a,s,o].forEach((function(e){i+=e.byteLength})),e.initBox(i,"stbl",r,n,a,s,o)}},{key:"stsd",value:function(t){var i;return i="audio"===t.type?e.mp4a(t):36===t.streamType?e.hvc1(t):e.avc1(t),e.initBox(16+i.byteLength,"stsd",e.extension(0,0),new Uint8Array([0,0,0,1]),i)}},{key:"mp4a",value:function(t){var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),r=e.esds(t.config);return e.initBox(8+i.byteLength+r.byteLength,"mp4a",i,r)}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],i=t.length,r=new ri,n=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return r.write(e.size(8+n.byteLength),e.type("esds"),n),r.buffer}},{key:"avc1",value:function(t){var i=new ri,r=t.width,n=t.height,a=t.parRatio.height,s=t.parRatio.width,o=t.avcc,u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r>>8&255,255&r,n>>8&255,255&n,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),d=new Uint8Array([a>>24,a>>16&255,a>>8&255,255&a,s>>24,s>>16&255,s>>8&255,255&s]);return i.write(e.size(40+u.byteLength+o.byteLength+l.byteLength),e.type("avc1"),u,e.size(8+o.byteLength),e.type("avcC"),o,e.size(20),e.type("btrt"),l,e.size(16),e.type("pasp"),d),i.buffer}},{key:"hvc1",value:function(t){var i=new ri,r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255,0,0,0,122,104,118,99,67,1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64]);return i.write(e.size(8+r.byteLength+10),e.type("hvc1"),r,e.size(10),e.type("fiel"),new Uint8Array([1,0])),i.buffer}},{key:"stts",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stts",t)}},{key:"stsc",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stsc",t)}},{key:"stco",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stco",t)}},{key:"stsz",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return e.initBox(20,"stsz",t)}},{key:"mvex",value:function(t){var i=arguments[2],r=new ri,n=ri.writeUint32(t);return r.write(e.size(56),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),n,e.trex(i)),r.buffer}},{key:"trex",value:function(t){var i=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.initBox(8+i.byteLength,"trex",i)}},{key:"moof",value:function(t){var i=8,r=e.mfhd(),n=e.traf(t);return[r,n].forEach((function(e){i+=e.byteLength})),e.initBox(i,"moof",r,n)}},{key:"mfhd",value:function(){var t=ri.writeUint32(e.sequence);return e.sequence+=1,e.initBox(16,"mfhd",e.extension(0,0),t)}},{key:"traf",value:function(t){var i=8,r=e.tfhd(t.id),n=e.tfdt(t.time),a=e.sdtp(t),s=e.trun(t,a.byteLength);return[r,n,s,a].forEach((function(e){i+=e.byteLength})),e.initBox(i,"traf",r,n,s,a)}},{key:"tfhd",value:function(t){var i=ri.writeUint32(t);return e.initBox(16,"tfhd",e.extension(0,0),i)}},{key:"tfdt",value:function(t){return e.initBox(16,"tfdt",e.extension(0,0),ri.writeUint32(t))}},{key:"trun",value:function(t,i){var r=new ri,n=ri.writeUint32(t.samples.length),a=ri.writeUint32(92+16*t.samples.length+i);return r.write(e.size(20+16*t.samples.length),e.type("trun"),new Uint8Array([0,0,15,1]),n,a),t.samples.forEach((function(e){var t=e.flags;r.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))})),r.buffer}},{key:"sdtp",value:function(t){var i=new ri;return i.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach((function(e){var t=e.flags,r=t.isLeading<<6|t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;i.write(new Uint8Array([r]))})),i.buffer}},{key:"mdat",value:function(t){var i=new ri,r=8;t.samples.forEach((function(e){r+=e.size})),i.write(e.size(r),e.type("mdat"));var n=new Uint8Array(r),a=0;return n.set(i.buffer,a),a+=8,t.samples.forEach((function(e){e.buffer.forEach((function(e){n.set(e,a),a+=e.byteLength}))})),n}}]),e}();ai.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},ai.sequence=1;var si=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),oi=Xe.REMUX_EVENTS,ui=Xe.PLAYER_EVENTS,li=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;S(this,e),this.TAG="Mp4Remuxer",this._dtsBase=1e3*t,this._audioDtsBase=null,this._videoDtsBase=null,this._isDtsBaseInited=!1;var i=He.browser;this._fillSilenceFrame="ie"===i,this.isFirstVideo=!0,this.isFirstAudio=!0,this.videoAllDuration=0,this.audioAllDuration=0,this.audioRemuxed=0,this.videoRemuxed=0}return si(e,[{key:"init",value:function(){this.on(oi.REMUX_MEDIA,this.remux.bind(this)),this.on(oi.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on(oi.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this)),this.on(oi.DETECT_FRAG_ID_DISCONTINUE,this.seek.bind(this)),this.on(ui.SEEK,this.seek.bind(this))}},{key:"destroy",value:function(){this._dtsBase=-1,this._isDtsBaseInited=!1}},{key:"remux",value:function(){var e=this._context.getInstance("TRACKS"),t=e.audioTrack,i=e.videoTrack;!this._isDtsBaseInited&&this.calcDtsBase(t,i),this._remuxVideo(i),this._remuxAudio(t),ze.groupEnd()}},{key:"resetDtsBase",value:function(){this._dtsBase=0}},{key:"seek",value:function(e){ze.log(this.TAG,"set dtsBase for seek(),time=",e),this._isDtsBaseInited?(this._isDtsBaseInited=!1,this._dtsBase=1e3*e):this._dtsBase=1e3*e,this._audioDtsBase=this._videoDtsBase=null}},{key:"onMetaDataReady",value:function(e){var t;t="audio"===e?this._context.getInstance("TRACKS").audioTrack:this._context.getInstance("TRACKS").videoTrack;var i=this._context.getInstance("PRE_SOURCE_BUFFER"),r=i.getSource(e);r||(r=i.createSource(e)),r.mimetype=t.meta.codec,r.init=this.remuxInitSegment(e,t.meta),this.emit(oi.INIT_SEGMENT,e)}},{key:"remuxInitSegment",value:function(e,t){ze.log(this.TAG,"remuxInitSegment: type=",e);var i=new ri,r=36===t.streamType?ai.ftypHEVC():ai.ftyp(),n=ai.moov({type:e,meta:t});return i.write(r,n),i}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length){var i=t.samples[0],r=void 0;return i.options&&i.options.start&&(r=i.options.start),this._videoDtsBase=i.dts-(r||this._dtsBase),void(this._isDtsBaseInited=!0)}if(e&&e.samples.length||t&&t.samples.length){var n=null,a=null,s=null;if(e&&e.samples&&e.samples.length){var o=e.samples[0];n=o.dts,o.options&&o.options.start&&(s=o.options.start)}if(t&&t.samples&&t.samples.length){var u=t.samples[0];a=u.dts,u.options&&u.options.start&&(s=u.options.start)}this._videoDtsBase=(a||n)-(s||this._dtsBase),this._audioDtsBase=(n||a)-(s||this._dtsBase),this._dtsBase=Math.min(a,n),this._isDtsBaseInited=!0,ze.log(this.TAG,"calcDtsBase"),ze.log(this.TAG,"video first dts: "+a+" , start:"+s+" , _videoDtsBase:"+this._videoDtsBase+" , _dtsBase:"+this._dtsBase),ze.log(this.TAG,"audio first dts: "+n+" , start:"+s+" , _audioDtsBase:"+this._audioDtsBase+", _dtsBase:"+this._dtsBase)}}},{key:"_remuxVideo",value:function(e){var t=e||{};if(e&&e.samples&&e.samples.length){for(var i=t.samples,r=-1,n=null,a=[],s={samples:[]},o=1e4;i.length&&o-- >0;){var u=i.shift(),l=u.isKeyframe,d=u.options;if(!this.isFirstVideo&&d&&d.meta){n=this.remuxInitSegment("video",d.meta),d.meta=null,i.unshift(u),d.isContinue||(this._videoDtsBase=0);break}var h=Math.max(0,u.dts-this.videoDtsBase);-1===r&&(r=h);var c=void 0,f=void 0;void 0!==u.pts&&(c=(f=u.pts-this._dtsBase)-h),void 0!==u.cts&&(f=u.cts+h,c=u.cts);var p,y={buffer:[],size:0};p=u.duration?u.duration:i.length>=1?i[0].dts-this.videoDtsBase-h:a.length>=1?a[a.length-1].duration:this.videoMeta.refSampleDuration,this.videoAllDuration+=p,ze.long&&ze.log(this.TAG,"video dts "+h,"pts "+f,"cts: "+c,l,"originDts "+u.originDts,"duration "+p),p>=0&&(s.samples.push(y),y.buffer.push(u.data),y.size+=u.data.byteLength,a.push({dts:h,cts:Math.abs(c)>2e3?p:c,pts:f,data:u.data,size:u.data.byteLength,isKeyframe:l,duration:p,flags:{isLeading:0,dependsOn:l?2:1,isDependedOn:l?1:0,hasRedundancy:0,isNonSync:l?0:1},originDts:h,type:"video"})),l&&this.emit(oi.RANDOM_ACCESS_POINT,f)}a.length&&ze.log(this.TAG,"remux to mp4 video:",[r/1e3,a[a.length-1].dts/1e3]);var v=new ri;if(a.length){var _=ai.moof({id:t.meta.id,time:r,samples:a}),m=ai.mdat(s);v.write(_,m),this.writeToSource("video",v,a[a.length-1].pts-a[0].pts)}if(n&&(this.writeToSource("video",n),i.length))return t.samples=i,this._remuxVideo(t);this.isFirstVideo=!1,this.emit(oi.MEDIA_SEGMENT,"video"),t.samples=[],t.length=0}}},{key:"_remuxAudio",value:function(e){var t=(e||{}).samples,i=-1,r=[],n=null,a={samples:[]};if(t&&t.length){for(var s=1e4,o=!1;t.length&&s-- >0;){var u=t.shift(),l=u.data,d=u.options;if(!this.isFirstAudio&&d&&d.meta){n=this.remuxInitSegment("audio",d.meta),d.meta=null,t.unshift(u),d.isContinue||(this._audioDtsBase=0);break}var h=Math.max(0,u.dts-this.audioDtsBase),c=u.originDts;o||(i=h,o=!0);var f;f=u.duration?u.duration:this.audioMeta.refSampleDurationFixed?this.audioMeta.refSampleDurationFixed:t.length>=1?t[0].dts-this.audioDtsBase-h:r.length>=1?r[r.length-1].duration:this.audioMeta.refSampleDuration,ze.long&&ze.log(this.TAG,"audio dts "+h,"pts "+h,"originDts "+c,"duration "+f),this.audioAllDuration+=f;var p={dts:h,pts:h,cts:0,size:l.byteLength,duration:u.duration?u.duration:f,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:c,type:"audio"},y={buffer:[],size:0};f>=0&&(y.buffer.push(l),y.size+=l.byteLength,a.samples.push(y),r.push(p))}var v=new ri;if(r.length){ze.log(this.TAG,"remux to mp4 audio:",[i/1e3,r[r.length-1].dts/1e3]);var _=ai.moof({id:e.meta.id,time:i,samples:r}),m=ai.mdat(a);v.write(_,m),this.writeToSource("audio",v,r[r.length-1].dts-r[0].dts)}if(n&&(this.writeToSource("audio",n),t.length))return e.samples=t,this._remuxAudio(e);this.isFirstAudio=!1,this.emit(oi.MEDIA_SEGMENT,"audio",v),e.samples=[],e.length=0}}},{key:"writeToSource",value:function(e,t,i){var r=this._context.getInstance("PRE_SOURCE_BUFFER"),n=r.getSource(e);n||(n=r.createSource(e)),n.data.push(t),i&&(n.bufferDuration=i+(n.bufferDuration||0))}},{key:"initSilentAudio",value:function(t,i){var r=e.getSilentFrame(this._audioMeta.channelCount);return{dts:t,pts:t,cts:0,duration:i,unit:r,size:r.byteLength,originDts:t,type:"video"}}},{key:"destroy",value:function(){this._player=null}},{key:"videoMeta",get:function(){return this._context.getInstance("TRACKS").videoTrack.meta}},{key:"audioMeta",get:function(){return this._context.getInstance("TRACKS").audioTrack.meta}},{key:"videoDtsBase",get:function(){return null!==this._videoDtsBase?this._videoDtsBase:this._dtsBase}},{key:"audioDtsBase",get:function(){return null!==this._audioDtsBase?this._audioDtsBase:this._dtsBase}}],[{key:"getSilentFrame",value:function(e){return 1===e?new Uint8Array([0,200,0,128,35,128]):2===e?new Uint8Array([33,0,73,144,2,25,0,35,128]):3===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]):4===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]):5===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]):6===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]):null}}]),e}(),di=Qt,hi=Jt,ci={Mse:Ve,Tracks:he,PreSource:le,XgBuffer:ce,FetchLoader:We,Compatibility:Vt,Mp4Remuxer:li,Crypto:je,M3U8Parser:hi,TsDemuxer:di,Playlist:ue},fi=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),pi=function e(t,i,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,r)}if("value"in n)return n.value;var s=n.get;return void 0!==s?s.call(r):void 0},yi=Xe.HlsAllowedEvents,vi=Xe.REMUX_EVENTS,_i=e.util,mi=function(t){function i(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i);var t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":s(t))&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.hlsOps={},t.hlsOps=Object.assign(t.hlsOps,ci),_i.deepCopy(t.hlsOps,e),t._played=!1,t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":s(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,t),fi(i,[{key:"_initEvents",value:function(){var e=this;this.__core__.once(vi.INIT_SEGMENT,(function(){var t=e._context.getInstance("MSE");if(!e.started){var r=_i.createDom("xg-live","正在直播",{},"xgplayer-live");_i.addClass(e.root,"xgplayer-is-live"),e.controls.appendChild(r)}e.started=!0,pi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",e).call(e,t.url)}))}},{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.config.url;e&&!this.started&&(this._context||(this._context=new Ne(yi)),this.hlsOps||(this.hlsOps={},this.hlsOps=Object.assign(this.hlsOps,ci),_i.deepCopy(this.hlsOps,this.config),this._played=!1),this.__core__=this._context.registry("HLS_LIVE_CONTROLLER",tt)({player:this,container:this.video,preloadTime:this.config.preloadTime}),this._context.init(),this.url=e,this.__core__.load(e),this._initEvents(),this.started=!0)}},{key:"play",value:function(){var e=this;if(this._played)return this.src=this.config.url,void this.once("canplay",(function(){e.video.play()}));this._played=!0,pi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"play",this).call(this)}},{key:"destroy",value:function(){var e=this;return this._context&&this._context.destroy(),new Promise((function(t){e.__core__&&e.__core__.mse?e.__core__.mse.destroy().then((function(){pi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",e).call(e),setTimeout((function(){t()}),50)})):(pi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",e).call(e),setTimeout((function(){t()}),50))}))}},{key:"src",set:function(e){var t=this;this.onWaiting=this.onWaiting.bind(this),this.__core__.mse.destroy().then((function(){t._context.destroy(),t._context=null,t.started=!1,t.video.currentTime=0,t.start(e)}))}}],[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"install",value:function(t,i){return e.install(t,i)}}]),i}(e);mi.install=e.install.bind(e);var gi=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Ei=jt.NalUnitHEVC,bi=Nt.NalUnit,Ti=Xe.LOADER_EVENTS,ki=Xe.DEMUX_EVENTS,Si=Xe.HLS_EVENTS,Ai=Xe.CRYTO_EVENTS,wi=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,Di=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.configs=Object.assign({},t),this.url="",this.baseurl="",this.sequence=0,this._playlist=null,this.retrytimes=this.configs.retrytimes||3,this.preloadTime=this.configs.preloadTime,this.container=this.configs.container,this._m3u8lasttime=0,this._timmer=setInterval(this._checkStatus.bind(this),50),this._lastCheck=0,this._player=this.configs.player,this.m3u8Text=null}return gi(e,[{key:"init",value:function(){var e=this._player.hlsOps,t=e.XgBuffer,i=e.Tracks,r=e.Playlist,n=e.FetchLoader,a=e.TsDemuxer;this._context.registry("M3U8_BUFFER",t),this._context.registry("TS_BUFFER",t),this._context.registry("TRACKS",i),this._playlist=this._context.registry("PLAYLIST",r)({autoclear:!0}),this._m3u8loader=this._context.registry("M3U8_LOADER",n)({buffer:"M3U8_BUFFER",readtype:1}),this._tsloader=this._context.registry("TS_LOADER",n)({buffer:"TS_BUFFER",readtype:3}),this._context.registry("TS_DEMUXER",a)({inputbuffer:"TS_BUFFER"}),this.initEvents()}},{key:"initEvents",value:function(){this.on(Ti.LOADER_COMPLETE,this._onLoadComplete.bind(this)),this.on(ki.METADATA_PARSED,this._onMetadataParsed.bind(this)),this.on(ki.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(ki.DEMUX_COMPLETE,this._onDemuxComplete.bind(this)),this.on(Ti.LOADER_ERROR,this._onLoadError.bind(this)),this.on(ki.DEMUX_ERROR,this._onDemuxError.bind(this))}},{key:"_onError",value:function(e,t,i,r){var n={errorType:e,errorDetails:"["+t+"]: "+(i?i.message:""),errorFatal:r};this._player.emit("HLS_ERROR",n)}},{key:"_onDemuxComplete",value:function(){var e=this;if(this._player.video){var t=this._context.getInstance("TRACKS"),i=t.videoTrack,r=t.audioTrack;i.samples.forEach((function(t){if(!t.analyzed){t.analyzed=!0;var r=new de(t.data.buffer),n=void 0,a=(n=e._isHEVC(i.meta)?Ei.getHvccNals(r):bi.getNalunits(r)).reduce((function(e,t){return e+4+t.body.byteLength}),0),s=new Uint8Array(a),o=0;n.forEach((function(e){s.set([0,0,0,1],o),o+=4,s.set(new Uint8Array(e.body),o),o+=e.body.byteLength})),t.data=s}})),this._player.video.onDemuxComplete(i,r)}}},{key:"_onMetadataParsed",value:function(e){if("audio"===e){var t=this._context.getInstance("TRACKS").audioTrack;t&&t.meta&&this._setMetaToAudio(t.meta)}else{var i=this._context.getInstance("TRACKS").videoTrack;i&&i.meta&&this._setMetaToVideo(i.meta)}}},{key:"_setMetaToAudio",value:function(e){this._player.video&&this._player.video.setAudioMeta(e)}},{key:"_setMetaToVideo",value:function(e){this._player.video&&this._player.video.setVideoMeta(e)}},{key:"_onLoadError",value:function(e,t){!this._tsloader.loading&&!this._m3u8loader.loading&&this.retrytimes>1?(this.retrytimes--,this._onError(Ti.LOADER_ERROR,e,t,!1)):this.retrytimes<=1&&(this._onError(Ti.LOADER_ERROR,e,t,!0),this.emit(Si.RETRY_TIME_EXCEEDED),this._player.video&&this._player.video.handleEnded())}},{key:"_onDemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._onError(Ti.LOADER_ERROR,e,t,i)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_onLoadComplete",value:function(e){if("M3U8_BUFFER"===e.TAG){var t=void 0;try{this.m3u8Text=e.shift();var i=wi.exec(this.m3u8Text);i&&i[2]?this.load(i[2]):t=this._player.hlsOps.M3U8Parser.parse(this.m3u8Text,this.baseurl)}catch(e){this._onError("M3U8_PARSER_ERROR","M3U8_PARSER",e,!1)}if(!t)return void(this.retrytimes>0?(this.retrytimes--,this._preload()):(this.emit(Si.RETRY_TIME_EXCEEDED),this._player.video&&this._player.video.handleEnded()));try{this._playlist.pushM3U8(t,!0)}catch(e){this._onError("M3U8_PARSER_ERROR","PLAYLIST",e,!1)}if(this._playlist.encrypt&&this._playlist.encrypt.uri&&!this._playlist.encrypt.key){var r=this._player.hlsOps,n=r.XgBuffer,a=r.FetchLoader;this._context.registry("DECRYPT_BUFFER",n)(),this._context.registry("KEY_BUFFER",n)(),this._tsloader.buffer="DECRYPT_BUFFER",this._keyLoader=this._context.registry("KEY_LOADER",a)({buffer:"KEY_BUFFER",readtype:3}),this.emitTo("KEY_LOADER",Ti.LADER_START,this._playlist.encrypt.uri)}else this._m3u8Loaded(t)}else if("TS_BUFFER"===e.TAG)this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emit(ki.DEMUX_START);else if("DECRYPT_BUFFER"===e.TAG)this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emitTo("CRYPTO",Ai.START_DECRYPT);else if("KEY_BUFFER"===e.TAG){var s=this._player.hlsOps.Crypto;this.retrytimes=this.configs.retrytimes||3,this._playlist.encrypt.key=e.shift(),this._crypto=this._context.registry("CRYPTO",s)({key:this._playlist.encrypt.key,iv:this._playlist.encrypt.ivb,method:this._playlist.encrypt.method,inputbuffer:"DECRYPT_BUFFER",outputbuffer:"TS_BUFFER"}),this._crypto.on(Ai.DECRYPTED,this._onDcripted.bind(this))}}},{key:"_onDcripted",value:function(){this.emit(ki.DEMUX_START)}},{key:"_m3u8Loaded",value:function(e){this.preloadTime||(this.preloadTime=this._playlist.targetduration?this._playlist.targetduration:5),this._playlist.fragLength>0&&this._playlist.sequence<e.sequence?this.retrytimes=this.configs.retrytimes||3:this.retrytimes>0?(this.retrytimes--,this._preload()):(this.emit(Si.RETRY_TIME_EXCEEDED),this._player.video&&this._player.video.handleEnded())}},{key:"_checkStatus",value:function(){if(!(this.retrytimes<1&&(new Date).getTime()-this._lastCheck<1e4))if(this._lastCheck=(new Date).getTime(),this.container.buffered.length<1)this._preload();else{var e=this.container.currentTime;this.container.readyState<=2&&this._preload(),e>this.container.buffered.end(this.container.buffered.length-1)-this.preloadTime&&this._preload()}}},{key:"_preload",value:function(){if(!this._tsloader.loading&&!this._m3u8loader.loading){var e=this._playlist.getTs();if(!e||e.downloaded||e.downloading){var t=this.preloadTime?this.preloadTime:0,i=(new Date).getTime();(!e||e.downloaded)&&(i-this._m3u8lasttime)/1e3>t&&(this._m3u8lasttime=i,this.emitTo("M3U8_LOADER",Ti.LADER_START,this.url))}else this._playlist.downloading(e.url,!0),this.emitTo("TS_LOADER",Ti.LADER_START,e.url)}}},{key:"_isHEVC",value:function(e){return e&&"hev1.1.6.L93.B0"===e.codec}},{key:"load",value:function(e){this.baseurl=this._player.hlsOps.M3U8Parser.parseURL(e),this.url=e,this._preload()}},{key:"destroy",value:function(){clearInterval(this._timmer),this.off(Ti.LOADER_COMPLETE,this._onLoadComplete),this.off(ki.METADATA_PARSED,this._onMetadataParsed),this.off(ki.DEMUX_COMPLETE,this._onDemuxComplete),this.m3u8Text=null}}]),e}(),Ri={Tracks:he,XgBuffer:ce,FetchLoader:We,Crypto:je,M3U8Parser:hi,TsDemuxer:di,Playlist:ue},Li=function e(t,i,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,r)}if("value"in n)return n.value;var s=n.get;return void 0!==s?s.call(r):void 0},Oi=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Ui=Xe.HlsAllowedEvents,Bi=function(t){function i(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,i),t.mediaType||(t.mediaType="mobile-video",t.videoConfig?t.videoConfig.preloadtime=t.preloadTime||5:t.videoConfig={preloadtime:t.preloadTime||5});var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":s(t))&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t));return r.hlsOps={},r.util=e.util,r.hlsOps=Object.assign(r.hlsOps,Ri),r.util.deepCopy(r.hlsOps,t),r.playerInited||r.initPlayer(),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":s(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,t),Oi(i,null,[{key:"isSupported",value:function(){var e="WebAssembly"in window,t=!1;return"customElements"in window&&window.customElements.define&&(t=window.customElements.get("mobile-video")),e&&t}}]),Oi(i,[{key:"initPlayer",value:function(){this.video.width=Number.parseInt(this.hlsOps.width||600),this.video.height=Number.parseInt(this.hlsOps.height||337.5),this.video.style.outline="none",this.playerInited=!0}},{key:"_initEvents",value:function(){var e=this;this.once("canplay",(function(){e.video.play()}))}},{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.hlsOps.url;e&&!this.started&&(this.playerInited||this.initPlayer(),this._context||(this._context=new Ne(Ui)),this.__core__=this._context.registry("HLS_LIVE_CONTROLLER",Di)({player:this,container:this.video,preloadTime:this.config.preloadTime}),this._context.init(),this.url=e,this.__core__.load(e),Li(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",this).call(this,e),this._initEvents(),this.started=!0,this.addLiveFlag())}},{key:"play",value:function(){this.started&&(this._context.destroy(),this._context=new Ne(Ui),this.__core__=this._context.registry("HLS_LIVE_CONTROLLER",Di)({player:this,container:this.video,preloadTime:this.config.preloadTime}),this._context.init(),this._initEvents(),this.__core__.load(this.url)),Li(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"play",this).call(this)}},{key:"addLiveFlag",value:function(){if(e.util.addClass(this.root,"xgplayer-is-live"),!e.util.findDom(this.root,"xg-live")){var t=e.util.createDom("xg-live","正在直播",{},"xgplayer-live");this.controls.appendChild(t)}}},{key:"destroy",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return new Promise((function(r){Li(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",e).call(e);var n=e.video,a=e.root;Li(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",e).call(e,t),n&&n.remove?n.remove():a&&a.removeChild(n),n&&n.destroy(),setTimeout((function(){r()}),50)}))}},{key:"src",set:function(e){this.onWaiting=this.onWaiting.bind(this),this._context.destroy(),this._context=null,this.started=!1,this.video.currentTime=0,this.start(e)}}],[{key:"install",value:function(t,i){return e.install(t,i)}}]),i}(e);Bi.install=e.install.bind(e);var xi=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Ci=function(){function t(i){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),Bi.isSupported()&&i.useWASM?new Bi(i):mi.isSupported()?new mi(i):new e(i)}return xi(t,null,[{key:"install",value:function(t,i){return e.install(t,i)}}]),t}();return Ci.EVENTS=Xe,Ci}))},function(e,t,i){var r,n,a,s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(o,u){"object"==s(t)&&void 0!==e?e.exports=u(i(0)):(n=[i(0)],void 0===(a="function"==typeof(r=u)?r.apply(t,n):r)||(e.exports=a))}(0,(function(e){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Y(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Y(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(){}function l(){l.init.call(this)}function d(e){return void 0===e._maxListeners?l.defaultMaxListeners:e._maxListeners}function h(e,t,i){if(t)e.call(i);else for(var r=e.length,n=g(e,r),a=0;a<r;++a)n[a].call(i)}function c(e,t,i,r){if(t)e.call(i,r);else for(var n=e.length,a=g(e,n),s=0;s<n;++s)a[s].call(i,r)}function f(e,t,i,r,n){if(t)e.call(i,r,n);else for(var a=e.length,s=g(e,a),o=0;o<a;++o)s[o].call(i,r,n)}function p(e,t,i,r,n,a){if(t)e.call(i,r,n,a);else for(var s=e.length,o=g(e,s),u=0;u<s;++u)o[u].call(i,r,n,a)}function y(e,t,i,r){if(t)e.apply(i,r);else for(var n=e.length,a=g(e,n),s=0;s<n;++s)a[s].apply(i,r)}function v(e,t,i,r){var n,a,s;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),a=e._events),s=a[t]):(a=e._events=new u,e._eventsCount=0),s){if("function"==typeof s?s=a[t]=r?[i,s]:[s,i]:r?s.unshift(i):s.push(i),!s.warned&&(n=d(e))&&n>0&&s.length>n){s.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=t,o.count=s.length,function(e){"function"==typeof console.warn?console.warn(e):console.log(e)}(o)}}else s=a[t]=i,++e._eventsCount;return e}function _(e,t,i){function r(){e.removeListener(t,r),n||(n=!0,i.apply(e,arguments))}var n=!1;return r.listener=i,r}function m(e){var t=this._events;if(t){var i=t[e];if("function"==typeof i)return 1;if(i)return i.length}return 0}function g(e,t){for(var i=new Array(t);t--;)i[t]=e[t];return i}function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function b(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function T(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function k(e,t){return e(t={exports:{}},t.exports),t.exports}function S(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;var A={fixedFloat:function(e,t){return Number.parseFloat(Number(e).toFixed(t))}},w=Object.freeze({__proto__:null,debounce:function(e,t){var i=Date.now(),r=null,n=!0;return function(){for(var a=arguments.length,s=Array(a),o=0;o<a;o++)s[o]=arguments[o];var u=Date.now();n&&(i=Date.now(),n=!1,e.apply(void 0,s)),u-i>t?(i=u,e.apply(void 0,s)):(r&&window.clearTimeout(r),r=setTimeout((function(){e.apply(void 0,s)}),t))}},caculate:A}),D={VISIBILITY_CHANGE:"VISIBILITY_CHANGE"},R={SEEK:"SEEK"},L={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_RESPONSE_HEADERS:"LOADER_RESPONSE_HEADERS",LOADER_ERROR:"LOADER_ERROR",LOADER_RETRY:"LOADER_RETRY"},O={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",SEI_PARSED:"SEI_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO"},U={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",DETECT_CHANGE_STREAM_DISCONTINUE:"DETECT_CHANGE_STREAM_DISCONTINUE",DETECT_AUDIO_GAP:"DETECT_AUDIO_GAP",DETECT_LARGE_GAP:"DETECT_LARGE_GAP",DETECT_AUDIO_OVERLAP:"DETECT_AUDIO_OVERLAP",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",DETECT_FRAG_ID_DISCONTINUE:"DETECT_FRAG_ID_DISCONTINUE"},B={SOURCE_UPDATE_END:"SOURCE_UPDATE_END",MSE_ERROR:"MSE_ERROR"},x={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},C=Object.assign({},L,O,U,B,x,R,D),M=[],P=[];for(var I in C)C.hasOwnProperty(I)&&M.push(C[I]);for(var G in C)C.hasOwnProperty(G)&&P.push(C[G]);var F={ALLEVENTS:C,HLS_EVENTS:x,REMUX_EVENTS:U,DEMUX_EVENTS:O,MSE_EVENTS:B,LOADER_EVENTS:L,FlvAllowedEvents:M,HlsAllowedEvents:P,CRYTO_EVENTS:{START_DECRYPT:"START_DECRYPT",DECRYPTED:"DECRYPTED"},PLAYER_EVENTS:R,BROWSER_EVENTS:D},N=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),j=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this._audoclear=t.autoclear||!1,this.downloadedUrls=[]}return N(e,[{key:"push",value:function(e,t,i,r){this._ts[e]||(this._ts[e]={duration:t,downloaded:!1,downloading:!1,start:this.duration,discontinue:!!i,id:r},this._list[this.duration]=e,this.duration+=t,this.fragLength+=1)}},{key:"deleteFrag",value:function(e){this._ts[e]&&(this._ts[e].start>this._lastget.time&&(this._lastget={duration:this._ts[e].duration,time:this._ts[e].start,downloaded:!1,downloading:!1,url:e,id:this._ts[e].id}),delete this._list[this._ts[e].start],delete this._ts[e],this.fragLength-=1)}},{key:"pushM3U8",value:function(e,t){if(!e)throw new Error("No m3u8 data received.");if(this.version=e.version,this.targetduration=e.targetduration,e.encrypt&&!this.encrypt&&(this.encrypt=e.encrypt),e.sequence||(e.sequence=0),!(e.sequence>this.sequence))throw new Error("Old m3u8 file received, "+e.sequence);this.sequence=e.sequence;for(var i=[],r=0;r<e.frags.length;r++){var n=e.frags[r];!this._ts[n.url]&&this.downloadedUrls.indexOf(n.url)<0&&(i.push(n.url),this.push(n.url,n.duration,n.discontinue,n.id))}if(i.length<1)throw new Error("Can not read ts file list.");if(t)for(var a=this.getTsList(),s=0;s<a.length;s++)i.indexOf(a[s])<0&&this.deleteFrag(a[s])}},{key:"getTsList",value:function(){return Object.keys(this._ts)}},{key:"downloaded",value:function(e,t){var i=this._ts[e];i&&(i.downloaded=t)}},{key:"downloading",value:function(e,t){var i=this._ts[e];i&&(i.downloading=t)}},{key:"getTsByName",value:function(e){return this._ts[e]}},{key:"getTs",value:function(e){var t=Object.keys(this._list),i=void 0;if(void 0===e&&(e=this._lastget?this._lastget.time+this._lastget.duration:0),!(t.length<1||e>=this.duration)){t=t.sort((function(e,t){return parseFloat(e)-parseFloat(t)}));for(var r=0;r<t.length&&e>=parseInt(t[r]);r++){var n=this._list[t[r]];i={url:n,downloaded:this._ts[n].downloaded,downloading:this._ts[n].downloading,time:parseInt(t[r]),duration:parseInt(this._ts[n].duration),id:this._ts[n].id},this.autoclear&&(delete this._ts[this._lastget.url],delete this._list[this._lastget.time]),this._lastget=i}return i&&this.downloadedUrls.push(i.url),i}}},{key:"getLastDownloadedTs",value:function(){for(var e=Object.keys(this._list).sort((function(e,t){return Number(e)-Number(t)})),t=void 0,i=0;i<e.length;i++){var r=this._list[e[i]],n=this._ts[r].downloaded,a=this._ts[r].downloading;if(!n)break;t={url:r,downloaded:n,downloading:a,time:parseInt(e[i]),duration:parseInt(this._ts[r].duration)}}return t}},{key:"clear",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0}},{key:"clearDownloaded",value:function(){for(var e=Object.keys(this._ts),t=0,i=e.length;t<i;t++){var r=this._ts[e[t]];r.downloaded=!1,r.downloading=!1}}},{key:"destroy",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this._audoclear=!1}},{key:"resetSequence",value:function(){this.sequence=-1}},{key:"list",get:function(){return this._list}},{key:"baseURL",set:function(e){this.baseURL!==e&&(this.clear(),this._baseURL=e)},get:function(){return this._baseURL}}]),e}(),V=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),H=function e(){t(this,e),this.mimetype="",this.init=null,this.data=[],this.bufferDuration=0},X=function(){function e(){t(this,e),this.sources={}}return V(e,[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new H,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.sources={}}}]),e}(),W=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),z=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}return W(e,[{key:"back",value:function(e){this.position-=e}},{key:"skip",value:function(t){for(var i=Math.floor(t/4),r=t%4,n=0;n<i;n++)e.readByte(this.dataview,4);r>0&&e.readByte(this.dataview,r)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,i){var r=void 0;switch(t){case 1:r=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:r=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");r=e.getUint8(e.position)<<16,r|=e.getUint8(e.position+1)<<8,r|=e.getUint8(e.position+2);break;case 4:r=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");r=e.getUint32(e.position)<<32,r|=e.getUint32(e.position+4);break;default:r=""}return e.position+=t,r}}]),e}(),Y="function"==typeof Symbol&&"symbol"==s(Symbol.iterator)?function(e){return void 0===e?"undefined":s(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":s(e)},q=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),K=function(){function e(){n(this,e),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}return q(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"distroy",value:function(){this.reset(),this.id=-1}}]),e}(),Z=function(e){function t(){n(this,t);var e=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="AudioTrack",e.type="audio",e}return r(t,e),t}(K),Q=function(e){function t(){n(this,t);var e=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="VideoTrack",e.type="video",e.dropped=0,e}return r(t,e),q(t,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),t}(K),$=(q((function e(){n(this,e),this.audioTrack=null,this.videoTrack=null}),[{key:"destroy",value:function(){this.audioTrack=null,this.videoTrack=null}}]),function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}()),J=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.length=t||0,this.historyLen=t||0,this.array=[],this.offset=0}return $(e,[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var i=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,i}for(var r=new Uint8Array(e),n=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+e);r.set(a,n),this.offset+=e,this.length-=e,e=0;break}var s=this.array[0].length-this.offset;r.set(this.array[0].slice(this.offset,this.array[0].length),n),this.array.shift(),this.offset=0,n+=s,this.length-=s,e-=s}return r}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var i=0,r=this.offset+e;r<this.offset+t+e;)r<this.array[0].length?i=256*i+this.array[0][r]:this.array[1]&&(i=256*i+this.array[1][r-this.array[0].length]),r++;return i}}]),e}(),ee=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),te=function(){function e(t){a(this,e);var i={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},i,t):i}return ee(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),ie=function(){function e(t){a(this,e);var i={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},i,t):i}return ee(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}(),re=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ne=function(){function e(t){o(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return re(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,data:new Uint8Array}}}]),e}(),ae=function(){function e(t){o(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return re(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,isKeyframe:!1,originDts:null,data:new Uint8Array}}}]),e}(),se=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),oe=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},ue=j,le=X,de=z,he=K,ce=J,fe=Z,pe=function(){function e(){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.mimeType=null,this.duration=null,this.hasVideo=null,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=null,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}return se(e,[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:function(e){return oe(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||oe(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||oe(e.video)}}]),e}(),ye=Q,ve=te,_e=ie,me=ne,ge=ae;u.prototype=Object.create(null),l.EventEmitter=l,l.usingDomains=!1,l.prototype.domain=void 0,l.prototype._events=void 0,l.prototype._maxListeners=void 0,l.defaultMaxListeners=10,l.init=function(){this.domain=null,l.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new u,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},l.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},l.prototype.getMaxListeners=function(){return d(this)},l.prototype.emit=function(e){var t,i,r,n,a,s,o,u="error"===e;if(s=this._events)u=u&&null==s.error;else if(!u)return!1;if(o=this.domain,u){if(t=arguments[1],!o){if(t instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=o,t.domainThrown=!1,o.emit("error",t),!1}if(!(i=s[e]))return!1;var d="function"==typeof i;switch(r=arguments.length){case 1:h(i,d,this);break;case 2:c(i,d,this,arguments[1]);break;case 3:f(i,d,this,arguments[1],arguments[2]);break;case 4:p(i,d,this,arguments[1],arguments[2],arguments[3]);break;default:for(n=new Array(r-1),a=1;a<r;a++)n[a-1]=arguments[a];y(i,d,this,n)}return!0},l.prototype.addListener=function(e,t){return v(this,e,t,!1)},l.prototype.on=l.prototype.addListener,l.prototype.prependListener=function(e,t){return v(this,e,t,!0)},l.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,_(this,e,t)),this},l.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,_(this,e,t)),this},l.prototype.removeListener=function(e,t){var i,r,n,a,s;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(i=r[e]))return this;if(i===t||i.listener&&i.listener===t)0==--this._eventsCount?this._events=new u:(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(n=-1,a=i.length;a-- >0;)if(i[a]===t||i[a].listener&&i[a].listener===t){s=i[a].listener,n=a;break}if(n<0)return this;if(1===i.length){if(i[0]=void 0,0==--this._eventsCount)return this._events=new u,this;delete r[e]}else!function(e,t){for(var i=t,r=i+1,n=e.length;r<n;i+=1,r+=1)e[i]=e[r];e.pop()}(i,n);r.removeListener&&this.emit("removeListener",e,s||t)}return this},l.prototype.removeAllListeners=function(e){var t,i;if(!(i=this._events))return this;if(!i.removeListener)return 0===arguments.length?(this._events=new u,this._eventsCount=0):i[e]&&(0==--this._eventsCount?this._events=new u:delete i[e]),this;if(0===arguments.length){for(var r,n=Object.keys(i),a=0;a<n.length;++a)"removeListener"!==(r=n[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new u,this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},l.prototype.listeners=function(e){var t,i=this._events;return i&&(t=i[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(t):[]},l.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},l.prototype.listenerCount=m,l.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var Ee="function"==typeof Symbol&&"symbol"==s(Symbol.iterator)?function(e){return void 0===e?"undefined":s(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":s(e)},be=function e(t,i,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,r)}if("value"in n)return n.value;var s=n.get;return void 0!==s?s.call(r):void 0},Te=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ke=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];E(this,e),this._emitter=new l,this._emitter.off||(this._emitter.off=this._emitter.removeListener),this.mediaInfo=new pe,this._instanceMap={},this._clsMap={},this._inited=!1,this.allowedEvents=t,this._hooks={}}return Te(e,[{key:"getInstance",value:function(e){return this._instanceMap[e]||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=i[0],a=i[1],s=i[2],o=i[3];if(this._clsMap[e]){var u=new this._clsMap[e](n,a,s,o);return this._instanceMap[e]=u,u.init&&u.init(),u}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var i=this,r=this._emitter,n=this._isMessageNameValid.bind(this),a=this,s=function(t){function i(t,r,n){E(this,i);var s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Ee(t))&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,r,n));return s.listeners={},s.onceListeners={},s.TAG=e,s._context=a,s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Ee(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,t),Te(i,[{key:"on",value:function(t,i){return n(t),this.listeners[t]?this.listeners[t].push(i):this.listeners[t]=[i],r.on(t+"__TO__"+e,i),r.on(t,i)}},{key:"before",value:function(e,t){n(e),a._hooks[e]?a._hooks[e].push(t):a._hooks[e]=[t]}},{key:"once",value:function(t,i){return n(t),this.onceListeners[t]?this.onceListeners[t].push(i):this.onceListeners[t]=[i],r.once(t+"__TO__"+e,i),r.once(t,i)}},{key:"emit",value:function(e){n(e);for(var t=a._hooks?a._hooks[e]:null,i=arguments.length,s=Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];if(t)for(var u=0,l=t.length;u<l;u++)t[u].apply(void 0,s);return r.emit.apply(r,[e].concat(s))}},{key:"emitTo",value:function(e,t){n(t);for(var i=arguments.length,a=Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];return r.emit.apply(r,[t+"__TO__"+e].concat(a))}},{key:"off",value:function(e,t){return n(e),r.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var i in this.listeners)if(t(i))for(var n=this.listeners[i]||[],a=0;a<n.length;a++){var s=n[a];r.off(i,s),r.off(i+"__TO__"+e,s)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var d=u[l];r.off(o,d),r.off(o+"__TO__"+e,d)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete a._instanceMap[e],be(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this))return be(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this)}}]),i}(t);return this._clsMap[e]=s,function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return i.initInstance.apply(i,[e].concat(r))}}},{key:"seek",value:function(e){this._emitter.emit(F.PLAYER_EVENTS.SEEK,e)}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach((function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()}))}},{key:"destroy",value:function(){this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._context=null,this._hooks=null,this.destroyInstances()}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}]),e}(),Se=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Ae=F.CRYTO_EVENTS,we=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.inputBuffer=t.inputbuffer,this.outputBuffer=t.outputbuffer,this.key=t.key,this.iv=t.iv,this.method=t.method,this.crypto=window.crypto||window.msCrypto}return Se(e,[{key:"init",value:function(){this.on(Ae.START_DECRYPT,this.decript.bind(this))}},{key:"decript",value:function(){var e=this;this.aeskey?this.decriptData():this.crypto.subtle.importKey("raw",this.key.buffer,{name:"AES-CBC"},!1,["encrypt","decrypt"]).then((function(t){e.aeskey=t,e.decriptData()}))}},{key:"decriptData",value:function(){var e=this,t=this._context.getInstance(this.inputBuffer),i=this._context.getInstance(this.outputBuffer),r=t.shift();r&&this.crypto.subtle.decrypt({name:"AES-CBC",iv:this.iv.buffer},this.aeskey,r).then((function(t){i.push(new Uint8Array(t)),e.emit(Ae.DECRYPTED),e.decriptData(r)}))}}]),e}(),De=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Re=F.MSE_EVENTS,Le=function(){function e(t,i){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),i&&(this._context=i,this.emit=i._emitter.emit.bind(i._emitter)),this.TAG="MSE",this.configs=Object.assign({},t),this.container=this.configs.container,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this),this.opened=!1}return De(e,[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this._url=null,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"resetContext",value:function(t){this._context=t,this.emit=t._emitter.emit.bind(t._emitter);for(var i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||e.clearBuffer(r)}}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.opened=!0,this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit(Re.SOURCE_UPDATE_END),this.doAppend()}},{key:"addSourceBuffers",value:function(){if(this.mediaSource&&"open"===this.mediaSource.readyState&&this.opened){var e=this._context.getInstance("PRE_SOURCE_BUFFER"),t=this._context.getInstance("TRACKS"),i=void 0;if(e&&t){e=e.sources;for(var r=!1,n=0,a=Object.keys(e).length;n<a;n++){var s=Object.keys(e)[n];r=!1,"audio"===s?i=t.audioTrack:"video"===s&&(i=t.videoTrack),i&&null!==e[s].init&&e[s].data.length&&(r=!0)}if(r){if(Object.keys(this.sourceBuffers).length>1)return;for(var o=0,u=Object.keys(e).length;o<u;o++){var l=Object.keys(e)[o];if(!this.sourceBuffers[l]){var d=e[l],h="video"===l?"video/mp4;codecs="+d.mimetype:"audio/mp4;codecs="+d.mimetype;try{var c=this.mediaSource.addSourceBuffer(h);this.sourceBuffers[l]=c,c.addEventListener("updateend",this.onUpdateEnd)}catch(e){this.emit(Re.MSE_ERROR,this.TAG,new Error(e.message))}}}Object.keys(this.sourceBuffers).length===this.sourceBufferLen&&this.doAppend()}}}}},{key:"doAppend",value:function(){this._doCleanupSourceBuffer();var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e)for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],r=this.sourceBuffers[i];if(!r.updating){var n=e.sources[i];if(this["no"+i])n.data=[],n.init.buffer=null;else if(n&&!n.inited)try{r.appendBuffer(n.init.buffer.buffer),n.inited=!0}catch(e){}else if(n){var a=n.data.shift();if(a)try{r.appendBuffer(a.buffer.buffer)}catch(e){n.data.unshift(a)}}}}}},{key:"endOfStream",value:function(){if("open"===this.mediaSource.readyState)try{this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||r.remove(t,e)}}},{key:"_doCleanupSourceBuffer",value:function(){for(var e=this.container.currentTime,t={video:[],audio:[]},i=0;i<Object.keys(this.sourceBuffers).length;i++){for(var r=Object.keys(this.sourceBuffers)[i],n=this.sourceBuffers[r],a=n.buffered,s=!1,o=0;o<a.length;o++){var u=a.start(o),l=a.end(o);if(u<=e&&e<l+3){if(e-u>=180){s=!0;var d=e-180;t[r].push({start:u,end:d})}}else l<e&&(s=!0,t[r].push({start:u,end:l}))}s&&!n.updating&&this._doRemoveRanges(t)}}},{key:"_doRemoveRanges",value:function(e){for(var t in e)if(this.sourceBuffers[t]&&!this.sourceBuffers[t].updating)for(var i=this.sourceBuffers[t],r=e[t];r.length&&!i.updating;){var n=r.shift();i.remove(n.start,n.end)}}},{key:"cleanBuffers",value:function(){for(var t=this,i=[],r=0;r<Object.keys(this.sourceBuffers).length;r++)!function(r){var n,a=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n=a.updating?new Promise((function(t){a.addEventListener("updateend",(function i(){var r=3;setTimeout((function i(){a.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(a),a.addEventListener("updateend",(function(){t()})))}),200),a.removeEventListener("updateend",i)}))})):new Promise((function(t){e.clearBuffer(a),a.addEventListener("updateend",(function(){t()}))})),i.push(n)}(r);return Promise.all(i)}},{key:"removeBuffers",value:function(){for(var t=this,i=[],r=0;r<Object.keys(this.sourceBuffers).length;r++)!function(r){var n=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n.removeEventListener("updateend",t.onUpdateEnd);var a;a=n.updating?new Promise((function(t){n.addEventListener("updateend",(function i(){var r=3;setTimeout((function i(){n.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(n),n.addEventListener("updateend",(function(){t()})))}),200),n.removeEventListener("updateend",i)}))})):new Promise((function(t){e.clearBuffer(n),n.addEventListener("updateend",(function(){t()}))})),i.push(a)}(r);return Promise.all(i)}},{key:"destroy",value:function(){var e=this;return this.container?(this.container.removeEventListener("timeupdate",this.onTimeUpdate),this.container.removeEventListener("waiting",this.onWaiting),this.mediaSource.removeEventListener("sourceopen",this.onSourceOpen),this.removeBuffers().then((function(){for(var t=Object.keys(e.sourceBuffers),i=0;i<t.length;i++){var r=e.sourceBuffers[t[i]];delete e.sourceBuffers[t[i]],"open"===e.mediaSource.readyState&&e.mediaSource.removeSourceBuffer(r)}e.endOfStream(),window.URL.revokeObjectURL(e.url),e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1,e.onSourceOpen=null,e.onTimeUpdate=null,e.onUpdateEnd=null,e.onWaiting=null,e.noaudio=void 0,e.novideo=void 0}))):Promise.resolve()}},{key:"sourceBufferLen",get:function(){return this._context.mediaInfo?(!!this._context.mediaInfo.hasVideo&&!this.novideo)+(!!this._context.mediaInfo.hasAudio&&!this.noaudio):this.noaudio||this.novideo?1:2}},{key:"url",set:function(e){this._url=e},get:function(){return this._url||(this._url=window.URL.createObjectURL(this.mediaSource)),this._url}}],[{key:"clearBuffer",value:function(e){try{for(var t=e.buffered,i=.1,r=0,n=t.length;r<n;r++)i=t.end(r);e.remove(0,i)}catch(e){}}}]),e}(),Oe=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),Ue={get device(){var e=Ue.os;return e.isPc?"pc":e.isTablet?"tablet":"mobile"},get browser(){var e=navigator.userAgent.toLowerCase(),t={ie:/rv:([\d.]+)\) like gecko/,firfox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(t).filter((function(i){return t[i].test(e)})))[0]},get os(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,r=/(?:Android)/.test(e),n=/(?:Firefox)/.test(e),a=/(?:iPad|PlayBook)/.test(e)||r&&!/(?:Mobile)/.test(e)||n&&/(?:Tablet)/.test(e),s=/(?:iPhone)/.test(e)&&!a;return{isTablet:a,isPhone:s,isAndroid:r,isPc:!s&&!r&&!i,isSymbian:i,isWindowsPhone:t,isFireFox:n}},get isLe(){return Oe}},Be="function"==typeof Symbol&&"symbol"==s(Symbol.iterator)?function(e){return void 0===e?"undefined":s(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":s(e)},xe="function"==typeof Symbol&&"symbol"===Be(Symbol.iterator)?function(e){return void 0===e?"undefined":Be(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":Be(e)},Ce=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Me=F.LOADER_EVENTS,Pe=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.configs=Object.assign({},t),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0}return Ce(e,[{key:"init",value:function(){this.on(Me.LADER_START,this.load.bind(this))}},{key:"fetch",value:function(e){function t(t,i,r){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e,t,i){var r=null;return Promise.race([fetch(e,t),new Promise((function(e,t){r=setTimeout((function(){t({code:999,message:"fetch timeout"})}),i||1e4)}))]).then((function(e){return r&&(clearTimeout(r),r=null),e}))}))},{key:"internalLoad",value:function(e,t,i,r){var n=this,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return this.loading=!0,this.fetch(this.url,t,!i&&1e5).then((function(s){if(n.emit(Me.LOADER_RESPONSE_HEADERS,n.TAG,s.headers),s.ok)return n.status=s.status,Promise.resolve().then((function(){n._onFetchResponse(s)})),Promise.resolve(s);i-- >0?n._retryTimer=setTimeout((function(){return n.emit(Me.LOADER_RETRY,n.TAG,{response:s,reason:"response not ok",retryTime:r-i}),n.internalLoad(e,t,i,r,a)}),a):(n.loading=!1,n.emit(Me.LOADER_ERROR,n.TAG,{code:s.status,message:s.status+" ("+s.statusText+")"}))})).catch((function(s){if(n.loading=!1,!(i-- >0))throw n.emit(Me.LOADER_ERROR,n.TAG,s),s;n._retryTimer=setTimeout((function(){return n.emit(Me.LOADER_RETRY,n.TAG,{error:s,reason:"fetch error",retryTime:r-i}),n.internalLoad(e,t,i,r,a)}),a)}))}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments[2],r=arguments[3];i=void 0===i?3:i,this.url=e,this._canceled=!1;var n=this.getParams(t);return this.internalLoad(e,n,i,i,r)}},{key:"_onFetchResponse",value:function(e){var t=this,i=this._context.getInstance(this.buffer),r=++this._loaderTaskNo;if(!0===e.ok)switch(this.readtype){case 2:e.json().then((function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(Me.LOADER_COMPLETE,i)):t.emit(Me.LOADER_COMPLETE,e))}));break;case 1:e.text().then((function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(Me.LOADER_COMPLETE,i)):t.emit(Me.LOADER_COMPLETE,e))}));break;case 3:e.arrayBuffer().then((function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(new Uint8Array(e)),t.emit(Me.LOADER_COMPLETE,i)):t.emit(Me.LOADER_COMPLETE,e))}));break;case 0:default:return this._onReader(e.body.getReader(),r)}}},{key:"_onReader",value:function(e,t){var i=this,r=this._context.getInstance(this.buffer);if(!r&&this._reader||this._destroyed)try{this._reader.cancel()}catch(e){}this._reader=e,!1!==this.loading&&this._reader&&this._reader.read().then((function(n){if(!i._canceled&&!i._destroyed)return n.done?(i.loading=!1,i.status=0,void Promise.resolve().then((function(){i.emit(Me.LOADER_COMPLETE,r)}))):(r.push(n.value),Promise.resolve().then((function(){i.emit(Me.LOADER_DATALOADED,r)})),i._onReader(e,t));if(i._reader)try{i._reader.cancel()}catch(e){}})).catch((function(e){throw i.loading=!1,i.emit(Me.LOADER_ERROR,i.TAG,e),e}))}},{key:"getParams",value:function(e){var t=Object.assign({},e),i=new Headers,r={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===xe(this.configs.headers)){var n=this.configs.headers;for(var a in n)n.hasOwnProperty(a)&&i.append(a,n[a])}if("object"===xe(t.headers)){var s=t.headers;for(var o in s)s.hasOwnProperty(o)&&i.append(o,s[o])}return!1===t.cors&&(r.mode="same-origin"),t.withCredentials&&(r.credentials="include"),r}},{key:"cancel",value:function(){if(this._reader){try{this._reader.cancel()}catch(e){}this._reader=null,this.loading=!1}this._canceled=!0}},{key:"destroy",value:function(){this._destroyed=!0,clearTimeout(this._retryTimer),this.cancel()}}],[{key:"type",get:function(){return"loader"}}]),e}(),Ie=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Ge=new(function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);try{var i=/xgd=(\d)/.exec(document.cookie);this._status=!!i,this._level=i&&i[1]}catch(e){this._status=!1}["group","groupEnd","log","warn","error"].forEach((function(e){t[e]=function(i,r,n,a,s,o,u,l,d,h){var c;if(t._status){var f=i,p=[r,n,a,s,o,u,l,d,h].filter((function(e){return void 0!==e}));(c=console)[e].apply(c,["["+f+"]:"].concat(function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}(p)))}}}))}return Ie(e,[{key:"enable",get:function(){return this._status}},{key:"long",get:function(){return"2"===this._level}}]),e}()),Fe=w,Ne=ke,je=we,Ve=Le,He=Ue,Xe=F,We=Pe,ze=Ge,Ye=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),qe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Ye(e,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),e}(),Ke=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Ze=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Ke(e,null,[{key:"isHeader",value:function(t,i){return!!(i+1<t.length&&e.isHeaderPattern(t,i))}},{key:"getFrameDuration",value:function(e){return 9216e4/e}},{key:"isHeaderPattern",value:function(e,t){return 255===e[t]&&240==(246&e[t+1])}},{key:"getHeaderLength",value:function(e,t){return 1&e[t+1]?7:9}},{key:"getFullFrameLength",value:function(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}},{key:"parseFrameHeader",value:function(t,i,r,n,a){var s,o=void 0,u=t.length;if(s=e.getHeaderLength(t,i),o=e.getFullFrameLength(t,i),(o-=s)>0&&i+s+o<=u)return{headerLength:s,frameLength:o,stamp:r+n*a}}},{key:"appendFrame",value:function(t,i,r,n,a){var s=e.getFrameDuration(t.meta.sampleRate),o=e.parseFrameHeader(i,r,n,a,s);if(o){var u=o.stamp,l=o.headerLength,d=o.frameLength;return{sample:{unit:i.subarray(r+l,r+l+d),pts:u,dts:u},length:d+l}}}}]),e}(),Qe=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),$e=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return Qe(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}]),e}(),Je=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),et=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Je(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(r[n]=t[a],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(t){var i=e._ebsp2rbsp(t),r=new $e(i);r.readByte();var n=r.readByte();r.readByte();var a=r.readByte();r.readUEG();var s=e.getProfileString(n),o=e.getLevelString(a),u=1,l=420,d=8;if((100===n||110===n||122===n||244===n||44===n||83===n||86===n||118===n||128===n||138===n||144===n)&&(3===(u=r.readUEG())&&r.readBits(1),u<=3&&(l=[0,420,422,444][u]),d=r.readUEG()+8,r.readUEG(),r.readBits(1),r.readBool()))for(var h=3!==u?8:12,c=0;c<h;c++)r.readBool()&&(c<6?e._skipScalingList(r,16):e._skipScalingList(r,64));r.readUEG();var f=r.readUEG();if(0===f)r.readUEG();else if(1===f){r.readBits(1),r.readSEG(),r.readSEG();for(var p=r.readUEG(),y=0;y<p;y++)r.readSEG()}r.readUEG(),r.readBits(1);var v=r.readUEG(),_=r.readUEG(),m=r.readBits(1);0===m&&r.readBits(1),r.readBits(1);var g=0,E=0,b=0,T=0;r.readBool()&&(g=r.readUEG(),E=r.readUEG(),b=r.readUEG(),T=r.readUEG());var k=1,S=1,A=0,w=!0,D=0,R=0;if(r.readBool()){if(r.readBool()){var L=r.readByte();L>0&&L<16?(k=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][L-1],S=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][L-1]):255===L&&(k=r.readByte()<<8|r.readByte(),S=r.readByte()<<8|r.readByte())}if(r.readBool()&&r.readBool(),r.readBool()&&(r.readBits(4),r.readBool()&&r.readBits(24)),r.readBool()&&(r.readUEG(),r.readUEG()),r.readBool()){var O=r.readBits(32),U=r.readBits(32);w=r.readBool(),A=(D=U)/(R=2*O)}}var B=1;1===k&&1===S||(B=k/S);var x=0,C=0;0===u?(x=1,C=2-m):(x=3===u?1:2,C=(1===u?2:1)*(2-m));var M=16*(v+1),P=16*(_+1)*(2-m);M-=(g+E)*x,P-=(b+T)*C;var I=Math.ceil(M*B);return r.destroy(),r=null,{profile_string:s,level_string:o,bit_depth:d,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:w,fps:A,fps_den:R,fps_num:D},par_ratio:{width:k,height:S},codec_size:{width:M,height:P},present_size:{width:I,height:P}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.readSEG()+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var i=t.frameRate.fps_den,r=t.frameRate.fps_num;return t.refSampleDuration=Math.floor(t.timescale*(i/r)),t}}]),e}(),tt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),it=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return tt(e,null,[{key:"EBSP2RBSP",value:function(e){return e.filter((function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)}))}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),e}(),rt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),nt=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t},at=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return rt(e,null,[{key:"_resolveNalu",value:function(e){return e.length>=1?it.EBSP2SODB(it.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),r=e.switchPayloadType(i),n=r.payloadType,a=r.offset,s=i.slice(a);switch(n){case 5:return e.user_data_unregistered(s);default:return{code:n,content:s}}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),r=i.payloadLength,n=i.offset;if(r<16)return{uuid:"",content:null};var a=t.slice(n);return{code:5,uuid:nt(a.slice(0,16)),content:nt(a.slice(16,r))}}}]),e}(),st=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ot=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return st(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,r=t.position;return 1===i.getInt32(r)||0===i.getInt16(r)&&1===i.getInt8(r+3)?e.getAnnexbNals(t):e.getAvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],r=e.getHeaderPositionAnnexB(t),n=r.pos,a=n;n<t.length-4;){var s=t.buffer.slice(n,n+r.headerLength);r.pos===t.position&&t.skip(r.headerLength),a=(r=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(n+s.byteLength,a))};e.analyseNal(o),o.type<=9&&0!==o.type&&i.push(o),t.skip(a-t.position),n=a}return i}},{key:"getAvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var r=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=r))break;var n=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+r));t.skip(r);var s={header:n,body:a};e.analyseNal(s),s.type<=9&&0!==s.type&&i.push(s)}return i}},{key:"analyseNal",value:function(e){var t=31&e.body[0];switch(e.type=t,t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:e.sei=at.parse(e.body);break;case 7:e.sps=et.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(i=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=r)),{pos:t,headerLength:i}}},{key:"getAvcc",value:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength+11);i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=255,i[5]=225;var r=6;return i.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),r),r+=2,i.set(e,r),i[r+=e.byteLength]=1,r++,i.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),r),r+=2,i.set(t,r),i}}]),e}(),ut=et,lt=ot,dt=at,ht=$e,ct=Object.freeze({__proto__:null,SpsParser:ut,NalUnit:lt,SEIParser:dt,Golomb:ht}),ft=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),pt=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return ft(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){if(0===this._currentWordBitsLeft)return 0;var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}(),yt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),vt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return yt(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(r[n]=t[a],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(t){var i,r,n,a,s,o,u=e._ebsp2rbsp(t),l=new pt(u),d=0,h=0,c=0,f=0,p=0,y=0,v=0,_=0,m=0;return l.readByte(),l.readByte(),l.readBits(4),i=l.readBits(3),l.readBits(1),o=e._readProfileTierLevel(l,i),l.readUEG(),3===(r=l.readUEG())&&(d=l.readBits(1)),h=l.readUEG(),c=l.readUEG(),1===(n=l.readBits(1))&&(f=l.readUEG(),p=l.readUEG(),y=l.readUEG(),v=l.readUEG()),a=l.readUEG(),s=l.readUEG(),1===n&&(h-=(_=1!==r&&2!==r||0!==d?1:2)*p+_*f,c-=(m=1===r&&0===d?2:1)*v+m*y),l.destroy(),l=null,{width:h,height:c,general_profile_space:o.general_profile_space,general_tier_flag:o.general_tier_flag,general_profile_idc:o.general_profile_idc,general_level_idc:o.general_level_idc,chromaFormatIdc:r,bitDepthLumaMinus8:a,bitDepthChromaMinus8:s}}},{key:"_readProfileTierLevel",value:function(e,t){var i,r,n,a;i=e.readBits(2)||0,r=e.readBits(1)||0,n=e.readBits(5)||0,e.readBits(16),e.readBits(16),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(16),e.readBits(16),e.readBits(12),a=e.readBits(8)||0;for(var s=[],o=[],u=0;u<t;u++)s[u]=e.readBits(1),o[u]=e.readBits(1);t>0&&e.readBits(2*(8-t));for(var l=0;l<t;l++)0!==s[l]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==o[l]&&e.readBits(8);return{general_profile_space:i,general_tier_flag:r,general_profile_idc:n,general_level_idc:a}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.readSEG()+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};return e&&e.codec_size?(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height):e.width&&e.height&&(t.codecWidth=e.width,t.codecHeight=e.height,t.presentWidth=e.width,t.presentHeight=e.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t}}]),e}(),_t=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),mt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return _t(e,null,[{key:"EBSP2RBSP",value:function(e){return e.filter((function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)}))}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),e}(),gt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Et=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t},bt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return gt(e,null,[{key:"_resolveNalu",value:function(e){return e.length>=1?mt.EBSP2SODB(mt.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),r=e.switchPayloadType(i),n=r.payloadType,a=r.offset,s=i.slice(a);switch(n){case 5:return e.user_data_unregistered(s);default:return{code:n,content:s}}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),r=i.payloadLength,n=i.offset;if(r<16)return{uuid:"",content:null};var a=t.slice(n);return{code:5,uuid:Et(a.slice(0,16)),content:Et(a.slice(16,r))}}}]),e}(),Tt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),kt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Tt(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,r=t.position;return 1===i.getInt32(r)||0===i.getInt16(r)&&1===i.getInt8(r+2)?e.getAnnexbNals(t):e.getHvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],r=e.getHeaderPositionAnnexB(t),n=r.pos,a=n;n<t.length-4;){var s=t.buffer.slice(n,n+r.headerLength);r.pos===t.position&&t.skip(r.headerLength),a=(r=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(n+s.byteLength,a))};e.analyseNal(o),o.type<=40&&i.push(o),t.skip(a-t.position),n=a}return i}},{key:"getHvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var r=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=r))break;var n=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+r));t.skip(r);var s={header:n,body:a};try{e.analyseNal(s)}catch(e){continue}s.type<=40&&i.push(s)}return i}},{key:"analyseNal",value:function(e){var t=e.body[0]>>>1&63;switch(e.type=t,t){case 0:e.slice_trail_n=!0;break;case 1:e.slice_trail_r=!0,e.key=!0;break;case 2:e.slice_tsa_n=!0;break;case 3:e.slice_tsa_r=!0,e.key=!0;break;case 4:e.slice_stsa_n=!0;break;case 5:e.slice_stsa_r=!0,e.key=!0;break;case 6:e.slice_radl_n=!0;break;case 7:e.slice_radl_r=!0,e.key=!0;break;case 8:e.slice_rasl_n=!0;break;case 9:e.slice_rasl_r=!0,e.key=!0;break;case 16:e.slice_bla_w_lp=!0;break;case 17:e.slice_bla_w_radl=!0;break;case 18:e.slice_bla_n_lp=!0;break;case 19:e.slice_idl_w_radl=!0,e.key=!0;break;case 20:e.slice_idr_n_lp=!0,e.key=!0;break;case 21:e.slice_cra_nut=!0,e.key=!0;break;case 32:e.vps=!0;break;case 33:e.sps=vt.parseSPS(e.body);break;case 34:e.pps=!0;break;case 35:break;case 36:e.aud=!0;break;case 37:e.eob=!0;break;case 38:e.fd=!0;break;case 39:case 40:e.sei=bt.parse(e.body.slice(1))}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(i=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=r)),{pos:t,headerLength:i}}}]),e}(),St=vt,At=kt,wt=Object.freeze({__proto__:null,SpsParserHEVC:St,NalUnitHEVC:At}),Dt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Rt=Xe.REMUX_EVENTS,Lt=Fe.caculate,Ot=Ze,Ut=ct,Bt=wt,xt=function(){function e(){var t=this;(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.TAG="Compatibility",this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this._lastSegmentId=0,this._currentSegmentId=0,this._format="",this.videoLastSample=null,this.audioLastSample=null,Object.defineProperties(this,{_videoLargeGap:{set:function(e){t.___videoLargeGap=e,0!==e&&t.emit(Rt.DETECT_LARGE_GAP,"video",e)},get:function(){return t.___videoLargeGap||0}},_audioLargeGap:{set:function(e){t.___audioLargeGap=e,0!==e&&t.emit(Rt.DETECT_LARGE_GAP,"audio",e)},get:function(){return t.___audioLargeGap||0}}}),this.audioUnsyncTime=0}return Dt(e,[{key:"init",value:function(){this.before(Rt.REMUX_MEDIA,this.doFix.bind(this))}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this._audioLargeGap=0,this._videoLargeGap=0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.audioUnsyncTime=0}},{key:"_isSegmentsContinuous",value:function(){return this.isTs&&this._currentSegmentId-this._lastSegmentId==1}},{key:"doFix",value:function(t){this._format=t;var i=void 0,r=void 0,n=void 0;this.videoTrack.samples.length&&(i=(r=this.videoTrack.samples[0]).options,ze.long&&ze.log(this.TAG,this.videoTrack.samples.slice())),this.audioTrack.samples.length&&(n=this.audioTrack.samples[0],ze.long&&ze.log(this.TAG,this.audioTrack.samples.slice())),"ts"===t&&(this._currentSegmentId=i&&i.id||this._currentSegmentId+1),ze.log(this.TAG,"lastSeg:"+this._lastSegmentId+" , currentSeg:"+this._currentSegmentId+", discontinue:"+(i&&i.discontinue)+" vSamp0:"+(r&&r.dts)+" aSamp0:"+(n&&n.dts));var a=this.getFirstSample(),s=a.isFirstAudioSamples,o=a.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixVideoRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples);var u=e.detectChangeStream(this.videoTrack.samples,o),l=u.changed,d=u.changedIdxes;if(l){for(var h=!1,c=0;c<d.length;c++)this.fixChangeStreamVideo(d[c],o)&&(h=!0);h||this.doFixVideo(o)}else!this._isSegmentsContinuous()&&i&&void 0!==i.start?(ze.log(this.TAG,"fix video for _isSegmentsContinuous()"),this.videoLastSample=null,this.doFixVideo(o,i.start),this.emit(Rt.DETECT_FRAG_ID_DISCONTINUE,i.start/1e3)):this.doFixVideo(o);var f=e.detectChangeStream(this.audioTrack.samples,s),p=f.changed,y=f.changedIdxes;if(p){for(var v=!1,_=0;_<y.length;_++)this.fixChangeStreamAudio(y[_],s)&&(v=!0);if(v)return;this.doFixAudio(s)}else!this._isSegmentsContinuous()&&i&&void 0!==i.start?(ze.log(this.TAG,"fix audio for _isSegmentsContinuous()"),this.nextAudioDts=null,this.doFixAudio(s,i.start),this.emit(Rt.DETECT_FRAG_ID_DISCONTINUE,i.start/1e3)):this.doFixAudio(s);this.removeInvalidSamples(),this._lastSegmentId=this._currentSegmentId}},{key:"doFixVideo",value:function(t,i){for(var r=this.videoTrack,n=r.samples,a=r.meta,s=n.length,o=0;o<s;o++){var u=n[o];u.originDts=u.dts,u.originPts=u.pts}if(n&&s&&this._firstVideoSample){var l=n[0];if(ze.log(this.TAG,"doFixVideo:: lastVideoDts: "+this.lastVideoDts+" ,  _videoLargeGap: "+this._videoLargeGap+" ,streamChangeStart:"+i+", lastVideoSample:[dts="+(this.videoLastSample&&this.videoLastSample.dts)+" , pts="+(this.videoLastSample&&this.videoLastSample.pts)+"] ,  firstDTS:"+l.dts+" ,firstPTS:"+l.pts+" ,lastDTS:"+n[s-1].dts+" , lastPTS: "+n[s-1].pts),!t&&null===this.videoLastSample&&l.options&&l.options.start&&void 0!==i&&(i=l.options.start),!t&&void 0===i&&this.videoLastSample&&e.detectVideoLargeGap(this.isTs,this.videoLastSample?this.videoLastSample.dts:0,l.dts+this._videoLargeGap)&&(this._videoLargeGap=this.videoLastSample.dts+a.refSampleDuration-l.dts),0!==this._videoLargeGap&&e.doFixLargeGap(n,this._videoLargeGap),t||void 0===i||(this._videoLargeGap=i-l.dts,e.doFixLargeGap(n,this._videoLargeGap)),t&&this._firstAudioSample){var d=this._firstVideoSample.originDts,h=d-(this._firstAudioSample.originDts||this._firstAudioSample.dts);if(h>2*a.refSampleDuration&&h<10*a.refSampleDuration){for(var c=Math.floor(h/a.refSampleDuration),f=0;f<c;f++){var p=Object.assign({},l);p.dts=d-(f+1)*a.refSampleDuration,p.pts=p.dts+p.cts,n.unshift(p),this.filledVideoSamples.push({dts:p.dts,size:p.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else Math.abs(h)>2*a.refSampleDuration&&!this._videoLargeGap&&(this._videoLargeGap=-1*h,e.doFixLargeGap(n,-1*h))}for(var y=n.length,v=1;v<y;v++){var _=n[v],m=n[v-1],g=_.dts-_.pts;Math.abs(g)<2e3&&Math.abs(_.dts-m.dts)>1e4&&(_.dts=m.dts+a.refSampleDuration,_.pts=m.pts+a.refSampleDuration)}var E=n.pop();if(n.length&&(n[n.length-1].duration=E.dts-n[n.length-1].dts),this.isTs&&y<4){var b=n[n.length-1],T=(b=b||E).options&&b.options.duration,k=a.refSampleDuration;if(T&&k&&T/k>5)for(var S=b.pts,A=b.dts,w=0;w<3;w++){A+=k,S+=k;var D=Object.assign({},b,{dts:A,pts:S});2===w&&(D.duration=T),n.push(D)}E=null}if(this.videoLastSample){var R=this.videoLastSample;R.duration=l.dts-R.dts,n.unshift(this.videoLastSample)}this.videoLastSample=E,n[n.length-1]&&(this.lastVideoDts=n[n.length-1].dts),this.videoTrack.samples=n}}},{key:"doFixAudio",value:function(t,i){var r=this,n=this.audioTrack,a=n.samples,s=n.meta;if(a&&a.length){this.fixAudioRefSampleDuration(s);for(var o=0,u=a.length;o<u;o++){var l=a[o];l.originDts=l.dts}var d=a.length,h=qe.getSilentFrame(s.codec,s.channelCount),c=Math.floor(s.refSampleDuration),f=this._firstAudioSample,p=a[0];if(ze.log(this.TAG,"doFixAudio:: audioDtsBase:"+this.audioDtsBase+" ,  _audioLargeGap: "+this._audioLargeGap+", streamChangeStart:"+i+" ,  nextAudioDts:"+this.nextAudioDts+",  audio: firstDTS:"+p.dts+" ,firstPTS:"+p.pts+" ,lastDTS:"+a[d-1].dts+" , lastPTS: "+a[d-1].pts),!t&&null===this.nextAudioDts&&p.options&&p.options.start&&void 0!==i&&(i=p.options.start),!t&&void 0===i&&this.nextAudioDts&&e.detectAudioLargeGap(this.nextAudioDts||0,p.dts+this._audioLargeGap)){var y=this.nextAudioDts-p.dts;this._audioLargeGap=Math.abs(y-this._videoLargeGap)<200?this._videoLargeGap:y}if(0!==this._audioLargeGap?(e.doFixLargeGap(a,this._audioLargeGap),0===this._videoLargeGap||this._audioLargeGap!==this.preAudioGap&&this._videoLargeGap===this.preVideoGap?(this.emit(Rt.DETECT_CHANGE_STREAM_DISCONTINUE,"audio"),this.preVideoGap=void 0,this.preAudioGap=void 0):(this.preVideoGap=this._videoLargeGap,this.preAudioGap=this._audioLargeGap)):t||void 0===i&&!e.detectAudioLargeGap(this.nextAudioDts,p.dts)||(void 0!==i&&(this.nextAudioDts=i),this._audioLargeGap=this.nextAudioDts-p.dts,p.options.start&&!p.options.start.isContinue&&e.doFixLargeGap(a,this._audioLargeGap)),this._firstVideoSample&&t){var v=this._firstVideoSample.originDts||this._firstVideoSample.dts,_=f.dts-v;if(_===this._videoLargeGap);else if(_>s.refSampleDuration&&_<10*s.refSampleDuration){for(var m=Math.floor((f.dts-v)/s.refSampleDuration),g=0;g<m;g++){var E={data:h,datasize:h.byteLength,dts:f.dts-(g+1)*s.refSampleDuration,filtered:0};a.unshift(E),this.filledAudioSamples.push({dts:E.dts,size:E.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else _<-1*s.refSampleDuration&&(this._audioLargeGap=-1*_,e.doFixLargeGap(a,-1*_))}var b=void 0,T=a[0].dts;if(this.nextAudioDts){b=T-this.nextAudioDts;var k=Math.abs(b);if(b>=c&&b<1e4&&h){for(var S=Math.ceil(b/c),A=0;A<S;A++){var w=T-(A+1)*c,D={dts:w>this.nextAudioDts?w:this.nextAudioDts,pts:w>this.nextAudioDts?w:this.nextAudioDts,datasize:h.byteLength,filtered:0,data:h};this.filledAudioSamples.push({dts:D.dts,size:D.data.byteLength}),this.audioTrack.samples.unshift(D),p=D}this.emit(Rt.DETECT_AUDIO_GAP,b,S)}else k<s.refSampleDuration&&k>0?(p.dts=this.nextAudioDts,p.pts=this.nextAudioDts):b<0&&k<c&&(e.doFixLargeGap(a,-1*b),this.emit(Rt.DETECT_AUDIO_OVERLAP,b))}for(var R=a[0].dts+c,L=1;L<a.length;){var O=a[L],U=O.dts-R;if(U<=-1*c)ze.warn("drop 1 audio sample for "+U+" ms overlap"),a.splice(L,1);else if(U>=10*c){var B=Math.round(U/c);if(B>1e3)break;ze.warn(this.TAG,"inject "+B+" audio frame for "+U+" ms gap");for(var x=0;x<B;x++){var C={data:h,datasize:h.byteLength,dts:R,originDts:R,filtered:0};a.splice(L,0,C),R+=c,L++}O.dts=O.pts=O.originDts=R,R+=c,L++}else O.dts=O.pts=O.originDts=R,R+=c,L++}var M=s.refSampleDuration-c;a.forEach((function(e,t){if(0!==t){var i=a[t-1];e.dts=e.pts=i.dts+i.duration}e.duration=c,r.audioUnsyncTime=Lt.fixedFloat(r.audioUnsyncTime+M,2),r.audioUnsyncTime>=1&&(e.duration+=1,r.audioUnsyncTime-=1)}));var P=a[a.length-1],I=P.dts,G=P.duration;this.lastAudioSamplesLen=d,this.nextAudioDts=I+(G||c),this.audioTrack.samples=e.sortAudioSamples(a)}}},{key:"fixChangeStreamVideo",value:function(e){ze.log(this.TAG,"fixChangeStreamVideo(), changeIdx=",e);var t=this.videoTrack.samples,i=0===e?this.lastVideoDts?this.lastVideoDts:this.getStreamChangeStart(t[0]):t[e-1].dts,r=t[e].dts,n=Math.abs(i-r)<=1e4;if(this.emit(Rt.DETECT_CHANGE_STREAM,"video",r),n)return t[e].options?t[e].options.isContinue=!0:t[e].options={isContinue:!0},!1;this.emit(Rt.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:i,curDts:r});var a,s=t.slice(0,e),o=t.slice(e),u=t[e];return this._videoLargeGap=0,this.videoLastSample=null,this.lastVideoDts=null,a=u.options&&void 0!==u.options.start?u.options.start:i-this.videoDtsBase,this.videoTrack.samples=t.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=t.slice(e),this.doFixVideo(!1,a),this.videoTrack.samples=s.concat(o),!0}},{key:"fixChangeStreamAudio",value:function(e){ze.log(this.TAG,"fixChangeStreamAudio(), changeIdx=",e);var t=this.audioTrack.samples,i=0===e?this.lastAudioDts:t[e-1].dts,r=t[e].dts,n=Math.abs(i-r)<=1e4;if(this.emit(Rt.DETECT_CHANGE_STREAM,"audio",r),n)return t[e].options?t[e].options.isContinue=!0:t[e].options={isContinue:!0},!1;this.emit(Rt.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:i,curDts:r}),this._audioLargeGap=0;var a=this.nextAudioDts;this.nextAudioDts=null;var s=t.slice(0,e),o=t.slice(e),u=t[e],l=void 0;return u.options&&void 0!==u.options.start?l=u.options.start:(l=a,u.options.isContinue=!0),this.audioTrack.samples=s,this.doFixAudio(!1),this.audioTrack.samples=o,this.doFixAudio(!1,l),this.audioTrack.samples=s.concat(o),!0}},{key:"getFirstSample",value:function(){var t=this.videoTrack.samples,i=this.audioTrack.samples,r=!1,n=!1;return!this._firstVideoSample&&t.length&&(this._firstVideoSample=e.findFirstVideoSample(t),this.removeInvalidSamples(),r=!0),!this._firstAudioSample&&i.length&&(this._firstAudioSample=e.findFirstAudioSample(i),this.removeInvalidSamples(),n=!0),{isFirstVideoSamples:r,isFirstAudioSamples:n}}},{key:"fixVideoRefSampleDuration",value:function(t,i){if(t){var r=this.allVideoSamplesCount,n=this._firstVideoSample.dts,a=this.filledVideoSamples.length;if(e.isRefSampleDurationValid(t.refSampleDuration)){if(t.refSampleDuration&&i.length>=5){var s=(i[i.length-1].dts-i[0].dts)/(i.length-1);if(s>0&&s<1e3){var o=Math.floor(Math.abs(t.refSampleDuration-s)<=5?t.refSampleDuration:s);e.isRefSampleDurationValid(o)&&(t.refSampleDuration=o)}}}else if(i.length>=1){var u=i[i.length-1].dts,l=Math.floor((u-n)/(r+a-1));e.isRefSampleDurationValid(l)&&(t.refSampleDuration=l)}e.isRefSampleDurationValid(t.refSampleDuration)||(t.refSampleDuration=66)}}},{key:"fixAudioRefSampleDuration",value:function(e){e&&(e.refSampleDuration=1024*e.timescale/e.sampleRate)}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var e=this.audioTrack.samples[0],t=this.videoTrack.samples[0];e&&(this.audioTrack.samples=this.audioTrack.samples.filter((function(t,i){return t===e||t.dts>=e.dts}))),t&&(this.videoTrack.samples=this.videoTrack.samples.filter((function(e,i){return e===t||e.dts>=t.dts})))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"isTs",get:function(){return"ts"===this._format}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}},{key:"audioDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._audioDtsBase?e._audioDtsBase:this.dtsBase}},{key:"videoDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._videoDtsBase?e._videoDtsBase:this.dtsBase}}],[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:[].concat(b(e)).sort((function(e,t){return e.dts-t.dts}))}},{key:"isRefSampleDurationValid",value:function(e){return e&&e>0&&!Number.isNaN(e)}},{key:"findFirstAudioSample",value:function(t){return t&&0!==t.length?e.sortAudioSamples(t)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=[].concat(b(e)).sort((function(e,t){return e.dts-t.dts})),i=0,r=t.length;i<r;i++)if(t[i].isKeyframe)return t[i]}},{key:"detectVideoLargeGap",value:function(e,t,i){if(null!==t){var r=e?1e3:1e4;return t-i>=r||i-t>=r}}},{key:"detectAudioLargeGap",value:function(e,t){if(null!==e)return e-t>=1e3||t-e>=1e3}},{key:"doFixLargeGap",value:function(e,t){for(var i=0,r=e.length;i<r;i++){var n=e[i];n.dts+=t,n.pts&&(n.pts+=t)}var a=e[0];a&&0===a.dts&&(a.dts=a.pts=1)}},{key:"detectChangeStream",value:function(e,t){for(var i=!1,r=[],n=0,a=e.length;n<a;n++){var s=e[n];!s.options||!s.options.meta||t&&0===n||(i=!0,r.push(n))}return{changed:i,changedIdxes:r}}}]),e}(),Ct="function"==typeof Symbol&&"symbol"==s(Symbol.iterator)?function(e){return void 0===e?"undefined":s(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":s(e)},Mt=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],r=!0,n=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(i.push(s.value),!t||i.length!==t);r=!0);}catch(e){n=!0,a=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw a}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},Pt="function"==typeof Symbol&&"symbol"===Ct(Symbol.iterator)?function(e){return void 0===e?"undefined":Ct(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":Ct(e)},It=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Gt=Xe.DEMUX_EVENTS,Ft=Ut.NalUnit,Nt=Bt.NalUnitHEVC,jt={1:["video","MPEG-1"],2:["video","MPEG-2"],27:["video","AVC.H264"],36:["video","HVC.H265"],234:["video","VC-1"],3:["audio","MPEG-1"],4:["audio","MPEG-2"],15:["audio","MPEG-2.AAC"],17:["audio","MPEG-4.AAC"],128:["audio","LPCM"],129:["audio","AC3"],6:["audio","AC3"],130:["audio","DTS"],131:["audio","Dolby TrueHD"],132:["audio","AC3-Plus"],133:["audio","DTS-HD"],134:["audio","DTS-MA"],161:["audio","AC3-Plus-SEC"],162:["audio","DTS-HD-SEC"]},Vt=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.TAG="TsDemuxer",this.configs=Object.assign({},t),this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1,this.gopId=0}return It(e,[{key:"init",value:function(){this.on(Gt.DEMUX_START,this.demux.bind(this))}},{key:"demux",value:function(t){var i=this;if(t&&ze.log(this.TAG,"do demux: id="+t.id+",demuxing="+this.demuxing),!this.demuxing){for(var r=this.inputBuffer,n={pat:[],pmt:[]},a={};r.length>=188;){for(r.length>=1&&71!==r.array[0][r.offset]&&this.emit(Gt.DEMUX_ERROR,this.TAG,new Error("Untrust sync code: "+r.array[0][r.offset]+", try to recover;"),!1);r.length>=1&&71!==r.array[0][r.offset];)r.shift(1);if(!(r.length<188)){var s=r.shift(188),o=new de(s.buffer),u={};e.read(o,u,n);var l=a[u.header.pid];u.pes?(u.pes.codec=u.header.codec,u.pes.streamType=u.header.streamType,a[u.header.pid]||(a[u.header.pid]=[]),a[u.header.pid].push(u.pes),u.pes.ES.buffer=[u.pes.ES.buffer]):l&&l[l.length-1].ES.buffer.push(u.payload.stream)}}setTimeout((function(){for(var r=Object.assign({},t),n=Object.assign({},t),s=i._hasVideoMeta&&!i._hasAudioMeta,o=i._hasAudioMeta&&!i._hasVideoMeta,u=0;u<Object.keys(a).length;u++)for(var l=a[Object.keys(a)[u]],d=0;d<l.length;d++){var h=l[d];h.id=Object.keys(a)[u],"audio"!==h.type||s||15!==h.streamType&&17!==h.streamType?"video"!==h.type||o||(h.ES.buffer=e.mergeVideoES(h.ES.buffer),"HVC.H265"===h.codec?i.pushVideoSampleHEVC(l[d],n):i.pushVideoSample(l[d],n),n={}):(h.ES.buffer=e.mergeAudioES(h.ES.buffer),i.pushAudioSample(h,r),r={})}var c=i._tracks.videoTrack;c&&!c.meta&&(c.samples=[],ze.warn(i.TAG,"no sps detected"))})),setTimeout((function(){i.emit(Gt.DEMUX_COMPLETE)}))}}},{key:"pushAudioSample",value:function(t,i){var r,n=void 0;this._tracks&&this._tracks.audioTrack||(this._tracks.audioTrack=new fe),n=this._tracks.audioTrack;var a=new ve({audioSampleRate:t.ES.frequence,sampleRate:t.ES.frequence,channelCount:t.ES.channel,codec:"mp4a.40."+t.ES.audioObjectType,originCodec:"mp4a.40."+t.ES.originAudioObjectType,originObjectType:t.ES.originAudioObjectType,config:t.ES.audioConfig,id:2,sampleRateIndex:t.ES.frequencyIndex});a.refSampleDuration=Math.floor(1024/a.audioSampleRate*a.timescale);var s=e.compaireMeta(n.meta,a,!0);this._hasAudioMeta&&s||(n.meta=a,this._hasAudioMeta=!0,i?i.meta=Object.assign({},a):i={meta:Object.assign({},a)},this.emit(Gt.METADATA_PARSED,"audio"));var o=0,u=[];t.ES.buffer.skip(t.pesHeaderLength+9);for(var l=!1;t.ES.buffer.position<t.ES.buffer.length;)if(Ot.isHeader(new Uint8Array(t.ES.buffer.buffer),t.ES.buffer.position)&&t.ES.buffer.position+5<t.ES.buffer.length){var d=Ot.appendFrame(n,new Uint8Array(t.ES.buffer.buffer),t.ES.buffer.position,t.pts,o);if(!d||!d.sample)break;t.ES.buffer.skip(d.length);var h=new me({dts:d.sample.dts,pts:d.sample.pts,data:d.sample.unit,options:l?{}:i});i.meta&&(l=!0),u.push(h),o++}else t.ES.buffer.skip(1);for(var c=0;c<u.length;c++){var f=u[c];f.dts=f.pts=Math.ceil(f.pts/90)}(r=n.samples).push.apply(r,u)}},{key:"pushVideoSample",value:function(t,i){var r=Ft.getNalunits(t.ES.buffer),n=void 0,a=new _e;this._tracks&&this._tracks.videoTrack||(this._tracks.videoTrack=new ye),n=this._tracks.videoTrack;for(var s=0,o=!1,u=!1,l=null,d=0;d<r.length;d++){var h=r[d];if(h.sps){o=h,n.sps=h.body,a.sps=h.body,a.chromaFormat=o.sps.chroma_format,a.codec="avc1.";for(var c=1;c<4;c++){var f=o.body[c].toString(16);f.length<2&&(f="0"+f),a.codec+=f}a.codecHeight=o.sps.codec_size.height,a.codecWidth=o.sps.codec_size.width,a.frameRate=o.sps.frame_rate,a.id=1,a.level=o.sps.level_string,a.presentHeight=o.sps.present_size.height,a.presentWidth=o.sps.present_size.width,a.profile=o.sps.profile_string,a.refSampleDuration=Math.floor(a.timescale*(o.sps.frame_rate.fps_den/o.sps.frame_rate.fps_num)),a.sarRatio=o.sps.sar_ratio?o.sps.sar_ratio:o.sps.par_ratio}else h.pps?(n.pps=h.body,a.pps=h.body,u=h):h.sei?l=h.sei:h.type<9&&(s+=4+h.body.byteLength)}if(o&&u){a.avcc=Ft.getAvcc(o.body,u.body);var p=e.compaireMeta(n.meta,a,!0);this._hasVideoMeta&&p||(i?i.meta=Object.assign({},a):i={meta:Object.assign({},a)},n.meta=a,this._hasVideoMeta=!0,this.emit(Gt.METADATA_PARSED,"video"))}for(var y=new Uint8Array(s),v=0,_=!1,m=0;m<r.length;m++){var g=r[m];if(!(g.type&&g.type>=9)){var E=g.body.byteLength;g.idr&&(_=!0),g.pps||g.sps||g.sei||(y.set(new Uint8Array([E>>>24&255,E>>>16&255,E>>>8&255,255&E]),v),v+=4,y.set(g.body,v),v+=E)}}var b=parseInt(t.dts/90),T=parseInt(t.pts/90);l&&(l.dts=b,this.emit(Gt.SEI_PARSED,l));var k=new ge({dts:b,pts:T,cts:T-b,originDts:t.dts,isKeyframe:_,data:y,nals:r,options:i,isGop:_,gopId:_?++this.gopId:this.gopId});n.samples.push(k)}},{key:"pushVideoSampleHEVC",value:function(t,i){var r=Nt.getNalunits(t.ES.buffer),n=void 0,a=new _e;a.streamType=36,this._tracks.videoTrack||(this._tracks.videoTrack=new ye),n=this._tracks.videoTrack;for(var s=0,o=!1,u=!1,l=!1,d=null,h=!1,c=!1,f=!1,p=!1,y=0;y<r.length;y++){var v=r[y];if(v.vps){if(h)continue;h=!0}else if(v.sps){if(c)continue;c=!0}else if(v.pps){if(f)continue;f=!0}else if(v.key)20!==v.type&&19!==v.type||(p=!0);else if(0===v.type);else if(35===v.type)continue;v.sps?(u=v,n.sps=v.body,a.sps=v.body,a.presentWidth=u.sps.width,a.presentHeight=u.sps.height,a.general_profile_space=u.sps.general_profile_space,a.general_tier_flag=u.sps.general_tier_flag,a.general_profile_idc=u.sps.general_profile_idc,a.general_level_idc=u.sps.general_level_idc,a.codec="hev1.1.6.L93.B0",a.chromaFormatIdc=u.sps.chromaFormatIdc,a.bitDepthLumaMinus8=u.sps.bitDepthLumaMinus8,a.bitDepthChromaMinus8=u.sps.bitDepthChromaMinus8):v.pps?(n.pps=v.body,a.pps=v.body,l=v):v.vps?(n.vps=v.body,a.vps=v.body,o=v):v.sei&&(d=v.sei),v.type<=40&&(s+=4+v.body.byteLength)}if(u&&l&&o){var _=e.compaireMeta(n.meta,a,!0);this._hasVideoMeta&&_||(i?i.meta=Object.assign({},a):i={meta:Object.assign({},a)},a.streamType=36,this._tracks.videoTrack.meta=a,this._hasVideoMeta=!0,this.emit(Gt.METADATA_PARSED,"video"))}var m=new Uint8Array(s),g=0,E=!1;h=!1,c=!1,f=!1;for(var b=0;b<r.length;b++){var T=r[b];if(!(T.type&&T.type>40)){if(T.vps){if(h)continue;h=!0}else if(T.sps){if(c)continue;c=!0}else if(T.pps){if(f)continue;f=!0}else if(T.key);else if(0===T.type);else if(35===T.type)continue;var k=T.body.byteLength;T.key&&(E=!0),m.set(new Uint8Array([k>>>24&255,k>>>16&255,k>>>8&255,255&k]),g),g+=4,m.set(T.body,g),g+=k}}var S=parseInt(t.dts/90),A=parseInt(t.pts/90);d&&(d.dts=S,this.emit(Gt.SEI_PARSED,d));var w=new ge({dts:S,pts:A,cts:A-S,originDts:t.dts,isKeyframe:E,data:m,nals:r,options:i,isGop:p,gopId:p?++this.gopId:this.gopId});n.samples.push(w)}},{key:"destory",value:function(){this.off(Gt.DEMUX_START,this.demux),this.configs={},this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1}},{key:"inputBuffer",get:function(){return this._context.getInstance(this.configs.inputbuffer)}},{key:"_tracks",get:function(){return this._context.getInstance("TRACKS")}}],[{key:"compaireArray",value:function(e,t,i){var r=0,n=0;if("Uint8Array"===i?(r=e.byteLength,n=t.byteLength):"Array"===i&&(r=e.length,n=t.length),r!==n)return!1;for(var a=0;a<r;a++)if(e[a]!==t[a])return!1;return!0}},{key:"compaireMeta",value:function(t,i,r){if(!t||!i)return!1;for(var n=0,a=Object.keys(t).length;n<a;n++){var s=t[Object.keys(t)[n]],o=i[Object.keys(t)[n]];if(!s&&!o)return!0;if(void 0===s&&o||s&&void 0===o)return!1;if("object"!==(void 0===s?"undefined":Pt(s))){if(r&&"duration"!==Object.keys(t)[n]&&"refSampleDuration"!==Object.keys(t)[n]&&"refSampleDurationFixed"!==Object.keys(t)[n]&&s!==o)return!1}else if(void 0!==s.byteLength){if(void 0===o.byteLength)return!1;if(!e.compaireArray(s,o,"Uint8Array"))return!1}else if(void 0!==s.length){if(void 0===o.length)return!1;if(!e.compaireArray(s,o,"Array"))return!1}else if(!e.compaireMeta(s,o))return!1}return!0}},{key:"mergeVideoES",value:function(e){for(var t=void 0,i=0,r=0,n=0;n<e.length;n++)i+=e[n].length-e[n].position;t=new Uint8Array(i);for(var a=0;a<e.length;a++){var s=e[a];t.set(new Uint8Array(s.buffer,s.position),r),r+=s.length-s.position}return new de(t.buffer)}},{key:"mergeAudioES",value:function(e){for(var t=void 0,i=0,r=0,n=0;n<e.length;n++)i+=e[n].length;t=new Uint8Array(i);for(var a=0;a<e.length;a++){var s=e[a];t.set(new Uint8Array(s.buffer),r),r+=s.length}return new de(t.buffer)}},{key:"read",value:function(t,i,r){e.readHeader(t,i),e.readPayload(t,i,r),"MEDIA"!==i.header.packet||1!==i.header.payload||i.unknownPIDs||(i.pes=e.PES(i))}},{key:"readPayload",value:function(t,i,r){var n=i.header.pid;switch(n){case 0:e.PAT(t,i,r);break;case 1:e.CAT(t,i,r);break;case 2:e.TSDT(t,i,r);break;case 8191:break;default:for(var a=!1,s=0,o=r.pat.length;s<o;s++)if(r.pat[s].pid===n){a=!0;break}if(a)e.PMT(t,i,r);else{for(var u=[],l=0,d=r.pmt.length;l<d;l++)if(r.pmt[l].pid===n){u.push(r.pmt[l]);break}if(u.length>0){var h=u[0].streamType;e.Media(t,i,h)}else i.unknownPIDs=!0}}}},{key:"readHeader",value:function(e,t){var i={};i.sync=e.readUint8();var r=e.readUint16();i.error=r>>>15,i.payload=r>>>14&1,i.priority=r>>>13&1,i.pid=8191&r,r=e.readUint8(),i.scrambling=r>>6&3,i.adaptation=r>>4&3,i.continuity=15&r,i.packet=0===i.pid?"PAT":"MEDIA",t.header=i}},{key:"PAT",value:function(e,t,i){var r={},n=e.readUint8();e.skip(n),n=e.readUint8(),r.tabelID=n,n=e.readUint16(),r.error=n>>>7,r.zero=n>>>6&1,r.sectionLength=4095&n,r.streamID=e.readUint16(),r.current=1&e.readUint8(),r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8();for(var a=(r.sectionLength-9)/4,s=[],o=0;o<a;o++){var u=e.readUint16(),l=8191&e.readUint16();s.push({program:u,pid:l,type:0===u?"network":"mapPID"})}s.length>0&&(i.pat=i.pat.concat(s)),r.list=s,r.program=e.readUint16(),r.pid=8191&e.readUint16(),t.payload=r}},{key:"PMT",value:function(e,t,i){var r={};t.header.packet="PMT";var n=e.readUint8();e.skip(n),n=e.readUint8(),r.tableID=n,n=e.readUint16(),r.sectionLength=4095&n,r.program=e.readUint16(),r.current=1&e.readUint8(),r.order=e.readUint8(),r.lastOrder=e.readUint8(),r.PCR_PID=8191&e.readUint16(),r.programLength=4095&e.readUint16();for(var a=(r.sectionLength-13)/5,s=[],o=0;o<a;o++)s.push({streamType:e.readUint8(),pid:8191&e.readUint16(),es:4095&e.readUint16()});r.list=s,this.pmt||(this.pmt=[]),i.pmt=this.pmt.concat(s.map((function(e){return{pid:e.pid,es:e.es,streamType:e.streamType,program:r.program}}))),t.payload=r}},{key:"Media",value:function(e,t,i){var r=t.header,n={},a=Mt(jt[i],2),s=a[0],o=a[1];if(r.streamType=i,r.type=s,r.codec=o,3===r.adaptation&&(n.adaptationLength=e.readUint8(),n.adaptationLength>0)){var u=e.readUint8();n.discontinue=u>>>7,n.access=u>>>6&1,n.priority=u>>>5&1,n.PCR=u>>>4&1,n.OPCR=u>>>3&1,n.splicePoint=u>>>2&1,n.transportPrivate=u>>>1&1,n.adaptationField=1&u;var l=e.position;if(1===n.PCR&&(n.programClockBase=e.readUint32()<<1,u=e.readUint16(),n.programClockBase|=u>>>15,n.programClockExtension=511&u),1===n.OPCR&&(n.originProgramClockBase=e.readUint32()<<1,u=e.readUint16(),n.originProgramClockBase+=u>>>15,n.originProgramClockExtension=511&u),1===n.splicePoint&&(n.spliceCountdown=e.readUint8()),1===n.transportPrivate)for(var d=e.readUint8(),h=[],c=0;c<d;c++)h.push(e.readUint8());if(1===n.adaptationField){var f=e.readUint8(),p=e.readUint8(),y=e.position,v=p>>>6&1,_=p>>>5&1;1==p>>>7&&(p=e.readUint16(),n.ltwValid=p>>>15,n.ltwOffset=61439&p),1===v&&(p=e.readUint24(),n.piecewiseRate=4194303&p),1===_&&(p=e.readInt8(),n.spliceType=p>>>4,n.dtsNextAU1=p>>>1&7,n.marker1=1&p,p=e.readUint16(),n.dtsNextAU2=p>>>1,n.marker2=1&p,p=e.readUint16(),n.dtsNextAU3=p),e.skip(f-1-(e.position-y))}var m=n.adaptationLength-1-(e.position-l);e.skip(m)}n.stream=new de(e.buffer.slice(e.position)),t.payload=n}},{key:"PES",value:function(t){var i={},r=t.payload.stream;if(1!==r.readUint24())i.ES={},i.ES.buffer=r;else{var n=r.readUint8();n>=224&&n<=239&&(i.type="video"),n>=192&&n<=223&&(i.type="audio");var a=r.readUint16();if(i.packetLength=a,"video"!==i.type&&"audio"!==i.type)throw new Error("format is not supported");var s=r.readUint8();if(2!=s>>>6)throw new Error("error when parse pes header");s=r.readUint8(),i.ptsDTSFlag=s>>>6,i.escrFlag=s>>>5&1,i.esRateFlag=s>>>4&1,i.dsmFlag=s>>>3&1,i.additionalFlag=s>>>2&1,i.crcFlag=s>>>1&1,i.extensionFlag=1&s,i.pesHeaderLength=r.readUint8();var o=i.pesHeaderLength;if(2===i.ptsDTSFlag){var u=[];s=r.readUint8(),u.push(s>>>1&7),s=r.readUint16(),u.push(s>>>1),s=r.readUint16(),u.push(s>>>1),i.pts=u[0]<<30|u[1]<<15|u[2],o-=5,"video"===i.type&&(i.dts=i.pts)}if(3===i.ptsDTSFlag){var l=[];s=r.readUint8(),l.push(s>>>1&7),s=r.readUint16(),l.push(s>>>1),s=r.readUint16(),l.push(s>>>1),i.pts=l[0]<<30|l[1]<<15|l[2];var d=[];s=r.readUint8(),d.push(s>>>1&7),s=r.readUint16(),d.push(s>>>1),s=r.readUint16(),d.push(s>>>1),i.dts=d[0]<<30|d[1]<<15|d[2],o-=10}if(1===i.escrFlag){var h=[],c=[];s=r.readUint8(),h.push(s>>>3&7),h.push(3&s),s=r.readUint16(),h.push(s>>>13),h.push(3&s),s=r.readUint16(),h.push(s>>>13),c.push(3&s),s=r.readUint8(),c.push(s>>>1),i.escr=300*(h[0]<<30|h[1]<<28|h[2]<<15|h[3]<<13|h[4])+(c[0]<<7|c[1]),o-=6}if(1===i.esRateFlag&&(s=r.readUint24(),i.esRate=s>>>1&4194303,o-=3),1===i.dsmFlag)throw new Error("not support DSM_trick_mode");if(1===i.additionalFlag&&(s=r.readUint8(),i.additionalCopyInfo=127&s,o-=1),1===i.crcFlag&&(i.pesCRC=r.readUint16(),o-=2),1===i.extensionFlag)throw new Error("not support extension");o>0&&r.skip(o),i.ES=e.ES(r,i.type,t.header.streamType)}return i}},{key:"ES",value:function(t,i,r){var n={};if("video"===i)n.buffer=t;else{if("audio"!==i)throw new Error("ES "+i+" is not supported");15!==r&&17!==r||(n=e.parseADTSHeader(t)),n.buffer=t}return n}},{key:"parseADTSHeader",value:function(t){var i={},r=t.readUint16();if(r>>>4!=4095)throw new Error("aac ES parse Error");return i.id=0==(r>>>3&1)?"MPEG-4":"MPEG-2",i.layer=r>>>1&3,i.absent=1&r,r=t.readUint16(),i.audioObjectType=1+(r>>>14&3),i.profile=i.audioObjectType-1,i.frequencyIndex=r>>>10&15,i.frequence=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][i.frequencyIndex],i.channel=r>>>6&7,i.frameLength=(3&r)<<11|t.readUint16()>>>5,e.getAudioConfig(i),t.skip(1),i.buffer=t,i}},{key:"TSDT",value:function(e,t,i){t.payload={}}},{key:"CAT",value:function(e,t,i){var r={};r.tableID=e.readUint8();var n=e.readUint16();r.sectionIndicator=n>>>7,r.sectionLength=4095&n,e.skip(2),n=e.readUint8(),r.version=n>>>3,r.currentNextIndicator=1&n,r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8(),this.sectionLength,r.crc32=e.readUint32(),t.payload=r}},{key:"getAudioConfig",value:function(e){var t=navigator.userAgent.toLowerCase(),i=void 0,r=void 0;e.originAudioObjectType=e.audioObjectType,/firefox/i.test(t)?e.frequencyIndex>=6?(e.audioObjectType=5,i=new Array(4),r=e.frequencyIndex-3):(e.audioObjectType=2,i=new Array(2),r=e.frequencyIndex):-1!==t.indexOf("android")?(e.audioObjectType=2,i=new Array(2),r=e.frequencyIndex):(e.audioObjectType=5,i=new Array(4),e.frequencyIndex>=6?r=e.frequencyIndex-3:(1===e.channel&&(e.audioObjectType=2,i=new Array(2)),r=e.frequencyIndex)),i[0]=e.audioObjectType<<3,i[0]|=(14&e.frequencyIndex)>>1,i[1]=(1&e.frequencyIndex)<<7,i[1]|=e.channel<<3,5===e.audioObjectType&&(i[1]|=(14&r)>>1,i[2]=(1&r)<<7,i[2]|=8,i[3]=0),e.audioConfig=i}}]),e}(),Ht=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Xt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Ht(e,null,[{key:"parse",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r={duration:0};if(t&&t.split){var n=t.split(/\r|\n/),a=(n=n.filter((function(e){return e}))).shift();if(!a.match("#EXTM3U"))throw new Error('Invalid m3u8 file: not "#EXTM3U"');a=n.shift();for(var s=!1,o=0;a;){var u=a.match(/#(.[A-Z|-]*):(.*)/),l=a.match(/#(.[A-Z|-]*)/);if(l&&u&&u.length>2)switch(u[1]){case"EXT-X-VERSION":r.version=parseInt(u[2]);break;case"EXT-X-MEDIA-SEQUENCE":r.sequence=parseInt(u[2]);break;case"EXT-X-TARGETDURATION":r.targetduration=parseFloat(u[2]);break;case"EXTINF":o=e.parseFrag(u,n,r,i,s,o),s=!1;break;case"EXT-X-KEY":e.parseDecrypt(u[2],r)}if(l&&l.length>1)switch(l[1]){case"EXT-X-DISCONTINUITY":s=!0}a=n[o++]}return r}}},{key:"parseFrag",value:function(t,i,r,n,a,s){r.frags||(r.frags=[]);var o={start:r.duration,duration:parseInt(1e3*parseFloat(t[2]))};r.duration+=o.duration;var u=i[s++];if((u.match(/#(.*):(.*)/)||u.match(/^#/))&&(u=i[s++]),u.length>0&&"/"===u.charAt(0)&&n.match(/.*\/\/.*\.\w+/g)&&(n=n.match(/.*\/\/.*\.\w+/g)[0]),u.match(/.*:\/\/.*/)){var l=e.isHTTPS;!e.envisHttps&&!(e.envisHttps=l(window.location.href))||l(u)||(u=u.replace("http:","https:")),o.url=u}else o.url=n+u;if(o.discontinue=a,r.frags.length){var d=r.frags[r.frags.length-1];o.id=d.id+1}else o.id=r.sequence||1;return r.frags.push(o),s}},{key:"parseURL",value:function(e){var t="",i=e.match(/(.*\/).*\.m3u8/);if(i&&i.length>0)for(var r=0;r<i.length;r++)i[r].match(/.*\/$/g)&&i[r].length>t.length&&(t=i[r]);return t}},{key:"parseDecrypt",value:function(e,t){t.encrypt={};var i=e.split(",");for(var r in i){var n=i[r];if(n.match(/METHOD=(.*)/)&&(t.encrypt.method=n.match(/METHOD=(.*)/)[1]),n.match(/URI="(.*)"/)&&(t.encrypt.uri=n.match(/URI="(.*)"/)[1]),n.match(/IV=0x(.*)/)){var a=n.match(/IV=0x(.*)/)[1],s=Math.ceil(a.length/2);t.encrypt.ivb=new Uint8Array(s);for(var o=s-1;o>=0;o--){var u=parseInt(a.substr(2*o,2),16);t.encrypt.ivb[o]=u}t.encrypt.iv=a}}}},{key:"isHTTPS",value:function(e){return/^https:\/\//i.test(e)}}]),e}(),Wt=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];var a=!0,s=!1,o=void 0;try{for(var u,l=r[Symbol.iterator]();!(a=(u=l.next()).done);a=!0)t+=u.value.length}catch(e){s=!0,o=e}finally{try{!a&&l.return&&l.return()}finally{if(s)throw o}}var d=new e(t),h=0,c=!0,f=!1,p=void 0;try{for(var y,v=r[Symbol.iterator]();!(c=(y=v.next()).done);c=!0){var _=y.value;d.set(_,h),h+=_.length}}catch(e){f=!0,p=e}finally{try{!c&&v.return&&v.return()}finally{if(f)throw p}}return d}}));T(Wt);var zt=T(k((function(e){var t=function(e){return e&&e.__esModule?e:{default:e}}(Wt);e.exports=t.default}))),Yt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),qt=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.buffer=t||new Uint8Array(0)}return Yt(e,[{key:"write",value:function(){for(var e=this,t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];i.forEach((function(t){e.buffer=zt(Uint8Array,e.buffer,t)}))}}],[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){var t="";return e.forEach((function(e){t+=function(e){return e.toString(16).padStart(2,"0")}(e)})),parseInt(t,16)}}]),e}(),Kt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Zt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Kt(e,null,[{key:"size",value:function(e){return qt.writeUint32(e)}},{key:"initBox",value:function(t,i){for(var r=new qt,n=arguments.length,a=Array(n>2?n-2:0),s=2;s<n;s++)a[s-2]=arguments[s];return r.write.apply(r,[e.size(t),e.type(i)].concat(a)),r.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"ftypHEVC",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,100,97,115,104]))}},{key:"moov",value:function(t){var i=t.type,r=t.meta,n=8,a=e.mvhd(r.duration,r.timescale),s=void 0;s="video"===i?e.videoTrak(r):e.audioTrak(r);var o=e.mvex(r.duration,r.timescale||1e3,r.id);return[a,s,o].forEach((function(e){n+=e.byteLength})),e.initBox(n,"moov",a,s,o)}},{key:"mvhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,r=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.initBox(8+r.length,"mvhd",new Uint8Array(r))}},{key:"videoTrak",value:function(t){var i=8,r=e.tkhd({id:1,duration:t.duration,timescale:t.timescale||1e3,width:t.presentWidth,height:t.presentHeight,type:"video"}),n=e.mdia({type:"video",timescale:t.timescale||1e3,duration:t.duration,avcc:t.avcc,parRatio:t.parRatio,width:t.presentWidth,height:t.presentHeight,streamType:t.streamType});return[r,n].forEach((function(e){i+=e.byteLength})),e.initBox(i,"trak",r,n)}},{key:"audioTrak",value:function(t){var i=8,r=e.tkhd({id:2,duration:t.duration,timescale:t.timescale||1e3,width:0,height:0,type:"audio"}),n=e.mdia({type:"audio",timescale:t.timescale||1e3,duration:t.duration,channelCount:t.channelCount,samplerate:t.sampleRate,config:t.config});return[r,n].forEach((function(e){i+=e.byteLength})),e.initBox(i,"trak",r,n)}},{key:"tkhd",value:function(t){var i=t.id,r=t.duration,n=t.width,a=t.height,s=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>>8&255,255&n,0,0,a>>>8&255,255&a,0,0]);return e.initBox(8+s.byteLength,"tkhd",s)}},{key:"edts",value:function(t){var i=new qt,r=t.duration,n=t.mediaTime;return i.write(e.size(36),e.type("edts")),i.write(e.size(28),e.type("elst")),i.write(new Uint8Array([0,0,0,1,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,0,0,0,1])),i.buffer}},{key:"mdia",value:function(t){var i=8,r=e.mdhd(t.timescale,t.duration),n=e.hdlr(t.type),a=e.minf(t);return[r,n,a].forEach((function(e){i+=e.byteLength})),e.initBox(i,"mdia",r,n,a)}},{key:"mdhd",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,i=arguments[1],r=new Uint8Array([0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]);return e.initBox(12+r.byteLength,"mdhd",e.extension(0,0),r)}},{key:"hdlr",value:function(t){var i=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(i.splice.apply(i,[8,4].concat([115,111,117,110])),i.splice.apply(i,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),e.initBox(8+i.length,"hdlr",new Uint8Array(i))}},{key:"minf",value:function(t){var i=8,r="video"===t.type?e.vmhd():e.smhd(),n=e.dinf(),a=e.stbl(t);return[r,n,a].forEach((function(e){i+=e.byteLength})),e.initBox(i,"minf",r,n,a)}},{key:"vmhd",value:function(){return e.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return e.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var t=new qt;return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1])),t.buffer}},{key:"stbl",value:function(t){var i=8,r=e.stsd(t),n=e.stts(),a=e.stsc(),s=e.stsz(),o=e.stco();return[r,n,a,s,o].forEach((function(e){i+=e.byteLength})),e.initBox(i,"stbl",r,n,a,s,o)}},{key:"stsd",value:function(t){var i;return i="audio"===t.type?e.mp4a(t):36===t.streamType?e.hvc1(t):e.avc1(t),e.initBox(16+i.byteLength,"stsd",e.extension(0,0),new Uint8Array([0,0,0,1]),i)}},{key:"mp4a",value:function(t){var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),r=e.esds(t.config);return e.initBox(8+i.byteLength+r.byteLength,"mp4a",i,r)}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],i=t.length,r=new qt,n=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return r.write(e.size(8+n.byteLength),e.type("esds"),n),r.buffer}},{key:"avc1",value:function(t){var i=new qt,r=t.width,n=t.height,a=t.parRatio.height,s=t.parRatio.width,o=t.avcc,u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r>>8&255,255&r,n>>8&255,255&n,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),d=new Uint8Array([a>>24,a>>16&255,a>>8&255,255&a,s>>24,s>>16&255,s>>8&255,255&s]);return i.write(e.size(40+u.byteLength+o.byteLength+l.byteLength),e.type("avc1"),u,e.size(8+o.byteLength),e.type("avcC"),o,e.size(20),e.type("btrt"),l,e.size(16),e.type("pasp"),d),i.buffer}},{key:"hvc1",value:function(t){var i=new qt,r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255,0,0,0,122,104,118,99,67,1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64]);return i.write(e.size(8+r.byteLength+10),e.type("hvc1"),r,e.size(10),e.type("fiel"),new Uint8Array([1,0])),i.buffer}},{key:"stts",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stts",t)}},{key:"stsc",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stsc",t)}},{key:"stco",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stco",t)}},{key:"stsz",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return e.initBox(20,"stsz",t)}},{key:"mvex",value:function(t){var i=arguments[2],r=new qt,n=qt.writeUint32(t);return r.write(e.size(56),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),n,e.trex(i)),r.buffer}},{key:"trex",value:function(t){var i=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.initBox(8+i.byteLength,"trex",i)}},{key:"moof",value:function(t){var i=8,r=e.mfhd(),n=e.traf(t);return[r,n].forEach((function(e){i+=e.byteLength})),e.initBox(i,"moof",r,n)}},{key:"mfhd",value:function(){var t=qt.writeUint32(e.sequence);return e.sequence+=1,e.initBox(16,"mfhd",e.extension(0,0),t)}},{key:"traf",value:function(t){var i=8,r=e.tfhd(t.id),n=e.tfdt(t.time),a=e.sdtp(t),s=e.trun(t,a.byteLength);return[r,n,s,a].forEach((function(e){i+=e.byteLength})),e.initBox(i,"traf",r,n,s,a)}},{key:"tfhd",value:function(t){var i=qt.writeUint32(t);return e.initBox(16,"tfhd",e.extension(0,0),i)}},{key:"tfdt",value:function(t){return e.initBox(16,"tfdt",e.extension(0,0),qt.writeUint32(t))}},{key:"trun",value:function(t,i){var r=new qt,n=qt.writeUint32(t.samples.length),a=qt.writeUint32(92+16*t.samples.length+i);return r.write(e.size(20+16*t.samples.length),e.type("trun"),new Uint8Array([0,0,15,1]),n,a),t.samples.forEach((function(e){var t=e.flags;r.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))})),r.buffer}},{key:"sdtp",value:function(t){var i=new qt;return i.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach((function(e){var t=e.flags,r=t.isLeading<<6|t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;i.write(new Uint8Array([r]))})),i.buffer}},{key:"mdat",value:function(t){var i=new qt,r=8;t.samples.forEach((function(e){r+=e.size})),i.write(e.size(r),e.type("mdat"));var n=new Uint8Array(r),a=0;return n.set(i.buffer,a),a+=8,t.samples.forEach((function(e){e.buffer.forEach((function(e){n.set(e,a),a+=e.byteLength}))})),n}}]),e}();Zt.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},Zt.sequence=1;var Qt=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),$t=Xe.REMUX_EVENTS,Jt=Xe.PLAYER_EVENTS,ei=Vt,ti=Xt,ii=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;S(this,e),this.TAG="Mp4Remuxer",this._dtsBase=1e3*t,this._audioDtsBase=null,this._videoDtsBase=null,this._isDtsBaseInited=!1;var i=He.browser;this._fillSilenceFrame="ie"===i,this.isFirstVideo=!0,this.isFirstAudio=!0,this.videoAllDuration=0,this.audioAllDuration=0,this.audioRemuxed=0,this.videoRemuxed=0}return Qt(e,[{key:"init",value:function(){this.on($t.REMUX_MEDIA,this.remux.bind(this)),this.on($t.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on($t.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this)),this.on($t.DETECT_FRAG_ID_DISCONTINUE,this.seek.bind(this)),this.on(Jt.SEEK,this.seek.bind(this))}},{key:"destroy",value:function(){this._dtsBase=-1,this._isDtsBaseInited=!1}},{key:"remux",value:function(){var e=this._context.getInstance("TRACKS"),t=e.audioTrack,i=e.videoTrack;!this._isDtsBaseInited&&this.calcDtsBase(t,i),this._remuxVideo(i),this._remuxAudio(t),ze.groupEnd()}},{key:"resetDtsBase",value:function(){this._dtsBase=0}},{key:"seek",value:function(e){ze.log(this.TAG,"set dtsBase for seek(),time=",e),this._isDtsBaseInited?(this._isDtsBaseInited=!1,this._dtsBase=1e3*e):this._dtsBase=1e3*e,this._audioDtsBase=this._videoDtsBase=null}},{key:"onMetaDataReady",value:function(e){var t;t="audio"===e?this._context.getInstance("TRACKS").audioTrack:this._context.getInstance("TRACKS").videoTrack;var i=this._context.getInstance("PRE_SOURCE_BUFFER"),r=i.getSource(e);r||(r=i.createSource(e)),r.mimetype=t.meta.codec,r.init=this.remuxInitSegment(e,t.meta),this.emit($t.INIT_SEGMENT,e)}},{key:"remuxInitSegment",value:function(e,t){ze.log(this.TAG,"remuxInitSegment: type=",e);var i=new qt,r=36===t.streamType?Zt.ftypHEVC():Zt.ftyp(),n=Zt.moov({type:e,meta:t});return i.write(r,n),i}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length){var i=t.samples[0],r=void 0;return i.options&&i.options.start&&(r=i.options.start),this._videoDtsBase=i.dts-(r||this._dtsBase),void(this._isDtsBaseInited=!0)}if(e&&e.samples.length||t&&t.samples.length){var n=null,a=null,s=null;if(e&&e.samples&&e.samples.length){var o=e.samples[0];n=o.dts,o.options&&o.options.start&&(s=o.options.start)}if(t&&t.samples&&t.samples.length){var u=t.samples[0];a=u.dts,u.options&&u.options.start&&(s=u.options.start)}this._videoDtsBase=(a||n)-(s||this._dtsBase),this._audioDtsBase=(n||a)-(s||this._dtsBase),this._dtsBase=Math.min(a,n),this._isDtsBaseInited=!0,ze.log(this.TAG,"calcDtsBase"),ze.log(this.TAG,"video first dts: "+a+" , start:"+s+" , _videoDtsBase:"+this._videoDtsBase+" , _dtsBase:"+this._dtsBase),ze.log(this.TAG,"audio first dts: "+n+" , start:"+s+" , _audioDtsBase:"+this._audioDtsBase+", _dtsBase:"+this._dtsBase)}}},{key:"_remuxVideo",value:function(e){var t=e||{};if(e&&e.samples&&e.samples.length){for(var i=t.samples,r=-1,n=null,a=[],s={samples:[]},o=1e4;i.length&&o-- >0;){var u=i.shift(),l=u.isKeyframe,d=u.options;if(!this.isFirstVideo&&d&&d.meta){n=this.remuxInitSegment("video",d.meta),d.meta=null,i.unshift(u),d.isContinue||(this._videoDtsBase=0);break}var h=Math.max(0,u.dts-this.videoDtsBase);-1===r&&(r=h);var c=void 0,f=void 0;void 0!==u.pts&&(c=(f=u.pts-this._dtsBase)-h),void 0!==u.cts&&(f=u.cts+h,c=u.cts);var p,y={buffer:[],size:0};p=u.duration?u.duration:i.length>=1?i[0].dts-this.videoDtsBase-h:a.length>=1?a[a.length-1].duration:this.videoMeta.refSampleDuration,this.videoAllDuration+=p,ze.long&&ze.log(this.TAG,"video dts "+h,"pts "+f,"cts: "+c,l,"originDts "+u.originDts,"duration "+p),p>=0&&(s.samples.push(y),y.buffer.push(u.data),y.size+=u.data.byteLength,a.push({dts:h,cts:Math.abs(c)>2e3?p:c,pts:f,data:u.data,size:u.data.byteLength,isKeyframe:l,duration:p,flags:{isLeading:0,dependsOn:l?2:1,isDependedOn:l?1:0,hasRedundancy:0,isNonSync:l?0:1},originDts:h,type:"video"})),l&&this.emit($t.RANDOM_ACCESS_POINT,f)}a.length&&ze.log(this.TAG,"remux to mp4 video:",[r/1e3,a[a.length-1].dts/1e3]);var v=new qt;if(a.length){var _=Zt.moof({id:t.meta.id,time:r,samples:a}),m=Zt.mdat(s);v.write(_,m),this.writeToSource("video",v,a[a.length-1].pts-a[0].pts)}if(n&&(this.writeToSource("video",n),i.length))return t.samples=i,this._remuxVideo(t);this.isFirstVideo=!1,this.emit($t.MEDIA_SEGMENT,"video"),t.samples=[],t.length=0}}},{key:"_remuxAudio",value:function(e){var t=(e||{}).samples,i=-1,r=[],n=null,a={samples:[]};if(t&&t.length){for(var s=1e4,o=!1;t.length&&s-- >0;){var u=t.shift(),l=u.data,d=u.options;if(!this.isFirstAudio&&d&&d.meta){n=this.remuxInitSegment("audio",d.meta),d.meta=null,t.unshift(u),d.isContinue||(this._audioDtsBase=0);break}var h=Math.max(0,u.dts-this.audioDtsBase),c=u.originDts;o||(i=h,o=!0);var f;f=u.duration?u.duration:this.audioMeta.refSampleDurationFixed?this.audioMeta.refSampleDurationFixed:t.length>=1?t[0].dts-this.audioDtsBase-h:r.length>=1?r[r.length-1].duration:this.audioMeta.refSampleDuration,ze.long&&ze.log(this.TAG,"audio dts "+h,"pts "+h,"originDts "+c,"duration "+f),this.audioAllDuration+=f;var p={dts:h,pts:h,cts:0,size:l.byteLength,duration:u.duration?u.duration:f,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:c,type:"audio"},y={buffer:[],size:0};f>=0&&(y.buffer.push(l),y.size+=l.byteLength,a.samples.push(y),r.push(p))}var v=new qt;if(r.length){ze.log(this.TAG,"remux to mp4 audio:",[i/1e3,r[r.length-1].dts/1e3]);var _=Zt.moof({id:e.meta.id,time:i,samples:r}),m=Zt.mdat(a);v.write(_,m),this.writeToSource("audio",v,r[r.length-1].dts-r[0].dts)}if(n&&(this.writeToSource("audio",n),t.length))return e.samples=t,this._remuxAudio(e);this.isFirstAudio=!1,this.emit($t.MEDIA_SEGMENT,"audio",v),e.samples=[],e.length=0}}},{key:"writeToSource",value:function(e,t,i){var r=this._context.getInstance("PRE_SOURCE_BUFFER"),n=r.getSource(e);n||(n=r.createSource(e)),n.data.push(t),i&&(n.bufferDuration=i+(n.bufferDuration||0))}},{key:"initSilentAudio",value:function(t,i){var r=e.getSilentFrame(this._audioMeta.channelCount);return{dts:t,pts:t,cts:0,duration:i,unit:r,size:r.byteLength,originDts:t,type:"video"}}},{key:"destroy",value:function(){this._player=null}},{key:"videoMeta",get:function(){return this._context.getInstance("TRACKS").videoTrack.meta}},{key:"audioMeta",get:function(){return this._context.getInstance("TRACKS").audioTrack.meta}},{key:"videoDtsBase",get:function(){return null!==this._videoDtsBase?this._videoDtsBase:this._dtsBase}},{key:"audioDtsBase",get:function(){return null!==this._audioDtsBase?this._audioDtsBase:this._dtsBase}}],[{key:"getSilentFrame",value:function(e){return 1===e?new Uint8Array([0,200,0,128,35,128]):2===e?new Uint8Array([33,0,73,144,2,25,0,35,128]):3===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]):4===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]):5===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]):6===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]):null}}]),e}(),ri=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ni=Xe.LOADER_EVENTS,ai=Xe.REMUX_EVENTS,si=Xe.DEMUX_EVENTS,oi=Xe.CRYTO_EVENTS,ui=Xe.MSE_EVENTS,li=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.TAG="HlsVodController",this.configs=Object.assign({},t),this.url="",this.baseurl="",this.sequence=0,this._playlist=null,this.retrytimes=this.configs.retrytimes||3,this.container=this.configs.container,this.preloadTime=this.configs.preloadTime||5,this.mse=this.configs.mse,this._lastSeekTime=0,this._player=this.configs.player,this.m3u8Text=null}return ri(e,[{key:"init",value:function(){this._context.registry("M3U8_BUFFER",ce),this._tsBuffer=this._context.registry("TS_BUFFER",ce)(),this._tracks=this._context.registry("TRACKS",he)(),this._playlist=this._context.registry("PLAYLIST",ue)({autoclear:!0}),this._presource=this._context.registry("PRE_SOURCE_BUFFER",le)(),this._compat=this._context.registry("COMPATIBILITY",xt)(),this._context.registry("M3U8_LOADER",We)({buffer:"M3U8_BUFFER",readtype:1}),this._tsloader=this._context.registry("TS_LOADER",We)({buffer:"TS_BUFFER",readtype:3}),this._demuxer=this._context.registry("TS_DEMUXER",ei)({inputbuffer:"TS_BUFFER"}),this._context.registry("MP4_REMUXER",ii)(this._player.currentTime),this.mse||(this.mse=new Ve({container:this.container,preloadTime:this.preloadTime},this._context),this.mse.init()),this.initEvents()}},{key:"initEvents",value:function(){this.on(ni.LOADER_COMPLETE,this._onLoaderCompete.bind(this)),this.on(ni.LOADER_ERROR,this._onLoadError.bind(this)),this.on(ai.INIT_SEGMENT,this._onInitSegment.bind(this)),this.on(si.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(ai.MEDIA_SEGMENT,this._onMediaSegment.bind(this)),this.on(si.METADATA_PARSED,this._onMetadataParsed.bind(this)),this.on(si.DEMUX_COMPLETE,this._onDemuxComplete.bind(this)),this.on(si.DEMUX_ERROR,this._onDemuxError.bind(this)),this.on(ai.REMUX_ERROR,this._onRemuxError.bind(this)),this.on(ui.MSE_ERROR,this._handleMseError.bind(this)),this.on(ui.SOURCE_UPDATE_END,this._onUpdateEnd.bind(this)),this.on("TIME_UPDATE",this._onTimeUpdate.bind(this)),this.on(ui.SOURCE_UPDATE_END,this._onTimeUpdate.bind(this)),this.on("WAITING",this._onWaiting.bind(this))}},{key:"_onError",value:function(e,t,i,r){var n={errorType:e,errorDetails:"["+t+"]: "+(i?i.message:""),errorFatal:r};this._player&&this._player.emit("HLS_ERROR",n)}},{key:"_onLoadError",value:function(e,t){this._player.emit("error",{errorType:"network",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(ni.LOADER_ERROR,e,t,!0)}},{key:"_onDemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{errorType:"parse",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(ni.LOADER_ERROR,e,t,i)}},{key:"_onRemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{errorType:"parse",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(ai.REMUX_ERROR,e,t,i)}},{key:"_handleMseError",value:function(e,t,i){void 0===i&&(i=!1),this._player.emit("error",{errorType:"parse",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(ui.MSE_ERROR,e,t,i)}},{key:"_onWaiting",value:function(e){var t=!0;ze.log(this.TAG,"waiting.......",this._player.video.currentTime),this._seekToBufferStart();var i=Object.keys(this._playlist.list),r=i.length;if(r){for(var n=0;n<r;n++)1e3*this.container.currentTime<parseInt(i[n])&&(t=!1);if(t){var a=this._playlist.getTs(1e3*this.container.currentTime);a?a.downloaded&&(this._player.emit("ended"),this.mse.endOfStream()):(this._player.emit("ended"),this.mse.endOfStream())}}}},{key:"_seekToBufferStart",value:function(){var e=this._player.video,t=e.buffered,i=[0,0],r=e.currentTime;if(t)for(var n=0,a=t.length;n<a;n++)if(i[0]=t.start(n),i[1]=t.end(n),i[0]<=r&&r<=i[1])return;var s=i[0];0===r&&r<s&&Math.abs(r-s)<5&&(e.currentTime=s)}},{key:"_checkEnd",value:function(){var e=this._player.video,t=e.buffered,i=t.length;if(i){var r=t.end(i-1);Math.abs(r-e.duration)<1&&this.mse.endOfStream()}}},{key:"_onUpdateEnd",value:function(){this._checkEnd(),this._seekToBufferStart(),this._preload(this._player.currentTime)}},{key:"_onTimeUpdate",value:function(){this._seekToBufferStart(),this._preload(this._player.currentTime)}},{key:"_onDemuxComplete",value:function(){this.emit(ai.REMUX_MEDIA,"ts")}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_onMetadataParsed",value:function(e){ze.warn(this.TAG,"meta detect or changed , ",e);var t=parseInt(this._playlist.duration);"video"===e?(this._context.mediaInfo.hasVideo=!0,this._tracks.videoTrack.meta.duration=t):"audio"===e&&(this._context.mediaInfo.hasAudio=!0,this._tracks.audioTrack.meta.duration=t),this.emit(ai.REMUX_METADATA,e)}},{key:"_onMediaSegment",value:function(){Object.keys(this.mse.sourceBuffers).length<1&&this.mse.addSourceBuffers(),this.mse.doAppend()}},{key:"_onInitSegment",value:function(){this.mse.addSourceBuffers()}},{key:"_onLoaderCompete",value:function(e){if("M3U8_BUFFER"===e.TAG){this.m3u8Text=e.shift();try{var t=ti.parse(this.m3u8Text,this.baseurl);this._playlist.pushM3U8(t)}catch(e){this._onError("M3U8_PARSER_ERROR","PLAYLIST",e,!0)}if(this._playlist.encrypt&&this._playlist.encrypt.uri&&!this._playlist.encrypt.key)this._context.registry("DECRYPT_BUFFER",ce)(),this._context.registry("KEY_BUFFER",ce)(),this._tsloader.buffer="DECRYPT_BUFFER",this._keyLoader=this._context.registry("KEY_LOADER",We)({buffer:"KEY_BUFFER",readtype:3}),this.emitTo("KEY_LOADER",ni.LADER_START,this._playlist.encrypt.uri);else{this.preloadTime||(this._playlist.targetduration?(this.preloadTime=this._playlist.targetduration,this.mse.preloadTime=this._playlist.targetduration):(this.preloadTime=5,this.mse.preloadTime=5));var i=this._playlist.getTs(1e3*(this._player.currentTime+.5));i?(this._logDownSegment(i),this._playlist.downloading(i.url,!0),this.emitTo("TS_LOADER",ni.LADER_START,i.url)):this.retrytimes>0&&(this.retrytimes--,this.emitTo("M3U8_LOADER",ni.LADER_START,this.url))}}else if("TS_BUFFER"===e.TAG)this._playlist.downloaded(this._tsloader.url,!0),this._demuxer.demux(Object.assign({url:this._tsloader.url},this._playlist._ts[this._tsloader.url])),this._preload(this.mse.container.currentTime);else if("DECRYPT_BUFFER"===e.TAG)this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emitTo("CRYPTO",oi.START_DECRYPT,Object.assign({url:this._tsloader.url},this._playlist._ts[this._tsloader.url]));else if("KEY_BUFFER"===e.TAG){this.retrytimes=this.configs.retrytimes||3,this._playlist.encrypt.key=e.shift(),this._crypto=this._context.registry("CRYPTO",je)({key:this._playlist.encrypt.key,iv:this._playlist.encrypt.ivb,method:this._playlist.encrypt.method,inputbuffer:"DECRYPT_BUFFER",outputbuffer:"TS_BUFFER"}),this._crypto.on(oi.DECRYPTED,this._onDcripted.bind(this));var r=this._playlist.getTs();r?(this._playlist.downloading(r.url,!0),this.emitTo("TS_LOADER",ni.LADER_START,r.url)):this.retrytimes>0&&(this.retrytimes--,this.emitTo("M3U8_LOADER",ni.LADER_START,this.url))}}},{key:"_onDcripted",value:function(){this.emit(si.DEMUX_START)}},{key:"seek",value:function(e){for(var t=this._player.video,i=0;i<t.buffered.length;i++)if(e>=t.buffered.start(i)&&e<t.buffered.end(i))return;ze.warn(this.TAG,"seek: ",e,"tsloading:",this._tsloader.loading);var r=this._playlist.getTs(1e3*(e+.5));r&&this._tsloader.loading&&this._tsloader.url===r.url||(this._lastSeekTime=e,this._tsloader.destroy(),this._tsloader=this._context.registry("TS_LOADER",We)({buffer:"TS_BUFFER",readtype:3}),this._presource.sources.video&&(this._presource.sources.video.data=[]),this._presource.sources.audio&&(this._presource.sources.audio.data=[]),this._tracks.audioTrack&&(this._tracks.audioTrack.samples=[]),this._tracks.videoTrack&&(this._tracks.videoTrack.samples=[]),this._compat&&this._compat.reset(),this._tsBuffer&&(this._tsBuffer.array=[],this._tsBuffer.length=0,this._tsBuffer.offset=0),this._playlist.clearDownloaded(),this._context.seek(e),this._preload(e))}},{key:"replay",value:function(){this._compat.reset(),this._playlist.clearDownloaded()}},{key:"load",value:function(e){this.baseurl=ti.parseURL(e),this.url=e,this.emitTo("M3U8_LOADER",ni.LADER_START,e)}},{key:"_preload",value:function(e){if(e=Math.floor(e),!this._tsloader.loading){ze.log(this.TAG,"preload: time=",e);var t=this.mse.container,i=-1;!e&&t.buffered.length&&(e=t.buffered.start(0));for(var r=0;r<t.buffered.length;r++)e>=Math.floor(t.buffered.start(r))&&e<=Math.ceil(t.buffered.end(r))&&(i=t.buffered.end(r));if(i<0){var n=this._playlist.getTs(1e3*(e+.5));n&&n.downloaded&&(n=this._playlist.getTs(n.time+n.duration)),!n||n.downloading||n.downloaded||(this._logDownSegment(n),this._playlist.downloading(n.url,!0),this.emitTo("TS_LOADER",ni.LADER_START,n.url))}else if(i<e+this.preloadTime){var a=this._playlist.getLastDownloadedTs()||this._playlist.getTs(1e3*i);if(!a)return;var s=a.time+a.duration,o=a.time;if(a.downloaded)for(var u=1e3;u-- >0&&(s+=10,(a=this._playlist.getTs(s))&&!(a.time>o)););!a||a.downloading||a.downloaded||(this._logDownSegment(a),this._playlist.downloading(a.url,!0),this.emitTo("TS_LOADER",ni.LADER_START,a.url))}}}},{key:"cleanBuffer",value:function(){var e=this,t=this._player.currentTime,i=this._player.video,r=i.buffered;if(r&&r.length){var n=[0,0],a=i.currentTime;if(r)for(var s=0,o=r.length;s<o&&(n[0]=r.start(s),n[1]=r.end(s),!(n[0]<=a&&a<=n[1]));s++);var u=n[0],l=n[1];(t-u>10||r.length>1)&&(this.mse.remove(Math.max(Math.min(t-10,l-10),.1),0),this.bufferClearTimer=setTimeout((function(){e.bufferClearTimer=null}),5e3))}}},{key:"destory",value:function(){this.configs={},this.url="",this.baseurl="",this.sequence=0,this._playlist=null,this.retrytimes=3,this.container=void 0,this.preloadTime=5,this._lastSeekTime=0,this.m3u8Text=null,this.mse=null,this.off(ni.LOADER_COMPLETE,this._onLoaderCompete),this.off(ai.INIT_SEGMENT,this._onInitSegment),this.off(ai.MEDIA_SEGMENT,this._onMediaSegment),this.off(si.METADATA_PARSED,this._onMetadataParsed),this.off(si.DEMUX_COMPLETE,this._onDemuxComplete),this.off("TIME_UPDATE",this._onTimeUpdate),this.off("WAITING",this._onWaiting)}},{key:"_logDownSegment",value:function(e){e&&(ze.groupEnd(),ze.group(this.TAG,"load "+e.id+": ["+e.time/1e3+" , "+(e.time+e.duration)/1e3+"], downloading: "+e.downloading+" , donwloaded: "+e.downloaded))}}]),e}(),di=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),hi=function e(t,i,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,r)}if("value"in n)return n.value;var s=n.get;return void 0!==s?s.call(r):void 0},ci=Fe.debounce,fi=Xe.HlsAllowedEvents,pi=Xe.REMUX_EVENTS,yi=Xe.HLS_EVENTS,vi=Xe.MSE_EVENTS;return function(t){function i(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":s(t))&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t));return r.hlsOps={},r.util=e.util,r.util.deepCopy(r.hlsOps,t),r._handleSetCurrentTime=ci(r._handleSetCurrentTime.bind(r),200),r.onWaiting=r.onWaiting.bind(r),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":s(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,t),di(i,[{key:"_handleSetCurrentTime",value:function(e){(e=parseFloat(e))!==this.currentTime&&(function e(t,i,r,n){var a=Object.getOwnPropertyDescriptor(t,i);if(void 0===a){var s=Object.getPrototypeOf(t);null!==s&&e(s,i,r,n)}else if("value"in a&&a.writable)a.value=r;else{var o=a.set;void 0!==o&&o.call(n,r)}return r}(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"currentTime",e,this),this._context&&this.__core__.seek(e))}},{key:"play",value:function(){var e=this;return this.video.play().catch((function(t){t&&20===t.code&&e.once("canplay",(function(){e.video.play()}))}))}},{key:"replay",value:function(){var e=this;this.__core__.mse.cleanBuffers().then((function(){e.__core__.replay(),hi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"replay",e).call(e)}))}},{key:"_initEvents",value:function(){var t=this;this.__core__.once(pi.INIT_SEGMENT,(function(){var e=t.__core__.mse;hi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",t).call(t,e.url)})),this.__core__.once(yi.RETRY_TIME_EXCEEDED,(function(){t.emit("error",new e.Errors("network",t.config.url))})),this.__core__.on(vi.SOURCE_UPDATE_END,(function(){t._onSourceUpdateEnd()})),this.once("canplay",(function(){t.config.autoplay&&t.play()}))}},{key:"initHlsBackupEvents",value:function(e,t){var r=this;e.once(pi.INIT_SEGMENT,(function(){if(!r.video.src){console.log("挂载 src blob");var t=e.mse;hi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",r).call(r,t.url)}})),e.once(Xe.REMUX_EVENTS.MEDIA_SEGMENT,(function(){r.__core__=e,r.__core__.mse.cleanBuffers().then((function(){r.__core__.mse.resetContext(t),r.__core__.mse.doAppend(),r._context.destroy(),r._context=t}))})),e.once(Xe.LOADER_EVENTS.LOADER_ERROR,(function(){t.destroy()}))}},{key:"_onSourceUpdateEnd",value:function(){if(1===this.video.readyState||2===this.video.readyState){var e=this.detectBufferGap(),t=e.gap,i=e.start,r=e.method;t&&("ceil"===r&&this.currentTime<Math[r](i)||"floor"===r&&this.currentTime>Math[r](i))&&(this.currentTime=Math[r](i))}}},{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.config.url;e&&!this.started&&(this._context||(this._context=new Ne(fi)),this.__core__=this._context.registry("HLS_VOD_CONTROLLER",li)({player:this,container:this.video,preloadTime:this.config.preloadTime}),this._context.init(),this.__core__.load(e),this._initEvents(),this.started=!0)}},{key:"swithURL",value:function(e){this.config.url=e;var t=new Ne(fi),i=t.registry("HLS_VOD_CONTROLLER",li)({player:this,container:this.video,mse:this.__core__.mse,preloadTime:this.config.preloadTime});t.init(),this.initHlsBackupEvents(i,t),this.__core__.mse.cleanBuffers().then((function(){i.load(e)}))}},{key:"destroy",value:function(){var e=this;return new Promise((function(t){e.__core__&&e.__core__.mse?(e.__core__.mse.destroy().then((function(){e._context&&e._context.destroy(),hi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",e).call(e),t()})),setTimeout((function(){t()}),100)):(hi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",e).call(e),setTimeout((function(){t()}),50))}))}},{key:"detectBufferGap",value:function(){for(var e=this.video,t={gap:!1,start:-1},i=0===this.currentTime,r=0;r<e.buffered.length;r++){var n=e.buffered.start(r),a=e.buffered.end(r);if((!e.played.length||n<=this.currentTime&&a-this.currentTime>=.5)&&!i)break;var s=n-this.currentTime,o=this.currentTime-a;if(s>.01&&(s<=2||i)){t={gap:!0,start:n,method:"ceil"};break}t=o>.1&&(o<=2||i)?{gap:!0,start:a,method:"floor"}:{gap:!1,start:-1}}return t}},{key:"currentTime",get:function(){return hi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"currentTime",this)},set:function(e){this._handleSetCurrentTime(e)}},{key:"src",get:function(){return this.currentSrc},set:function(e){var t=this;this.onWaiting=this.onWaiting.bind(this),this.__core__.mse.destroy().then((function(){t._context.destroy(),t._context=null,t.video.src="",t.video.load(),t.started=!1,t.video.currentTime=0,t.paused?t.play():(t.pause(),t.once("canplay",(function(){t.play()}))),t.start(e)}))}}],[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"install",value:function(t,i){return e.install(t,i)}}]),i}(e)}))}])}));